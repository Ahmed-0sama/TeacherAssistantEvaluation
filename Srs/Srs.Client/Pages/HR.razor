@page "/hr"
@using Microsoft.AspNetCore.Components
@using Shared.Dtos.EvaluationPeriod
@using Shared.Dtos.HODEvaluation
@using Shared.Dtos.Hr
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly
<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>
@if (isLoading)
{
    <div class="loading-container">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="mt-2 fw-bold">جاري تحميل البيانات...</div>
        </div>
    </div>
}
else{
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
        <div class="d-flex align-items-center">
            <button class="btn btn-link text-decoration-none">
                <i class="bi bi-list"></i>
            </button>
        </div>
        <h2 class="text-primary fw-bold m-0">نظام تقييم مساعدي التدريس</h2>
    </div>

    <!-- Main Content -->
    <div class="py-4">
        <h3 class="text-center mb-3">لوحة تحكم الموارد البشرية</h3>
        <p class="text-center text-muted mb-4">
            عرض وإدارة التقييمات الوظائفية. يمكن من هنا مراقبة حالة التقييمات، تصفيرها، طباعة تقارير، وإدراج أي تقييم للمراجعة في حال وجود خطأ.
        </p>

        <!-- Statistics Cards -->
        <div class="row g-3 mb-4">
            <div class="col">
                <div class="card border-success border-2 border-end-0 border-top-0 border-bottom-0 h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">معتمد</h6>
                        <h2 class="fw-bold">@evstat.accepted</h2>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card border-warning border-2 border-end-0 border-top-0 border-bottom-0 h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">بانتظار العميد</h6>
                        <h2 class="fw-bold">@evstat.DeanPending</h2>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card border-warning border-2 border-end-0 border-top-0 border-bottom-0 h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">بانتظار رئيس القسم</h6>
                        <h2 class="fw-bold">@evstat.HodPending</h2>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card border-info border-2 border-end-0 border-top-0 border-bottom-0 h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">بانتظار المحدثات</h6>
                        <h2 class="fw-bold">@evstat.TAPending</h2>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card border-primary border-2 border-end-0 border-top-0 border-bottom-0 h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">إجمالي التقييمات</h6>
                        <h2 class="fw-bold text-primary">@evstat.TotalEvaluations</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center gap-2 mb-3">
            <button class="btn btn-primary" @onclick="PrintReport">
                <i class="bi bi-printer"></i> طباعة التقرير
            </button>

            <input type="text"
                   class="form-control w-50 no-print"
                   placeholder="بحث بالاسم أو الرقم الوظيفي أو الحالة..."
                   @bind="SearchTerm"
                   @bind:event="oninput" />

        </div>

        <!-- Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive" dir="rtl">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>اسم مساعد التدريس</th>
                                <th>القسم</th>
                                <th>فترة التقييم</th>
                                <th>التقدير العام</th>
                                <th>الحالة</th>
                                <th class="no-print">إجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var evaluation in FilteredTAList)
                            {
                                <tr>
                                    <td>@evaluation.employeeName</td>
                                    <td>@evaluation.Department</td>
                                    <td>@(evaluationPeriodDisplay)</td>
                                    <td>
                                        @if (evaluation.TotalScore > 0)
                                        {
                                            <span class="badge @GetGradeBadgeClass(evaluation.TotalScore)">
                                                @GetGradeText(evaluation.TotalScore)
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">لم يتم التقييم</span>
                                        }
                                    </td>
                                    <td>
                                            <span class="badge @GetStatusBadgeClass(evaluation.statusid)">
                                                @GetCurrentState(evaluation.statusid)
                                        </span>
                                    </td>
                                    <td class="no-print">
                                        @if (evaluation.statusid == 6 || evaluation.statusid == 5)
                                        {
                                            <button class="btn btn-sm btn-primary ms-2"
                                                    @onclick="() => OpenModal(evaluation)">
                                                عرض التقرير
                                            </button>
                                        }
                                        else if (evaluation.statusid == 0||evaluation.statusid==1)
                                        {
                                            <button class="btn btn-sm btn-secondary" disabled>
                                                بانتظار إنشاء التقييم
                                            </button>
                                            <Srs.Client.Compontets.ReminderComponent Name="@evaluation.employeeName"
                                                                                 EmployeeId="HR_DEPARTMENT_ID"
                                                                                 RecieverId="@evaluation.employeeId"
                                                                                 RenderAsButton="true" />
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-secondary" disabled>
                                                بانتظار الاستكمال
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
}
@if (showHodModal && selectedTA != null)
{
    <Srs.Client.Compontets.HODComponent SelectedTA="@selectedTA"
                                        EvaluationPeriodId="@EvaluationPeriodId"
                                        IsViewMode="true"
                                        OnClose="@CloseModal"/>
}

@code {
    private int EvaluationPeriodId;
    private string errorMessage = string.Empty;
    private List<UserDataDto> taList = new();
    private UserDataDto? selectedTA;
    private bool showHodModal = false;
    private EvaluationStatisticsDto evstat = new();
    private bool isLoading = false;
    private string SearchTerm { get; set; } = string.Empty;
    private const int HR_DEPARTMENT_ID = 5379;
    private string evaluationPeriodDisplay{ get; set; }
    private List<UserDataDto> FilteredTAList
    {
        get
        {
            if (string.IsNullOrWhiteSpace(SearchTerm))
            {
                return taList;
            }

            var searchLower = SearchTerm.ToLower().Trim();

            return taList.Where(ta =>
                (ta.employeeName?.ToLower().Contains(searchLower) ?? false) ||
                (ta.EmployeeNumber.ToString().Contains(searchLower)) ||
                (ta.Department?.ToLower().Contains(searchLower) ?? false) ||
                (GetGradeBadgeClass(ta.statusid).ToLower().Contains(searchLower))
            ).ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            await GetEvaluationPeriod();
            await GetEvaluationStatistics();
            await LoadTAList();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenModal(UserDataDto ta)
    {
        if (ta.EvaluationId == 0 || ta.statusid < 5)
        {
            JS.InvokeVoidAsync("alert", "لا يوجد تقييم متاح للعرض");
            return;
        }

        Console.WriteLine($"Opening modal for: {ta.employeeName}, EvaluationId: {ta.EvaluationId}");
        selectedTA = ta;
        showHodModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showHodModal = false;
        selectedTA = null;
        StateHasChanged();
    }

    private async Task GetEvaluationPeriod()
    {
        try
        {
            var response = await Http.GetAsync($"api/EvaluationPeriod/GetActiveEvaluationPeriod");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GetEvaluationPeriodDto>();
                EvaluationPeriodId = result.PeriodId;
                evaluationPeriodDisplay = $"{result.StartDate.ToString("yyyy-MM-dd")} إلى {result.EndDate.ToString("yyyy-MM-dd")}";

                Console.WriteLine($"✅ evaluationPeriod retrieved {EvaluationPeriodId}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"لا توجد فترة تقييم حاليا {ex.Message}";
            Console.WriteLine($"No Active EvaluationPeriod {ex.Message}");
        }
    }

    private async Task GetEvaluationStatistics()
    {
        try
        {
            if (EvaluationPeriodId == 0)
            {
                Console.WriteLine("⚠️ Cannot load statistics: No active evaluation period");
                return;
            }

            var startDate = "2025-01-01"; 

            var url = $"/api/Statistics/EvaluationStatistics?evaluationPeriod={EvaluationPeriodId}&hrDepartmentId={HR_DEPARTMENT_ID}&startDate={startDate}";

            Console.WriteLine($"📡 Calling: {url}");

            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<EvaluationStatisticsDto>();
                if (result != null)
                {
                    evstat = result;
                    Console.WriteLine($"✅ Evaluation statistics retrieved successfully.");
                    Console.WriteLine($"   - Total: {evstat.TotalEvaluations}");
                    Console.WriteLine($"   - TA Pending: {evstat.TAPending}");
                    Console.WriteLine($"   - HOD Pending: {evstat.HodPending}");
                    Console.WriteLine($"   - Dean Pending: {evstat.DeanPending}");
                    Console.WriteLine($"   - Accepted: {evstat.accepted}");
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Failed to load statistics: {error}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء جلب إحصائيات التقييم: {ex.Message}";
            Console.WriteLine($"Error fetching evaluation statistics: {ex.Message}");
        }
    }


    private async Task LoadTAList()
    {
        errorMessage = string.Empty;

        try
        {
            Console.WriteLine("📡 Loading HR page data...");

            if (EvaluationPeriodId == 0)
            {
                errorMessage = "لا توجد فترة تقييم نشطة حالياً";
                return;
            }

            var startDate = "2025-01-01"; 

            // ✅ Single API call to get ALL TAs with enriched data
            var url = $"/api/Statistics/GetAllTAsForHR?periodId={EvaluationPeriodId}&hrDepartmentId={HR_DEPARTMENT_ID}&startDate={startDate}";

            Console.WriteLine($"📡 Calling: {url}");

            var response = await Http.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                throw new Exception($"Failed to load TAs: {error}");
            }

            taList = await response.Content.ReadFromJsonAsync<List<UserDataDto>>()
                ?? new List<UserDataDto>();

            Console.WriteLine($"✅ Loaded {taList.Count} TAs for HR");

            if (!taList.Any())
            {
                errorMessage = "لا يوجد مساعدي تدريس";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء تحميل البيانات: {ex.Message}";
            Console.WriteLine($"❌ Error: {ex}");
        }
        finally
        {
            StateHasChanged();
        }
    }
    private string GetCurrentState(int statusId)
    {
        return statusId switch
        {
            0 => "بانتظار إنشاء التقييم",
            1 => "بانتظار الاستكمال",
            2 => "بانتظار موافقة رئيس القسم",
            3 => "بانتظار موافقة العميد",
            4 => "بانتظار المراجعة من الموارد البشرية",
            5 => "مراجعة الموارد البشرية",
            6 => "معتمد",
            _ => "حالة غير معروفة"
        };
    }
    private string GetStatusBadgeClass(int statusId)
    {
        return statusId switch
        {
            0 => "bg-secondary",
            1 => "bg-warning",
            2 => "bg-info",
            3 => "bg-primary",
            4 => "bg-warning",
            5 => "bg-danger",
            6 => "bg-success",
            _ => "bg-dark"
        };
    }
    private string GetGradeBadgeClass(decimal totalScore)
    {
        return totalScore switch
        {
            >= 90 => "bg-success",      // ممتاز
            >= 80 => "bg-primary",      // جيد جداً
            >= 70 => "bg-info",         // جيد
            >= 60 => "bg-warning",      // مقبول
            _ => "bg-danger"            // ضعيف
        };
    }

    private string GetGradeText(decimal totalScore)
    {
        return totalScore switch
        {
            >= 90 => "ممتاز",
            >= 80 => "جيد جداً",
            >= 70 => "جيد",
            >= 60 => "مقبول",
            _ => "لم يتم التقييم"
        };
    }
    private async Task PrintReport()
    {
        await JS.InvokeVoidAsync("window.print");
    }
}