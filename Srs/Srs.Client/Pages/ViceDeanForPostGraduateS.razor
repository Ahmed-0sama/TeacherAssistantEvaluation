@page "/GSDean"
@using Shared.Dtos
@using Shared.Dtos.EvaluationPeriod
@using Shared.Dtos.GSDean
@using Shared.Dtos.TASubmissions
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly
<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>

<h3 class="text-center mb-4">متابعة التقدم للدراسات العليا</h3>

<div class="card shadow-sm" dir="rtl">
    <div class="card-body">
        <h3 class="text-center" style="color:cornflowerblue;">قائمة مساعدي التدريس</h3>
        <hr style="color:cornflowerblue;" />

        <div class="d-flex justify-content-center">
            <div class="w-75 mb-4 shadow-sm">
                @if (isLoading)
                {
                    <p class="text-center">جارٍ تحميل البيانات...</p>
                }
                else if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger text-center">@errorMessage</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-striped text-center align-middle" dir="rtl">
                            <thead class="table-primary">
                                <tr>
                                    <th>اسم مساعد التدريس</th>
                                    <th>القسم</th>
                                    <th>الحالة</th>
                                    <th>إجراء</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ta in taList)
                                {
                                    <tr>
                                        <td>@ta.employeeName</td>
                                        <td>@ta.Department</td>
                                        <td>
                                            @if (ta.statusid == 2)
                                            {
                                                <span class="result-pill">تم التقييم</span>
                                            }
                                            else if (ta.statusid == 1)
                                            {
                                                <span class="result-pill" style="background-color: antiquewhite; color: black;">تقييم</span>
                                            }
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" @onclick="() => OpenModal(ta)">
                                                @(ta.statusid == 2? "عرض" : ta.statusid == 1 ? "تقييم" : "إجراء")
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
@if (ModalVisable)
{
    <div class="modal d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" dir="rtl">
                <div class="modal-header" dir="rtl">
                    <button type="button" class="btn-close ms-0 me-auto" @onclick="CloseModal"></button>
                    <h5 class="modal-title">بيانات التقدم في الماجيستير</h5>
                </div>
                <div class="modal-body">
                    @if (isLoadingModalData)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جارٍ التحميل...</span>
                            </div>
                            <p class="mt-2">جارٍ تحميل البيانات...</p>
                        </div>
                    }
                    else
                    {
                        <div class="border rounded p-3 bg-light mb-2">
                            <h5 class="mb-3 text-primary">البيانات الأساسية</h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">اسم مساعد التدريس</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.employeeName" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">الرقم الوظيفي:</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.EmployeeNumber" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">القسم</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.Department" />
                                </div>
                            </div>
                        </div>

                        <div class="border rounded p-3 bg-light mb-2">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">التخصص/البرنامج في الماجيستير</label>
                                    <input type="text" class="form-control" @bind="mastersDto.Major" readonly="@IsReadOnly" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">الساعات المجتازة</label>
                                    <input type="number" class="form-control" @bind="@mastersDto.HoursGained" readonly="@IsReadOnly" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">المعدل التراكمي</label>
                                    <input type="number" step="0.01" class="form-control" @bind="@mastersDto.Grade" readonly="@IsReadOnly" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">التاريخ المتوقع للإتمام</label>
                                    <input type="date" class="form-control"
                                           @bind="mastersDto.EstimatedGraduationDate"
                                           @bind:format="yyyy-MM-dd"
                                           readonly="@IsReadOnly" />
                                </div>
                            </div>

                            <div class="row">
                                <label class="form-label fw-bold mb-3">مؤشرات التقدم</label>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <input type="checkbox"
                                           class="form-check-input ms-2"
                                           @bind="mastersDto.ResearchPointsCompleted"
                                           disabled="@IsReadOnly" />
                                    <label class="form-check-label fw-bold">اختيار النقطة البحثية</label>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <input type="checkbox"
                                           class="form-check-input ms-2"
                                           @bind="mastersDto.SearchInResources"
                                           disabled="@IsReadOnly" />
                                    <label class="form-check-label fw-bold">البحث في المصادر</label>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <input type="checkbox"
                                           class="form-check-input ms-2"
                                           @bind="mastersDto.SearchPlanning"
                                           disabled="@IsReadOnly" />
                                    <label class="form-check-label fw-bold">وضع الخطة البحثية</label>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <input type="checkbox"
                                           class="form-check-input ms-2"
                                           @bind="mastersDto.CollectDataAndAnalyze"
                                           disabled="@IsReadOnly" />
                                    <label class="form-check-label fw-bold">جمع وتحليل البيانات</label>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <input type="checkbox"
                                           class="form-check-input ms-2"
                                           @bind="mastersDto.ResearchReportWriting"
                                           disabled="@IsReadOnly" />
                                    <label class="form-check-label fw-bold">كتابة البحث/الأبحاث</label>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <input type="checkbox"
                                           class="form-check-input ms-2"
                                           @bind="mastersDto.ScientificResearchReport"
                                           disabled="@IsReadOnly" />
                                    <label class="form-check-label fw-bold">كتابة الرسالة العلمية</label>
                                </div>
                            </div>
                        </div>

                        <div class="border rounded p-3 bg-light">
                            <div class="row">
                                <label class="form-label fw-bold mb-3">تقييم التقدم والملاحظات</label>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">درجة تقييم التقدم (من 5)</label>
                                    <input type="number"
                                           @bind="mastersDto.GradeGivenbySupervisor"
                                           class="form-control text-center fs-2 fw-bold"
                                           style="max-width: 100px;"
                                           min="0"
                                           max="5"
                                           step="1"
                                           onkeypress="return (event.charCode >= 48 && event.charCode <= 53) || event.charCode === 8"
                                           oninput="this.value = Math.floor(Math.abs(this.value)); if(this.value > 5) this.value = 5;" />
                                </div>

                                @if (IsReadOnly && mastersDto.GradeGivenbySupervisor.HasValue)
                                {
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">نسبة الإنجاز</label>
                                        <input type="text"
                                               class="form-control"
                                               value="@($"{mastersDto.GradeGivenbySupervisor:F2}%")"
                                               readonly />
                                    </div>

                                }
                            </div>
                        </div> 
                        
                    }
                </div>
                <div class="modal-footer">
                    @if (!IsReadOnly && !isLoadingModalData)
                    {
                        <div class="w-100 mb-3">
                            <label class="form-label fw-bold"> الملاحظات اضافية</label>
                            <textarea class="form-control"
                                      rows="3"
                                      @bind="mastersDto.Notes"
                                      placeholder="اضف ملاحظات حول تقدم الطلاب مثال مطابقتة للخطة او اي تحديات يواجهها"></textarea>
                        </div>
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">إغلاق</button>

                        <button type="button" class="btn btn-primary"
                                @onclick="() => SendData(mastersDto)"
                                disabled="@isSaving">
                            @(isSaving ? "جارٍ الحفظ..." : "اعتماد الدرجة")
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private bool isLoadingModalData = false;
    private bool isSaving = false;
	private int EvaluationPeriodId;
    private string? errorMessage;
    private List<UserDataDto> taList = new();
    private UserDataDto? selectedTA;
    private MastersDto mastersDto = new MastersDto();
    private bool ModalVisable = false;
    private bool IsReadOnly = false;
    private const int SUPERVISOR_ID = 9614; // Replace with actual logged-in supervisor ID

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await GetEvaluationPeriod();
            var evaluations = await Http.GetFromJsonAsync<List<GetEvaluationDto>>("/api/evaluation/period/1");
            await LoadGTAList();
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء تحميل البيانات: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    private async Task GetEvaluationPeriod()
    {
        try
        {
            var response = await Http.GetAsync($"api/EvaluationPeriod/GetActiveEvaluationPeriod");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GetEvaluationPeriodDto>();
                EvaluationPeriodId = result.PeriodId;
                Console.WriteLine($"✅ evaluationPeriod retrieved{EvaluationPeriodId}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"لا توجد فترة تقييم حاليا {ex.Message}";
            Console.WriteLine($"No Active EvaluationPeriod  {ex.Message}");
        }
    }
    private async Task LoadGTAList()
    {
        try
        {
            Console.WriteLine($"📡 Fetching GTA list for supervisor {SUPERVISOR_ID}");

            // ✅ Single API call to get enriched data
            var response = await Http.GetAsync(
                $"api/GSDean/GetGTAListWithEvaluations?supervisorId={SUPERVISOR_ID}&evaluationPeriodId={EvaluationPeriodId}&startDate=2025-01-01");

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                throw new Exception($"Failed to load GTA list: {error}");
            }

            taList = await response.Content.ReadFromJsonAsync<List<UserDataDto>>()
                ?? new List<UserDataDto>();

            Console.WriteLine($"✅ Loaded {taList.Count} GTAs with evaluation statuses");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading GTA list: {ex.Message}");
            errorMessage = $"خطأ في تحميل قائمة مساعدي التدريس: {ex.Message}";
        }
    }
    private async Task OpenModal(UserDataDto ta)
    {
        selectedTA = ta;
        selectedTA.employeeId = ta.employeeId;
        selectedTA.EmployeeNumber = ta.employeeId;
        ModalVisable = true;
        isLoadingModalData = true;

        // Determine if readonly based on status
        IsReadOnly = ta.statusid == 2;

        // Reset the DTO
        mastersDto = new MastersDto();

        try
        {
            // Try to fetch existing GSDean evaluation data
            var response = await Http.GetAsync($"/api/GSdean/GetByEvaluationForGSDeanPeriodAndTAAsync/{EvaluationPeriodId}/{ta.employeeId}");

            if (response.IsSuccessStatusCode)
            {
                var existingData = await response.Content.ReadFromJsonAsync<GsdeanEvaluationDto>();

                // If data exists, populate the form
                if (existingData != null)
                {
                    mastersDto = new MastersDto
                    {
                        Major = existingData.ProgramName,
                        HoursGained = existingData.CompletedHours,
                        Grade = existingData.Gpa,
                        EstimatedGraduationDate = existingData.ExpectedCompletionDate,
                        GradeGivenbySupervisor = existingData.ProgressScore ?? 0,
                        Status = existingData.EvaluationComments,
                        ResearchPointsCompleted = existingData.TopicChosen,
                        SearchInResources = existingData.LiteratureReview,
                        SearchPlanning = existingData.ResearchPlan,
                        CollectDataAndAnalyze = existingData.DataCollection,
                        ResearchReportWriting = existingData.Writing,
                        ScientificResearchReport = existingData.ThesisDefense,
                        Notes = existingData.EvaluationComments
                    };
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // No existing data - this is fine for new evaluations
                Console.WriteLine("No existing evaluation found - creating new");
            }
            else
            {
                Console.WriteLine($"Error fetching data: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading evaluation data: {ex.Message}");
        }
        finally
        {
            isLoadingModalData = false;
        }
    }

    private async Task SendData(MastersDto dto)
    {
        if (isSaving) return;

        isSaving = true;
        try
        {
            var createDto = new CreateGsdeanEvaluationDto
            {
                
                GsSupervisorId = 1, // Should get from logged in user context
                TaEmployeeId = selectedTA.employeeId,
                EvaluationPeriodId = EvaluationPeriodId,
                ProgramName = dto.Major,
                CompletedHours = dto.HoursGained,
                Gpa = dto.Grade,
                ProgressScore = dto.GradeGivenbySupervisor,
                ExpectedCompletionDate = dto.EstimatedGraduationDate,
                EvaluationComments = dto.Notes,
                TopicChosen = dto.ResearchPointsCompleted,
                LiteratureReview = dto.SearchInResources,
                ResearchPlan = dto.SearchPlanning,
                DataCollection = dto.CollectDataAndAnalyze,
                Writing = dto.ResearchReportWriting,
                ThesisDefense = dto.ScientificResearchReport

            };

            var response = await Http.PostAsJsonAsync("/api/GSdean/CreateEvaluation", createDto);

            if (!response.IsSuccessStatusCode)
            {
                var msg = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"خطأ في حفظ البيانات: {msg}");
                return;
            }

            await JS.InvokeVoidAsync("alert", "تم حفظ التقييم بنجاح!");
            CloseModal();

            // Refresh the list
            await OnInitializedAsync();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"خطأ: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void CloseModal()
    {
        ModalVisable = false;
        mastersDto = new MastersDto();
        selectedTA = null;
    }
}