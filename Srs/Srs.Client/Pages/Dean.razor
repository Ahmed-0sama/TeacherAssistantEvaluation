@page "/dean"
@using Shared.Dtos.ProfessorEvaluationDto
@using Shared.Dtos.TASubmissions
@using Shared.Dtos.DeanDto
@using System.Net.Http.Json

@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>

@if (!string.IsNullOrEmpty(ToastMessage))
{
    <div class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3" style="min-width: 300px;">
        <div class="alert @ToastClass alert-dismissible fade show shadow-sm mb-0" role="alert">
            @ToastMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
                    @onclick="() => ToastMessage = null"></button>
        </div>
    </div>
}

<h3 class="text-center mb-4">متابعة التقييمات - عميد الكلية</h3>

<div class="d-flex flex-column justify-content-center align-items-center vh-80">
    <div class="w-75 mb-4 shadow-sm p-4 bg-white" dir="rtl">
        <p class="text-muted text-center mb-4">
            تظهر في هذه القائمة التقييمات التي تم استكمالها واعتمادها من قبل رئيس القسم، وهي الآن جاهزة للمراجعة والاعتماد النهائي.
        </p>

        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <input type="text"
                       class="form-control"
                       placeholder="بحث بالاسم أو الرقم الوظيفي أو الحالة..."
                       @bind="SearchTerm"
                       @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <select class="form-select">
                    <option selected>فلترة حسب القسم</option>
                    <option>قسم علوم الحاسب</option>
                    <option>قسم نظم المعلومات</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select">
                    <option selected>فلترة حسب الفترة الزمنية</option>
                    <option>الفصل الدراسي الأول 2024</option>
                    <option>الفصل الدراسي الثاني 2024</option>
                </select>
            </div>
        </div>

        @if (IsLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">جارٍ تحميل البيانات...</span>
                </div>
                <p class="mt-3 text-muted">جارٍ تحميل البيانات...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(LoadError))
        {
            <div class="alert alert-danger text-center">
                @LoadError
            </div>
        }
        else if (!FilteredEvaluations.Any())
        {
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle me-2"></i>
                لا توجد تقييمات متاحة للعرض
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle">
                    <thead class="table-primary">
                        <tr>
                            <th>اسم مساعد التدريس</th>
                            <th>الرقم الوظيفي</th>
                            <th>القسم</th>
                            <th>الفترة</th>
                            <th>الحالة</th>
                            <th class="text-center">إجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var eval in FilteredEvaluations)
                        {
                            <tr>
                                <td>@($"TA #{eval.taEmployeeId}")</td>
                                <td>@eval.taEmployeeId</td>
                                <td>@(eval.statusName ?? "غير محدد")</td>
                                <td>@(eval.periodName ?? "غير محدد")</td>
                                <td>
                                    <span class="@GetStatusBadgeClass(eval.statusId)">
                                        @GetStatusDisplayName(eval.statusId)
                                    </span>
                                </td>
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-primary"
                                            @onclick="() => OpenModal(eval)">
                                        عرض التفاصيل
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@* ===== Modal for Dean Evaluation Detail ===== *@
@if (IsModalVisible && SelectedData is not null && !IsHodModalVisible)
{
    <div class="modal-overlay" @onclick="HideModal">
        <div class="modal-container modal-container-lg" @onclick:stopPropagation="true" dir="rtl">
            <div class="modal-header">
                <h5 class="m-0">تفاصيل التقييم - عميد الكلية</h5>
                <button type="button" class="btn-close btn-close-white" @onclick="HideModal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                @if (IsDetailLoading)
                {
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جارٍ تحميل التفاصيل...</span>
                        </div>
                        <p class="mt-3 text-muted">جارٍ تحميل التفاصيل...</p>
                    </div>
                }
                else if (!string.IsNullOrEmpty(DetailError))
                {
                    <div class="alert alert-danger text-center">
                        @DetailError
                    </div>
                }
                else
                {
                    <div class="info-section mb-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>اسم المساعد:</strong> @SelectedData.TaName</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>الرقم الوظيفي:</strong> @SelectedData.TaEmployeeId</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <strong>القسم:</strong>
                                    @SelectedData.TaEmail
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>الفترة:</strong> @SelectedData.PeriodName</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <strong>الحالة الحالية:</strong>
                                    <span class="@GetStatusBadgeClass(SelectedData.StatusName)">
                                        @SelectedData.StatusName
                                    </span>
                                </p>
                            </div>
                            @if (!string.IsNullOrEmpty(SelectedData.FinalGrade))
                            {
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>التقدير النهائي:</strong>
                                        <span class="@GetGradeBadgeClass(SelectedData.FinalGrade)">
                                            @SelectedData.FinalGrade
                                        </span>
                                    </p>
                                </div>
                            }
                </div>
            </div>

            <hr />

            <div class="mb-3">
                <h6 class="fw-bold mb-2">ملخص التقييم</h6>
                <p class="text-muted">
                    @(!string.IsNullOrEmpty(SelectedData.FinalGrade)
                                        ? SelectedData.FinalGrade
                                        : "ملخص التقييم من رئيس القسم وأعضاء اللجان يظهر هنا إن كان متوفراً.")
                        </p>
                    </div>

            @if (!string.IsNullOrWhiteSpace(SelectedData.DeanReturnComment))
                    {
                        <div class="mb-3">
                            <h6 class="fw-bold mb-2">ملاحظات عميد الكلية</h6>
                            <div class="alert alert-secondary">
                                @SelectedData.DeanReturnComment
                            </div>
                        </div>
                    }

                    <hr />

                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">ملخص الدرجات</h6>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">النشاط التعليمي (50%)</span>
                                            <span class="fw-bold text-primary">@(SelectedData.EducationalActivityScore) / 50</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">النشاط العلمي (10%)</span>
                                            <span class="fw-bold text-primary">@(SelectedData.ScientificActivityScore) / 10</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">النشاط الإداري (10%)</span>
                                            <span class="fw-bold text-primary">@(SelectedData.AdministrativeActivityScore) / 10</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">الأنشطة الطلابية (10%)</span>
                                            <span class="fw-bold text-primary">@(SelectedData.StudentActivitiesScore) / 10</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">استقصاء الطلاب (5%)</span>
                                            <span class="fw-bold text-primary">@(SelectedData.StudentSurveyScore) / 5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">الإرشاد الأكاديمي (5%)</span>
                                            <span class="fw-bold text-primary"> @(SelectedData.AcademicAdvisingScore)/ 5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">السمات الشخصية (10%)</span>
                                            <span class="fw-bold text-primary">@(SelectedData.PersonalTraitsScore)/ 10</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card border-success bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-bold">المجموع الكلي</span>
                                            <span class="fw-bold text-success fs-5">91.5 / 100</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6 class="fw-bold mb-2">ملاحظات رئيس القسم</h6>
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong class="text-success">نقاط القوة:</strong>
                                    <p class="mb-0 mt-1">@SelectedData.HodStrengths</p>
                                </div>
                                <div>
                                    <strong class="text-warning">نقاط تحتاج للتطوير:</strong>
                                    <p class="mb-0 mt-1">@SelectedData.HodWeaknesses</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="alert alert-info">
                            <strong>حالة الاعتماد:</strong> @SelectedData.StatusName
                        </div>
                    </div>

                }
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary px-4" @onclick="HideModal">
                    <i class="bi bi-x-circle me-2"></i>إغلاق
                </button>

                <button type="button"
                        class="btn btn-outline-primary px-4"
                        @onclick="PrintDeanModal"
                        disabled="@IsDetailLoading">
                    <i class="bi bi-printer me-2"></i>طباعة تقرير العميد
                </button>

                <button type="button"
                        class="btn btn-primary px-4"
                        @onclick="ShowDetailsModal"
                        disabled="@IsDetailLoading">
                    <i class="bi bi-eye me-2"></i>عرض تقييم رئيس القسم
                </button>

                @if (IsPendingApproval())
                {
                    <button type="button"
                            class="btn btn-danger px-4"
                            @onclick="ReturnEvaluation"
                            disabled="@(!Permissions.CanReturnFinalReport || IsReturning || IsDetailLoading)">
                        @if (IsReturning)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>جارٍ الإرجاع...</span>
                        }
                        else
                        {
                            <i class="bi bi-x-circle me-2"></i>
                            <span>إرجاع / رفض</span>
                        }
                    </button>

                    <button type="button"
                            class="btn btn-success px-4"
                            @onclick="ApproveEvaluation"
                            disabled="@(!Permissions.CanApproveFinalReport || IsApproving || IsDetailLoading)">
                        @if (IsApproving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>جارٍ الاعتماد...</span>
                        }
                        else
                        {
                            <i class="bi bi-check-circle me-2"></i>
                            <span>اعتماد نهائي</span>
                        }
                    </button>
                }
            </div>
        </div>
    </div>
}

@* ===== HOD Component Modal (Full Screen) ===== *@
@if (IsHodModalVisible && SelectedData != null)
{
    <Srs.Client.Compontets.HODComponent SelectedTA="@userData"
                                        EvaluationPeriodId="@EvaluationPeriodId"
                                        IsViewMode="@isViewMode"
                                        OnClose="@HideHodModal"
                                        OnSaveSuccess="@HandleSaveSuccess" />
}

@code {
    private List<EvaluationApiResponseDto> Evaluations { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private string? LoadError { get; set; }
    private bool IsModalVisible { get; set; }
    private bool IsHodModalVisible { get; set; }
    private DeanEvaluationDetailDto? SelectedData { get; set; }
    private bool IsDetailLoading { get; set; }
    private string? DetailError { get; set; }
    private bool IsApproving { get; set; }
    private bool IsReturning { get; set; }
    private string SearchTerm { get; set; } = string.Empty;
    private string? ToastMessage { get; set; }
    private string ToastType { get; set; } = "success";
    private string ToastClass => ToastType == "success" ? "alert-success" : "alert-danger";
    private DeanPermissions Permissions { get; set; } = new();
    private CancellationTokenSource? _toastCancellationTokenSource;
    private UserDataDto userData = new UserDataDto();
    private int EvaluationPeriodId = 1;
    private bool isViewMode = true;

    private IEnumerable<EvaluationApiResponseDto> FilteredEvaluations =>
        string.IsNullOrWhiteSpace(SearchTerm)
   ? Evaluations
            : Evaluations.Where(e =>
 e.taEmployeeId.ToString().Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)
      || (e.statusName?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
             || (e.periodName?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false));

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("?? Dean page initializing...");
        await FetchEvaluationsAsync();
    }

    private async Task FetchEvaluationsAsync()
    {
        Console.WriteLine("?? Starting FetchEvaluationsAsync...");
        IsLoading = true;
        LoadError = null;
        StateHasChanged();

        try
        {
            var url = $"/api/evaluation/period/{EvaluationPeriodId}";
            Console.WriteLine($"?? Making API call to: {url}");
            var evaluations = await Http.GetFromJsonAsync<List<EvaluationApiResponseDto>>(url) ?? new List<EvaluationApiResponseDto>();
            Console.WriteLine($"? Received {evaluations.Count} evaluations");
            Evaluations = evaluations;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"? Exception in FetchEvaluationsAsync: {ex.Message}");
            LoadError = $"خطأ في تحميل البيانات: {ex.Message}";
            ShowToast(LoadError, "error");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async void ShowDetailsModal()
    {
        if (SelectedData is null || userData is null)
        {
            Console.WriteLine("? Cannot show HOD modal - SelectedData or userData is null");
            return;
        }

        Console.WriteLine($"?? Opening HOD modal for Evaluation ID: {userData.EvaluationId}");

        // Hide Dean modal when showing HOD modal for proper printing
        IsModalVisible = false;
        IsHodModalVisible = true;
        StateHasChanged();
    }

    private void HideHodModal()
    {
        Console.WriteLine("?? Closing HOD modal, reopening Dean modal");

        // Close HOD modal and reopen Dean modal
        IsHodModalVisible = false;
        IsModalVisible = true;
        StateHasChanged();
    }

    private async void OpenModal(EvaluationApiResponseDto eval)
    {
        Console.WriteLine($"?? Opening modal for evaluation: {eval.evaluationId}");
        SelectedData = null;
        DetailError = null;
        IsDetailLoading = true;
        IsModalVisible = true;
        IsHodModalVisible = false;

        StateHasChanged();

        try
        {
            var url = $"/api/Dean/evaluationDetail/{eval.evaluationId}";
            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                SelectedData = await response.Content.ReadFromJsonAsync<DeanEvaluationDetailDto>();
                UpdatePermissions();

                userData.Id = SelectedData.TaEmployeeId;
                userData.Name = $"TA #{SelectedData?.TaName}";
                userData.EmployeeNumber = SelectedData.TaEmployeeId;
                userData.Department = SelectedData.TaEmail;
                userData.EvaluationId = SelectedData.EvaluationId;
            }
            else
            {
                DetailError = "فشل تحميل تفاصيل التقييم";
                ShowToast(DetailError, "error");
            }
        }
        catch (Exception ex)
        {
        DetailError = $"خطأ: {ex.Message}";
        ShowToast(DetailError, "error");
        }
        finally
        {
            IsDetailLoading = false;
            StateHasChanged();
        }
    }

    private void HideModal()
    {
        IsModalVisible = false;
        IsHodModalVisible = false;
        SelectedData = null;
        DetailError = null;
        IsDetailLoading = false;
        StateHasChanged();
    }

    // Print method for Dean modal only
    private async Task PrintDeanModal()
    {
        if (SelectedData is null) return;
        Console.WriteLine("?? Printing Dean modal");
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task ApproveEvaluation()
    {
        if (SelectedData is null || !Permissions.CanApproveFinalReport || IsApproving)
            return;

        var confirm = await JS.InvokeAsync<bool>(
            "confirm",
            "هل أنت متأكد من اعتماد هذا التقييم بشكل نهائي؟");
            if (!confirm) return;

        IsApproving = true;
        StateHasChanged();

        try
        {
            var dto = new AcceptEvaluationDto
            {
                EvaluationId = SelectedData.EvaluationId,
                DateApproved = DateOnly.FromDateTime(DateTime.Now)
            };

            var response = await Http.PostAsJsonAsync("/api/Dean/acceptEvaluation", dto);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<DeanActionResponseDto>();
                ShowToast(result?.Message ?? "تم اعتماد التقييم النهائي بنجاح.", "success");
                await FetchEvaluationsAsync();

                var eval = Evaluations.FirstOrDefault(e => e.evaluationId == SelectedData.EvaluationId);
                if (eval != null)
                    OpenModal(eval);
                else
                    HideModal();
            }
            else
            {
                ShowToast("فشل اعتماد التقييم", "error");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"خطأ: {ex.Message}", "error");
        }
        finally
        {
            IsApproving = false;
            StateHasChanged();
        }
    }

    private async Task ReturnEvaluation()
    {
        if (SelectedData is null || !Permissions.CanReturnFinalReport || IsReturning)
            return;

        var comment = await JS.InvokeAsync<string?>(
            "prompt",
            "يرجى إدخال سبب الإرجاع/الرفض إلى رئيس القسم:");

        if (string.IsNullOrWhiteSpace(comment)) return;

        IsReturning = true;
        StateHasChanged();

        try
        {
            var dto = new ReturnEvaluationDto
            {
                EvaluationId = SelectedData.EvaluationId,
                DeanReturnComment = comment
            };

            var response = await Http.PostAsJsonAsync("api/Dean/returnEvaluation", dto);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<DeanActionResponseDto>();
                ShowToast(result?.Message ?? "تم إرجاع التقييم إلى رئيس القسم بنجاح.", "success");
                await FetchEvaluationsAsync();

                var eval = Evaluations.FirstOrDefault(e => e.evaluationId == SelectedData.EvaluationId);
                if (eval != null)
                    OpenModal(eval);
                else
                    HideModal();
            }
            else
            {
                ShowToast("فشل إرجاع التقييم", "error");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"خطأ: {ex.Message}", "error");
        }
        finally
        {
            IsReturning = false;
            StateHasChanged();
        }
    }

    private void ShowToast(string message, string type = "success")
    {
        _toastCancellationTokenSource?.Cancel();
        _toastCancellationTokenSource = new CancellationTokenSource();

        ToastMessage = message;
        ToastType = type;
        StateHasChanged();

        Task.Delay(4000, _toastCancellationTokenSource.Token).ContinueWith(_ =>
        {
            if (!_toastCancellationTokenSource.Token.IsCancellationRequested)
            {
                ToastMessage = null;
                InvokeAsync(StateHasChanged);
            }
        });
    }

    private bool IsPendingApproval()
    {
        return SelectedData?.StatusName == 5;
    }

    private void UpdatePermissions()
    {
        // Only allow approve/return if status is "ReviewedByDean" (5)
        if (SelectedData?.StatusId == 5)
        {
            Permissions = new DeanPermissions
            {
                CanPrintReports = true,
                CanApproveFinalReport = true,
                CanReturnFinalReport = true
            };
        }
        else
        {
            Permissions = new DeanPermissions
            {
                CanPrintReports = true,
                CanApproveFinalReport = false,
                CanReturnFinalReport = false
            };
        }
    }

    private string GetGradeBadgeClass(string? grade) =>
        grade == "ããÊÇÒ" ? "badge bg-success" : "badge bg-warning text-dark";

    private string GetStatusBadgeClass(string? status) =>
        status?.Contains("اعتماد", StringComparison.OrdinalIgnoreCase) == true
        || status?.Contains("موافق", StringComparison.OrdinalIgnoreCase) == true
            ? "badge bg-success"
            : "badge bg-warning text-dark";
    private class DeanPermissions
    {
        public bool CanPrintReports { get; set; } = true;
        public bool CanApproveFinalReport { get; set; }
        public bool CanReturnFinalReport { get; set; }
    }

    private async Task HandleSaveSuccess()
    {
        // Reload the evaluation data after save
        if (SelectedData != null)
        {
            var eval = Evaluations.FirstOrDefault(e => e.evaluationId == SelectedData.EvaluationId);
            if (eval != null)
            {
                IsHodModalVisible = false;
                IsModalVisible = false;
                OpenModal(eval);
            }
        }
    }
    private string GetStatusDisplayName(int statusId)
    {
        return statusId switch
        {
            1 => "مسودة",
            2 => "مقدم",
            5 => "تمت المراجعة من رئيس القسم",
            4 => "مرتجع من رئيس القسم",
            //5 => "تمت المراجعة من العميد",
            6 => "مرتجع من العميد",
            7 => "معتمد",
            _ => "غير محدد"
        };
    }

    // Fixed status badge class based on statusId
    private string GetStatusBadgeClass(int statusId)
    {
        return statusId switch
        {
            1 => "badge bg-secondary",      // Draft
            2 => "badge bg-info",           // Submitted
            5 => "badge bg-primary",        // ReviewedByHOD
            4 => "badge bg-warning text-dark", // ReturnedByHOD
            //5 => "badge bg-primary",        // ReviewedByDean (pending approval)
            6 => "badge bg-danger",         // ReturnedByDean
            7 => "badge bg-success",        // Approved
            _ => "badge bg-secondary"
        };
    }
}
