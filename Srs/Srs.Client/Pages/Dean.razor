@page "/dean"
@using Shared.Dtos.EvaluationPeriod
@using Shared.Dtos.ProfessorEvaluationDto
@using Shared.Dtos.TASubmissions
@using Shared.Dtos.DeanDto
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>

@if (!string.IsNullOrEmpty(ToastMessage))
{
    <div class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3" style="min-width: 300px;">
        <div class="alert @ToastClass alert-dismissible fade show shadow-sm mb-0" role="alert">
            @ToastMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
                    @onclick="() => ToastMessage = null"></button>
        </div>
    </div>
}

<h3 class="text-center mb-4">متابعة التقييمات - عميد الكلية</h3>

<div class="d-flex flex-column justify-content-center align-items-center vh-80">
    <div class="w-75 mb-4 shadow-sm p-4 bg-white" dir="rtl">
        <p class="text-muted text-center mb-4">
            تظهر في هذه القائمة التقييمات التي تم استكمالها واعتمادها من قبل رئيس القسم، وهي الآن جاهزة للمراجعة والاعتماد النهائي.
        </p>

        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <input type="text"
                       class="form-control"
                       placeholder="بحث بالاسم أو الرقم الوظيفي أو الحالة..."
                       @bind="SearchTerm"
                       @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="SelectedDepartment">
                    <option value="">فلترة حسب القسم</option>
                    <option value="قسم علوم الحاسب">قسم علوم الحاسب</option>
                    <option value="قسم نظم المعلومات">قسم نظم المعلومات</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="SelectedPeriod">
                    <option value="">فلترة حسب الفترة الزمنية</option>
                    <option value="الفصل الدراسي الأول 2024">الفصل الدراسي الأول 2024</option>
                    <option value="الفصل الدراسي الثاني 2024">الفصل الدراسي الثاني 2024</option>
                </select>
            </div>
        </div>
        @if (IsLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">جارٍ تحميل البيانات...</span>
                </div>
                <p class="mt-3 text-muted">جارٍ تحميل البيانات...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(LoadError))
        {
            <div class="alert alert-danger text-center">
                @LoadError
            </div>
        }
        else if (!FilteredEvaluations.Any())
        {
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle me-2"></i>
                لا توجد تقييمات متاحة للعرض
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle" style="table-layout: auto;">
                    <thead class="table-primary">
                        <tr>
                            <th>اسم مساعد التدريس</th>
                            <th>الرقم الوظيفي</th>
                            <th>القسم</th>
                            <th>الفترة</th>
                            <th>الحالة</th>
                            <th class="text-center">إجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var eval in FilteredEvaluations)
                        {
                            <tr>
                                <td>@(eval.taName)</td>
                                <td>@eval.taEmployeeId</td>
                                <td>@(eval.department ?? "غير محدد")</td>
                                <td>@(eval.periodName ?? "غير محدد")</td>
                                <td>
                                    <span class="@GetStatusBadgeClass(eval.statusId)">
                                        @GetStatusDisplayName(eval.statusId)
                                    </span>
                                </td>
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-primary"
                                            @onclick="() => OpenModal(eval)">
                                        عرض التفاصيل
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@* ===== Modal for Dean Evaluation Detail ===== *@
@if (IsModalVisible && SelectedData is not null && !IsHodModalVisible)
{
    <div class="modal-overlay" @onclick="HideModal">
        <div class="modal-container modal-container-lg" @onclick:stopPropagation="true" dir="rtl">
            <div class="modal-header">
                <h5 class="m-0">تفاصيل التقييم - عميد الكلية</h5>
                <button type="button" class="btn-close btn-close-white" @onclick="HideModal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                @if (IsDetailLoading)
                {
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جارٍ تحميل التفاصيل...</span>
                        </div>
                        <p class="mt-3 text-muted">جارٍ تحميل التفاصيل...</p>
                    </div>
                }
                else if (!string.IsNullOrEmpty(DetailError))
                {
                    <div class="alert alert-danger text-center">
                        @DetailError
                    </div>
                }
                else
                {
                    <div class="info-section mb-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>اسم المساعد:</strong> @SelectedData.TaName</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>الرقم الوظيفي:</strong> @SelectedData.TaEmployeeId</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <strong>القسم:</strong>
                                    @(userData.Department)
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>الفترة:</strong> @SelectedData.PeriodName</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <strong>الحالة الحالية:</strong>
                                    <span class="@GetStatusDisplayName(SelectedData.StatusId)">
                                        @SelectedData.StatusName
                                    </span>
                                </p>
                            </div>
                            @if (!string.IsNullOrEmpty(SelectedData.FinalGrade))
                            {
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>التقدير النهائي:</strong>
                                        <span class="@GetGradeBadgeClass(SelectedData.FinalGrade)">
                                            @SelectedData.FinalGrade
                                        </span>
                                    </p>
                                </div>
                            }
                       </div>
                   </div>
                    <hr />
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">ملخص الدرجات</h6>

                        <div class="row g-3">

                            <!-- الأنشطة التعليمية (العبء التدريسي) -->
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">الأنشطة التعليمية (العبء التدريسي)</span>
                                            <span class="fw-bold text-primary">
                                                @(SelectedData.ProfessorAverageCourseScore + SelectedData.TeachingLoadCompletionScore + SelectedData.TeachingActivitiesTotal) / 50
                                            </span>
                                        </div>
                                        <div class="mt-2" style="font-size: 0.85rem;">
                                            <small class="text-muted d-block">• تقييم الأساتذة: @SelectedData.ProfessorAverageCourseScore / 30</small>
                                            <small class="text-muted d-block">• اكتمال النصاب: @SelectedData.TeachingLoadCompletionScore / 10</small>
                                            <small class="text-muted d-block">• الأنشطة التعليمية: @SelectedData.TeachingActivitiesTotal / 10</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- الأنشطة الطلابية -->
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">الأنشطة الطلابية</span>
                                            <span class="fw-bold text-primary">
                                                @(SelectedData.StudentActivitiesTotal) / 10
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- السمات الشخصية -->
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">السمات الشخصية</span>
                                            <span class="fw-bold text-primary">
                                                @(SelectedData.PersonalTraitsTotal) / 10
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- النشاط الإداري -->
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">النشاط الإداري</span>
                                            <span class="fw-bold text-primary">
                                                @(SelectedData.AdministrativeTotal) / 10
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- النشاط العلمي -->
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">النشاط العلمي</span>
                                            <span class="fw-bold text-primary">
                                                @(SelectedData.ScientificActivityScore) / 10
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- استقصاء الطلاب -->
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">استقصاء الطلاب</span>
                                            <span class="fw-bold text-primary">
                                                @(SelectedData.StudentSurveyScore) / 5
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- الإرشاد الأكاديمي -->
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">الإرشاد الأكاديمي</span>
                                            <span class="fw-bold text-primary">
                                                @(SelectedData.AcademicAdvisingScore) / 5
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- المجموع الكلي النهائي -->
                            <div class="col-md-12">
                                <div class="card border-success bg-success bg-opacity-10">
                                    <div class="card-body text-center py-4">

                                        <h5 class="text-success fw-bold mb-3">
                                            <i class="bi bi-check-circle-fill me-2"></i>
                                            المجموع الكلي النهائي
                                        </h5>

                                        <div class="bg-white rounded-3 p-3 shadow-sm d-inline-block">
                                            <span class="fw-bold text-success" style="font-size: 2.5rem; direction: ltr;">
                                                @CalculateTotalScore()/ 100
                                            </span>
                                        </div>

                                        @if (!string.IsNullOrEmpty(SelectedData.FinalGrade))
                                        {
                                            <div class="mt-3">
                                                <span class="badge @GetGradeBadgeClass(SelectedData.FinalGrade)"
                                                      style="font-size: 1.1rem; padding: 0.5rem 1rem;">
                                                    التقدير: @CalculateTotalScore()
                                                </span>
                                            </div>
                                        }

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary px-4" @onclick="HideModal">
                    <i class="bi bi-x-circle me-2"></i>إغلاق
                </button>

                <button type="button"
                        class="btn btn-outline-primary px-4"
                        @onclick="PrintDeanModal"
                        disabled="@IsDetailLoading">
                    <i class="bi bi-printer me-2"></i>طباعة تقرير العميد
                </button>

                <button type="button"
                        class="btn btn-info px-4"
                        @onclick="ShowDetailsModal"
                        disabled="@IsDetailLoading">
                    <i class="bi bi-eye me-2"></i>عرض تقييم رئيس القسم
                </button>

                @if (IsPendingApproval())
                {
                    <button type="button"
                            class="btn btn-warning px-4"
                            @onclick="ShowEditModal"
                            disabled="@IsDetailLoading">
                        <i class="bi bi-pencil-square me-2"></i>تعديل التقييم
                    </button>

                    <button type="button"
                            class="btn btn-danger px-4"
                            @onclick="ReturnEvaluation"
                            disabled="@(!Permissions.CanReturnFinalReport || IsReturning || IsDetailLoading)">
                        @if (IsReturning)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>جارٍ الإرجاع...</span>
                        }
                        else
                        {
                            <i class="bi bi-x-circle me-2"></i>
                            <span>إرجاع / رفض</span>
                        }
                    </button>

                    <button type="button"
                            class="btn btn-success px-4"
                            @onclick="ApproveEvaluation"
                            disabled="@(!Permissions.CanApproveFinalReport || IsApproving || IsDetailLoading)">
                        @if (IsApproving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>جارٍ الاعتماد...</span>
                        }
                        else
                        {
                            <i class="bi bi-check-circle me-2"></i>
                            <span>اعتماد نهائي</span>
                        }
                    </button>
                }
            </div>
        </div>
    </div>
}
@if (IsHodModalVisible && SelectedData != null)
{
    <Srs.Client.Compontets.HODComponent SelectedTA="@userData"
                                        EvaluationPeriodId="@EvaluationPeriodId"
                                        IsViewMode="@isViewMode"
                                        IsDeanUser="true"
                                        OnClose="@HideHodModal"
                                        OnSaveSuccess="@HandleSaveSuccess"
                                        DeanEmployeeId="121"
                                        />
}
@code {
    private List<EvaluationApiResponseDto> Evaluations { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private string? LoadError { get; set; }
    private bool IsModalVisible { get; set; }
    private bool IsHodModalVisible { get; set; }
    private DeanEvaluationDetailDto? SelectedData { get; set; }
    private bool IsDetailLoading { get; set; }
    private string? DetailError { get; set; }
    private bool IsApproving { get; set; }
    private bool IsReturning { get; set; }
    private string SearchTerm { get; set; } = string.Empty;
    private string? ToastMessage { get; set; }
    private string ToastType { get; set; } = "success";
    private string ToastClass => ToastType == "success" ? "alert-success" : "alert-danger";
    private DeanPermissions Permissions { get; set; } = new();
    private CancellationTokenSource? _toastCancellationTokenSource;
    private UserDataDto userData = new UserDataDto();
    private int EvaluationPeriodId ;
    private bool isViewMode = true;
    private const int SUPERVISOR_ID = 7150; // Example supervisor ID
    private string SelectedDepartment { get; set; } = string.Empty;
    private string SelectedPeriod { get; set; } = string.Empty;
    private IEnumerable<EvaluationApiResponseDto> FilteredEvaluations
    {
        get
        {
            var filtered = Evaluations.AsEnumerable();

            // Apply search filter
            if (!string.IsNullOrWhiteSpace(SearchTerm))
            {
                filtered = filtered.Where(e =>
                    e.taEmployeeId.ToString().Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (e.periodName.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) ||
                    (e.periodName?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            // Apply department filter
            if (!string.IsNullOrWhiteSpace(SelectedDepartment))
            {
                filtered = filtered.Where(e => e.department == SelectedDepartment);
            }

            // Apply period filter
            if (!string.IsNullOrWhiteSpace(SelectedPeriod))
            {
                filtered = filtered.Where(e => e.periodName == SelectedPeriod);
            }

            return filtered;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await GetEvaluationPeriod();
            await LoadGTAList(); // ✅ Use this instead of the old method
        }
        catch (Exception ex)
        {
            ToastMessage = $"حدث خطأ أثناء تحميل البيانات: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }
    private async Task GetEvaluationPeriod()
    {
        try
        {
            var response = await Http.GetAsync($"api/EvaluationPeriod/GetActiveEvaluationPeriod");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GetEvaluationPeriodDto>();
                EvaluationPeriodId = result.PeriodId;
                Console.WriteLine($"✅ evaluationPeriod retrieved{EvaluationPeriodId}");
            }
        }
        catch (Exception ex)
        {
            ToastMessage = $"لا توجد فترة تقييم حاليا {ex.Message}";
            Console.WriteLine($"No Active EvaluationPeriod  {ex.Message}");
        }
    }
    private async Task LoadGTAList()
    {
        try
        {
            Console.WriteLine($"📡 Fetching GTA list for supervisor {SUPERVISOR_ID}");

            // Fetch GTA list from HR API
            var response = await Http.GetAsync(
                $"https://corsproxy.io/?https://aastmtic.aast.edu/TAEvaluation_api/api/HR/GTA_List/{SUPERVISOR_ID}/2025-01-01");

            if (response.IsSuccessStatusCode)
            {
                // ✅ FIXED: Deserialize to GTADto first
                var gtaList = await response.Content.ReadFromJsonAsync<List<UserDataDto>>();

                if (gtaList != null && gtaList.Any())
                {
                    Console.WriteLine($"✅ Loaded {gtaList.Count} GTAs from API");

                    // ✅ FIXED: Map GTADto to EvaluationApiResponseDto for Dean page
                    Evaluations = gtaList.Select(gta => new EvaluationApiResponseDto
                    {
                        taEmployeeId = gta.employeeId,
                        // You'll need to get evaluation data for each GTA
                        taName = gta.employeeName,
                        evaluationId = 0, // Will be populated when we fetch evaluation details
                        statusName = $"{gta.statusid}",
                        periodName = "2025", // Or get from evaluation period
                        statusId = 1 // Default - will be updated from evaluation data
                    }).ToList();

                    // Now fetch evaluation details for each GTA
                    await LoadEvaluationDetailsForGTAs();
                }
                else
                {
                    Console.WriteLine("⚠️ No GTAs found for this supervisor");
                    LoadError = "لا يوجد مساعدي تدريس مسجلين";
                }
            }
            else
            {
                Console.WriteLine($"❌ Failed to load GTA list: {response.StatusCode}");
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error details: {errorContent}");
                LoadError = "فشل تحميل قائمة مساعدي التدريس";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading GTA list: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            LoadError = $"خطأ في تحميل قائمة مساعدي التدريس: {ex.Message}";
        }
    }
    private async Task LoadEvaluationDetailsForGTAs()
    {
        try
        {
            Console.WriteLine($"📡 Fetching evaluation details for {Evaluations.Count} GTAs");

            var updatedEvaluations = new List<EvaluationApiResponseDto>();

            foreach (var eval in Evaluations)
            {
                try
                {
                    var response = await Http.GetAsync(
                        $"/api/evaluation/ta/{eval.taEmployeeId}/current");

                    if (response.IsSuccessStatusCode)
                    {
                        var evaluationDetail = await response.Content.ReadFromJsonAsync<EvaluationApiResponseDto>();

                        if (evaluationDetail != null)
                        {
                            // ✅ FIX: Preserve the TA name from original data
                            evaluationDetail.taName = eval.taName;
                            evaluationDetail.taEmployeeId = eval.taEmployeeId;

                            updatedEvaluations.Add(evaluationDetail);
                            Console.WriteLine($"✅ Found evaluation for TA {eval.taEmployeeId} - {eval.taName}");
                        }
                        else
                        {
                            updatedEvaluations.Add(eval);
                        }
                    }
                    else
                    {
                        // Keep the original data with the name
                        updatedEvaluations.Add(eval);
                        Console.WriteLine($"⚠️ No evaluation found for TA {eval.taEmployeeId} - keeping original data");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"⚠️ Error fetching evaluation for TA {eval.taEmployeeId}: {ex.Message}");
                    updatedEvaluations.Add(eval);
                }
            }

            Evaluations = updatedEvaluations;
            Console.WriteLine($"✅ Loaded evaluation details for {Evaluations.Count} GTAs");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading evaluation details: {ex.Message}");
        }
    }
    private async Task ShowDetailsModal()
    {
        if (SelectedData == null)
        {
            Console.WriteLine("⚠️ SelectedData is null, cannot show HOD modal");
            return;
        }

        Console.WriteLine($"🔵 ShowDetailsModal called for evaluation: {SelectedData.EvaluationId}");
        Console.WriteLine($"   - TaEmployeeId: {SelectedData.TaEmployeeId}");
        Console.WriteLine($"   - TaName: {SelectedData.TaName}");
        var userDatadto = await FetchEmployeeInfo(userData.employeeId);

        if (userData != null)
        {
            // ✅ Update SelectedTA with full info
            userData.employeeName = userDatadto.employeeName;
            userData.Department = userDatadto.Department ?? userDatadto.Department;
            userData.college = userDatadto.college;
            userData.jobTitle = userDatadto.jobTitle;

            Console.WriteLine($"✅ Employee info updated:");
            Console.WriteLine($"   - Name: {userDatadto.employeeName}");
            Console.WriteLine($"   - Department: {userDatadto.Department}");
            Console.WriteLine($"   - College: {userDatadto.college}");
            Console.WriteLine($"   - Job Title: {userDatadto.jobTitle}");
        }

        // Create a fresh userData object with all required fields

        Console.WriteLine($"✅ User Data populated:");
        Console.WriteLine($"   - ID: {userData.employeeId}");
        Console.WriteLine($"   - Name: {userData.employeeName}");
        Console.WriteLine($"   - EvaluationId: {userData.EvaluationId}");
        Console.WriteLine($"   - EmployeeNumber: {userData.EmployeeNumber}");

        // Close Dean modal and open HOD modal in VIEW mode
        IsModalVisible = false;
        isViewMode = true;
        IsHodModalVisible = true;

        Console.WriteLine($"✅ Modal state changed:");
        Console.WriteLine($"   - IsModalVisible: {IsModalVisible}");
        Console.WriteLine($"   - IsHodModalVisible: {IsHodModalVisible}");
        Console.WriteLine($"   - IsViewMode: {isViewMode}");

        await InvokeAsync(StateHasChanged);
    }

    private async Task ShowEditModal()
    {
        if (SelectedData == null)
        {
            Console.WriteLine("⚠️ SelectedData is null, cannot show HOD modal");
            return;
        }

        Console.WriteLine($"🔵 ShowEditModal called for evaluation: {SelectedData.EvaluationId}");

        // Create a fresh userData object with all required fields
        userData = new UserDataDto
        {
            employeeId = SelectedData.TaEmployeeId,
            employeeName = SelectedData.TaName ?? $"TA #{SelectedData.TaEmployeeId}",
            EmployeeNumber = SelectedData.TaEmployeeId,
            Department = SelectedData.TaEmail ?? "غير محدد",
            EvaluationId = SelectedData.EvaluationId,
            college = "" // Set if available from SelectedData
        };

        Console.WriteLine($"✅ Opening HOD Component in EDIT mode for Dean");

        // Close Dean modal and open HOD modal in EDIT mode
        IsModalVisible = false;
        isViewMode = false; // Allow editing
        IsHodModalVisible = true;

        Console.WriteLine($"✅ Modal state changed:");
        Console.WriteLine($"   - IsModalVisible: {IsModalVisible}");
        Console.WriteLine($"   - IsHodModalVisible: {IsHodModalVisible}");
        Console.WriteLine($"   - IsViewMode: {isViewMode}");

        StateHasChanged();
    }

    private void HideHodModal()
    {
        Console.WriteLine("?? Closing HOD modal, reopening Dean modal");

        // Close HOD modal and reopen Dean modal
        IsHodModalVisible = false;
        IsModalVisible = true;
        StateHasChanged();
    }

    private async Task OpenModal(EvaluationApiResponseDto eval)
    {
        Console.WriteLine($"🔵 Opening modal for evaluation: {eval.evaluationId}");

        // ✅ CHECK: Validate evaluation ID
        if (eval.evaluationId == 0)
        {
            Console.WriteLine("⚠️ Cannot open modal: evaluationId is 0");
            ShowToast("لا يوجد تقييم متاح لهذا المساعد", "error");
            return;
        }

        SelectedData = null;
        DetailError = null;
        IsDetailLoading = true;
        IsModalVisible = true;
        IsHodModalVisible = false;

        await InvokeAsync(StateHasChanged);

        try
        {
            // ✅ STEP 1: Fetch employee info using eval.taEmployeeId (not userData.employeeId!)
            Console.WriteLine($"📡 Fetching employee info for TA {eval.taEmployeeId}");
            var employeeInfo = await FetchEmployeeInfo(eval.taEmployeeId);

            // ✅ STEP 2: Fetch evaluation details
            var url = $"/api/Dean/evaluationDetail/{eval.evaluationId}";
            Console.WriteLine($"📡 Fetching: {url}");

            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                SelectedData = await response.Content.ReadFromJsonAsync<DeanEvaluationDetailDto>();

                if (SelectedData == null)
                {
                    Console.WriteLine("⚠️ SelectedData is null after deserialization");
                    DetailError = "فشل تحميل بيانات التقييم";
                    ShowToast(DetailError, "error");
                    return;
                }

                UpdatePermissions();

                // Set hardcoded values if needed
                SelectedData.StudentSurveyScore = 4;
                SelectedData.AcademicAdvisingScore = 4;
                SelectedData.TeachingLoadCompletionScore = 10;

                // ✅ STEP 3: Populate userData with employee info from API
                userData.employeeId = eval.taEmployeeId;
                userData.employeeName = employeeInfo?.employeeName ?? SelectedData.TaName ?? $"TA #{eval.taEmployeeId}";
                userData.EmployeeNumber = eval.taEmployeeId;
                userData.Department = employeeInfo?.Department;
                userData.EvaluationId = SelectedData.EvaluationId;
                userData.college = employeeInfo?.college ?? "";
                //userData.qualification = employeeInfo?.qualification ?? "";
                userData.jobTitle = employeeInfo?.jobTitle ?? "";

                // ✅ STEP 4: Also update SelectedData for display in Dean modal
                if (employeeInfo != null)
                {
                    SelectedData.TaName = employeeInfo.employeeName;
                    // You might want to add a Department property to DeanEvaluationDetailDto
                    Console.WriteLine($"✅ Employee info loaded:");
                    Console.WriteLine($"   - Name: {employeeInfo.employeeName}");
                    Console.WriteLine($"   - Department: {employeeInfo.Department}");
                    Console.WriteLine($"   - College: {employeeInfo.college}");
                    //Console.WriteLine($"   - Qualification: {employeeInfo.qualification}");
                    Console.WriteLine($"   - Job Title: {employeeInfo.jobTitle}");
                }

                Console.WriteLine("✅ Modal data loaded successfully");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ API Error: {response.StatusCode} - {errorContent}");
                DetailError = $"فشل تحميل تفاصيل التقييم: {response.StatusCode}";
                ShowToast(DetailError, "error");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception in OpenModal: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            DetailError = $"خطأ: {ex.Message}";
            ShowToast(DetailError, "error");
        }
        finally
        {
            IsDetailLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    private async Task<UserDataDto?> FetchEmployeeInfo(int employeeId)
    {
        try
        {
            Console.WriteLine($"📡 Fetching employee info for ID: {employeeId}");

            var response = await Http.GetAsync(
                $"https://corsproxy.io/?https://aastmtic.aast.edu/TAEvaluation_api/api/hr/get-employee-info/{employeeId}");

            if (response.IsSuccessStatusCode)
            {
                var employeeInfo = await response.Content.ReadFromJsonAsync<UserDataDto>();
                Console.WriteLine($"✅ Employee info loaded: {employeeInfo?.employeeName}");
                return employeeInfo;
            }
            else
            {
                Console.WriteLine($"⚠️ Failed to load employee info: {response.StatusCode}");
                return null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error fetching employee info: {ex.Message}");
            return null;
        }
    }
    private void HideModal()
    {
        IsModalVisible = false;
        IsHodModalVisible = false;
        SelectedData = null;
        DetailError = null;
        IsDetailLoading = false;
        StateHasChanged();
    }

    // Print method for Dean modal only
    private async Task PrintDeanModal()
    {
        if (SelectedData is null) return;
        Console.WriteLine("?? Printing Dean modal");
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task ApproveEvaluation()
    {
        if (SelectedData is null || !Permissions.CanApproveFinalReport || IsApproving)
            return;

        var confirm = await JS.InvokeAsync<bool>(
            "confirm",
            "هل أنت متأكد من اعتماد هذا التقييم بشكل نهائي؟");
        if (!confirm) return;

        IsApproving = true;
        StateHasChanged();

        try
        {
            var dto = new AcceptEvaluationDto
            {
                EvaluationId = SelectedData.EvaluationId,
                DateApproved = DateOnly.FromDateTime(DateTime.Now)
            };

            var response = await Http.PostAsJsonAsync("/api/Dean/acceptEvaluation", dto);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<DeanActionResponseDto>();
                ShowToast(result?.Message ?? "تم اعتماد التقييم النهائي بنجاح.", "success");
                await LoadGTAList();

                var eval = Evaluations.FirstOrDefault(e => e.evaluationId == SelectedData.EvaluationId);
                if (eval != null)
                    OpenModal(eval);
                else
                    HideModal();
            }
            else
            {
                ShowToast("فشل اعتماد التقييم", "error");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"خطأ: {ex.Message}", "error");
        }
        finally
        {
            IsApproving = false;
            StateHasChanged();
        }
    }

    private async Task ReturnEvaluation()
    {
        if (SelectedData is null || !Permissions.CanReturnFinalReport || IsReturning)
            return;

        var comment = await JS.InvokeAsync<string?>(
            "prompt",
            "يرجى إدخال سبب الإرجاع/الرفض إلى رئيس القسم:");

        if (string.IsNullOrWhiteSpace(comment)) return;

        IsReturning = true;
        StateHasChanged();

        try
        {
            var dto = new ReturnEvaluationDto
            {
                EvaluationId = SelectedData.EvaluationId,
                DeanReturnComment = comment
            };

            var response = await Http.PostAsJsonAsync("api/Dean/returnEvaluation", dto);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<DeanActionResponseDto>();
                ShowToast(result?.Message ?? "تم إرجاع التقييم إلى رئيس القسم بنجاح.", "success");
                await LoadGTAList();

                var eval = Evaluations.FirstOrDefault(e => e.evaluationId == SelectedData.EvaluationId);
                if (eval != null)
                    OpenModal(eval);
                else
                    HideModal();
            }
            else
            {
                ShowToast("فشل إرجاع التقييم", "error");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"خطأ: {ex.Message}", "error");
        }
        finally
        {
            IsReturning = false;
            StateHasChanged();
        }
    }

    private async Task HandleSaveSuccess()
    {
        Console.WriteLine("🔵 HandleSaveSuccess called - reloading evaluation data");

        // Reload the evaluation data after save
        if (SelectedData != null)
        {
            // First, refresh the evaluations list
            await LoadGTAList();

            // Find the updated evaluation
            var eval = Evaluations.FirstOrDefault(e => e.evaluationId == SelectedData.EvaluationId);

            if (eval != null)
            {
                // Close HOD modal
                IsHodModalVisible = false;

                // Reload the Dean modal with fresh data
                IsModalVisible = false; // Close first
                StateHasChanged();
                await Task.Delay(100); // Small delay to ensure clean state

                OpenModal(eval); // Reopen with fresh data

                Console.WriteLine("✅ Evaluation data reloaded successfully");
            }
        }
    }
    private string GetStatusDisplayName(int statusId)
    {
        return statusId switch
        {
            1 => "مسودة",
            2 => "مقدم",
            5 => "تمت المراجعة من رئيس القسم",
            4 => "مرتجع من رئيس القسم",
            //5 => "تمت المراجعة من العميد",
            6 => "معتمد",
            7 => "مرتجع من العميد",
            _ => "غير محدد"
        };
    }

    // Fixed status badge class based on statusId
    private string GetStatusBadgeClass(int statusId)
    {
        return statusId switch
        {
            1 => "badge bg-secondary",      // Draft
            2 => "badge bg-info",           // Submitted
            5 => "badge bg-primary",        // ReviewedByHOD
            4 => "badge bg-warning text-dark", // ReturnedByHOD
            //5 => "badge bg-primary",        // ReviewedByDean (pending approval)
            7 => "badge bg-danger",         // ReturnedByDean
            6 => "badge bg-success",        // Approved
            _ => "badge bg-secondary"
        };
    }
    private decimal CalculateTotalScore()
    {
        if (SelectedData == null)
            return 0;

        return SelectedData.TotalScore;
    }
    
    // ✅ FIXED: Match HOD component calculation exactly
    private decimal CalculateTotalScoreDetailed()
    {
        if (SelectedData == null)
            return 0;

        // Teaching Load Score = Professor Average + Teaching Load Completion + Teaching Activities
        decimal teachingLoadScore = 
            SelectedData.ProfessorAverageCourseScore +    // Average of professor evaluations (max 30)
            SelectedData.TeachingLoadCompletionScore +     // Teaching load completion (0 or 10)
            SelectedData.TeachingActivitiesTotal;          // Teaching activities criteria (max 10)

        return teachingLoadScore +                         // 50 points
               SelectedData.ScientificActivityScore +      // 10 points
               SelectedData.AdministrativeTotal +          // 10 points
               SelectedData.StudentActivitiesTotal +       // 10 points
               SelectedData.StudentSurveyScore +           // Student survey (max 5)
               SelectedData.AcademicAdvisingScore +        // Academic advising (max 5)
               SelectedData.PersonalTraitsTotal;           // 10 points
    }

    private void ShowToast(string message, string type = "success")
    {
        _toastCancellationTokenSource?.Cancel();
        _toastCancellationTokenSource = new CancellationTokenSource();

        ToastMessage = message;
        ToastType = type;
        StateHasChanged();

        Task.Delay(4000, _toastCancellationTokenSource.Token).ContinueWith(_ =>
        {
            if (!_toastCancellationTokenSource.Token.IsCancellationRequested)
            {
                ToastMessage = null;
                InvokeAsync(StateHasChanged);
            }
        });
    }

    private bool IsPendingApproval()
    {
        return SelectedData?.StatusId == 5;
    }

    private void UpdatePermissions()
    {
        // Only allow approve/return if status is "ReviewedByDean" (5)
        if (SelectedData?.StatusId == 5)
        {
            Permissions = new DeanPermissions
            {
                CanPrintReports = true,
                CanApproveFinalReport = true,
                CanReturnFinalReport = true
            };
        }
        else
        {
            Permissions = new DeanPermissions
            {
                CanPrintReports = true,
                CanApproveFinalReport = false,
                CanReturnFinalReport = false
            };
        }
    }

    private string GetGradeBadgeClass(string? grade) =>
        grade == "ممتاز" ? "badge bg-success" : "badge bg-warning text-dark";

    private class DeanPermissions
    {
        public bool CanPrintReports { get; set; } = true;
        public bool CanApproveFinalReport { get; set; }
        public bool CanReturnFinalReport { get; set; }
    }
}