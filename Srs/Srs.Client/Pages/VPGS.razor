@page "/vpgs"
@using Shared.Dtos
@using Shared.Dtos.EvaluationPeriod
@using Shared.Dtos.GSDean
@using Shared.Dtos.TASubmissions
@using Shared.Dtos.VPGSEvaluation
@using static System.Net.WebRequestMethods
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly
<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>

<h3 class="text-center mb-4">تقييم الأنشطة البحثية لمساعدي التدريس</h3>

<div class="card shadow-sm" dir="rtl">
    <div class="card-body">
        <h3 class="text-center" style="color:cornflowerblue;">قائمة مساعدي التدريس</h3>
        <hr style="color:cornflowerblue;" />

        <div class="d-flex justify-content-center">
            <div class="w-75 mb-4 shadow-sm">
                @if (isLoading)
                {
                    <p class="text-center">جارٍ تحميل البيانات...</p>
                }
                else if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger text-center">@errorMessage</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-striped text-center align-middle" dir="rtl">
                            <thead class="table-primary">
                                <tr>
                                    <th>اسم مساعد التدريس</th>
                                    <th>القسم</th>
                                    <th>الحالة</th>
                                    <th>إجراء</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ta in taList)
                                {
                                    <tr>
                                        <td>@ta.employeeName</td>
                                        <td>@ta.Department</td>
                                        <td>
                                            @if (!ta.HasSubmitted)
                                            {
                                                <!-- ✅ TA hasn't submitted their evaluation yet -->
                                                <span class="badge bg-secondary">بانتظار تقديم المساعد</span>
                                            }
                                            else if (ta.HasVpgsEvaluation)
                                            {
                                                <!-- ✅ TA submitted and VPGS evaluated -->
                                                <span class="badge bg-success">تم التقييم</span>
                                            }
                                            else
                                            {
                                                <!-- ✅ TA submitted but VPGS hasn't evaluated yet -->
                                                <span class="badge bg-warning text-dark">بانتظار التقييم</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!ta.HasSubmitted)
                                            {
                                                <!-- ✅ Disabled button if TA hasn't submitted -->
                                                <button class="btn btn-sm btn-secondary" disabled>
                                                    <i class="bi bi-hourglass-split me-1"></i>
                                                    بانتظار التقديم
                                                </button>
                                            }
                                            else if (ta.HasVpgsEvaluation)
                                            {
                                                <!-- ✅ View button if already evaluated -->
                                                <button class="btn btn-sm btn-info" @onclick="() => OpenModal(ta)">
                                                    <i class="bi bi-eye me-1"></i>
                                                    عرض
                                                </button>
                                            }
                                            else
                                            {
                                                <!-- ✅ Evaluate button if TA submitted but not yet evaluated -->
                                                <button class="btn btn-sm btn-primary" @onclick="() => OpenModal(ta)">
                                                    <i class="bi bi-pencil-square me-1"></i>
                                                    تقييم
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (ModalVisable)
{
    <div class="modal d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" dir="rtl">
                <div class="modal-header" dir="rtl">
                    <button type="button" class="btn-close ms-0 me-auto" @onclick="CloseModal"></button>
                    <h5 class="modal-title">تقييم الأنشطة البحثية</h5>
                </div>
                <div class="modal-body">
                    @if (isLoadingModalData)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جارٍ التحميل...</span>
                            </div>
                            <p class="mt-2">جارٍ تحميل البيانات...</p>
                        </div>
                    }
                    else
                    {
                        <div class="border rounded p-3 bg-light mb-2">
                            <h5 class="mb-3 text-primary">البيانات الأساسية</h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">اسم مساعد التدريس</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.employeeName" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">الرقم الوظيفي:</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.EmployeeNumber" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">القسم</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.Department" />
                                </div>
                            </div>
                        </div>

                        <div class="border rounded p-3 bg-light mb-2">
                            <h5 class="mb-3 text-primary">بيانات الماجيستير</h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">التخصص/البرنامج في الماجيستير</label>
                                    <input type="text" class="form-control" @bind="mastersDto.Major" disabled />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">الساعات المجتازة</label>
                                    <input type="number" class="form-control" @bind="@mastersDto.HoursGained" disabled />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">المعدل التراكمي</label>
                                    <input type="number" step="0.01" class="form-control" @bind="@mastersDto.Grade" disabled />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">التاريخ المتوقع للإتمام</label>
                                    <input type="date" class="form-control"
                                           @bind="mastersDto.EstimatedGraduationDate"
                                           @bind:format="yyyy-MM-dd"
                                           disabled />
                                </div>
                            </div>

                            <div class="row">
                                <label class="form-label fw-bold mb-3">مؤشرات التقدم</label>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <img src="icons/@(mastersDto.ResearchPointsCompleted ? "check-circle-fill.svg" : "check-circle.svg")"
                                         width="22" height="22" class="ms-2" />
                                    <span class="fw-bold @(mastersDto.ResearchPointsCompleted ? "text-dark" : "text-muted")">
                                        اختيار النقطة البحثية
                                    </span>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <img src="icons/@(mastersDto.SearchInResources ? "check-circle-fill.svg" : "check-circle.svg")"
                                         width="22" height="22" class="ms-2" />
                                    <span class="fw-bold @(mastersDto.SearchInResources ? "text-dark" : "text-muted")">
                                        البحث في المصادر
                                    </span>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <img src="icons/@(mastersDto.SearchPlanning ? "check-circle-fill.svg" : "check-circle.svg")"
                                         width="22" height="22" class="ms-2" />
                                    <span class="fw-bold @(mastersDto.SearchPlanning ? "text-dark" : "text-muted")">
                                        وضع الخطة البحثية
                                    </span>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <img src="icons/@(mastersDto.CollectDataAndAnalyze ? "check-circle-fill.svg" : "check-circle.svg")"
                                         width="22" height="22" class="ms-2" />
                                    <span class="fw-bold @(mastersDto.CollectDataAndAnalyze ? "text-dark" : "text-muted")">
                                        جمع وتحليل البيانات
                                    </span>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <img src="icons/@(mastersDto.ResearchReportWriting ? "check-circle-fill.svg" : "check-circle.svg")"
                                         width="22" height="22" class="ms-2" />
                                    <span class="fw-bold @(mastersDto.ResearchReportWriting ? "text-dark" : "text-muted")">
                                        كتابة البحث/الأبحاث
                                    </span>
                                </div>

                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <img src="icons/@(mastersDto.ScientificResearchReport ? "check-circle-fill.svg" : "check-circle.svg")"
                                         width="22" height="22" class="ms-2" />
                                    <span class="fw-bold @(mastersDto.ScientificResearchReport ? "text-dark" : "text-muted")">
                                        كتابة الرسالة العلمية
                                    </span>
                                </div>
                            </div>

                        </div>

                        <div class="border rounded p-3 bg-light mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="text-primary mb-0">الأبحاث والأوراق العلمية</h5>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover table-striped text-center align-middle">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>عنوان البحث او الورقة</th>
                                            <th>اسم المؤتمر/الدورية</th>
                                            <th>المكان</th>
                                            <th>عدد الصفحات</th>
                                            <th>التاريخ</th>
                                            <th>الحالة</th>
                                            <th>الرابط</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (researchPapers != null && researchPapers.Any())
                                        {
                                            @foreach (var paper in researchPapers)
                                            {
                                                <tr>
                                                    <td>@paper.Title</td>
                                                    <td>@paper.ConferenceOrJournal</td>
                                                    <td>@paper.Location</td>
                                                    <td>@paper.PageCount</td>
                                                    <td>@paper.Date.ToString("yyyy/MM/dd")</td>
                                                    <td>@GetStatusName(paper.Status)</td>
                                                    <td class="py-3" style="max-width: 250px;">
                                                        @if (!string.IsNullOrEmpty(paper.Url))
                                                        {
                                                            <a href="@paper.Url" target="_blank" class="text-primary text-decoration-none d-flex align-items-center" title="@paper.Url">
                                                                <i class="bi bi-link-45deg me-1 flex-shrink-0"></i>
                                                                <span class="text-truncate" style="max-width: 200px;">
                                                                    @paper.Url
                                                                </span>
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">لا يوجد رابط</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">لا توجد أبحاث مسجلة</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="border rounded p-3 bg-light mb-3">
                            <h5 class="mb-3 text-primary">الأنشطة الأخرى</h5>
                            <div class="col-md-4 d-flex align-items-center mb-2">
                                <img src="icons/@(otherActivities.HasTechnicalReportsOrArticles ? "check-circle-fill.svg" : "check-circle.svg")"
                                     width="20" height="20" style="margin-inline-end: 12px;" />
                                <span class="@(otherActivities.HasTechnicalReportsOrArticles ? "text-dark" : "text-muted")">
                                    تقارير فنية او مقالات منشورة (دون مستوي البحث العلمي)
                                </span>
                            </div>
                            <div class="col-md-4 d-flex align-items-center mb-2">
                                <img src="icons/@(otherActivities.HasGivenLecturesOrSeminars ? "check-circle-fill.svg" : "check-circle.svg")"
                                     width="20" height="20" style="margin-inline-end: 12px;" />
                                <span class="@(otherActivities.HasGivenLecturesOrSeminars ? "text-dark" : "text-muted")">
                                    القاء محاضرات في ندوات او لقاءات
                                </span>
                            </div>
                            <div class="col-md-4 d-flex align-items-center mb-2">
                                <img src="icons/@(otherActivities.HasAttendedScientificSeminars ? "check-circle-fill.svg" : "check-circle.svg")"
                                     width="20" height="20" style="margin-inline-end: 12px;" />
                                <span class="@(otherActivities.HasAttendedScientificSeminars ? "text-dark" : "text-muted")">
                                    حضور ندوات علمية ودورات تدريبية ومحاضرات علمية
                                </span>

                            </div>
                        </div>
                        <div class="border rounded p-3 bg-light mb-2">
                            <div class="row">
                                <label class="form-label fw-bold mb-3">تقييم التقدم والملاحظات</label>

                                <div class="col-md-6 mb-3">
                                    <div class="alert alert-primary text-center mt-4 py-3">
                                        <div class="d-flex justify-content-center align-items-center gap-3">
                                            <span class="fs-5 fw-bold">الدرجة النهائية للنشاط العلمي:</span>

                                            @if (IsViewMode)
                                            {
                                                <span class="fs-2 fw-bold text-primary">@scientificScore</span>
                                            }
                                            else
                                            {
                                                <input type="number"
                                                       @bind="scientificScore"
                                                       class="form-control text-center fs-2 fw-bold"
                                                       style="max-width: 100px;"
                                                       min="0"
                                                       max="5"
                                                       step="1"
                                                       onkeypress="return (event.charCode >= 48 && event.charCode <= 53) || event.charCode === 8"
                                                       oninput="this.value = Math.floor(Math.abs(this.value)); if(this.value > 5) this.value = 5;" />
                                            }

                                            <span class="fs-5 text-muted">/ 5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (IsViewMode)
                    {
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">إغلاق</button>
                    }
                    else if (!isLoadingModalData)
                    {
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">إغلاق</button>
                        <button type="button" class="btn btn-primary"
                                @onclick="SaveEvaluation"
                                disabled="@isSaving">
                            @(isSaving ? "جارٍ الحفظ..." : "اعتماد الدرجة")
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private string errorMessage = "";
    private List<UserDataDto> taList = new();
    private bool ModalVisable = false;
    private UserDataDto? selectedTA;
    private int evaluationperiodid;// Hardcoded for now
    private MastersDto mastersDto = new();
    private bool isLoadingModalData = false;
    private bool isSaving = false;
    private bool IsReadOnly => selectedTA?.statusid == 2;
    private bool IsViewMode => selectedTA?.HasVpgsEvaluation == true;
    private List<ResearchPaperDto> researchPapers = new();
    private OtherActivitiesDto otherActivities = new OtherActivitiesDto();
    // VPGS specific fields
    private int scientificScore = 0;
    private int? currentVpgsEvaluationId = null;
    private int professorId = 9614;

    // Paper modal properties
    private bool showPaperModal = false;
    private bool isEditMode = false;
    private ResearchPaperDto currentPaper = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        errorMessage = "";

        try
        {
            Console.WriteLine("📡 Loading VPGS page data...");

            await GetEvaluationPeriod();

            if (evaluationperiodid == 0)
            {
                errorMessage = "لا توجد فترة تقييم نشطة حالياً";
                return;
            }
            var response = await Http.GetAsync($"/api/Vpgs/GetGTAsForVPGS?periodId={evaluationperiodid}&SupervisorId={professorId}&StartDate=2025-01-01");

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                throw new Exception($"Failed to load GTAs: {error}");
            }

            taList = await response.Content.ReadFromJsonAsync<List<UserDataDto>>()
                ?? new List<UserDataDto>();

            Console.WriteLine($"✅ Loaded {taList.Count} GTAs for VPGS");

            var submitted = taList.Count(t => t.HasSubmitted);
            var evaluated = taList.Count(t => t.HasVpgsEvaluation);
            Console.WriteLine($"   - {submitted} have submitted");
            Console.WriteLine($"   - {evaluated} have been evaluated by VPGS");
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء تحميل البيانات: {ex.Message}";
            Console.WriteLine($"❌ Error: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    private async Task GetEvaluationPeriod()
    {
        try
        {
            var response = await Http.GetAsync($"api/EvaluationPeriod/GetActiveEvaluationPeriod");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GetEvaluationPeriodDto>();
                evaluationperiodid = result.PeriodId;
                Console.WriteLine($"✅ evaluationPeriod retrieved{evaluationperiodid}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"لا توجد فترة تقييم حاليا {ex.Message}";
            Console.WriteLine($"No Active EvaluationPeriod  {ex.Message}");
        }
    }
    private async Task OpenModal(UserDataDto ta)
    {
        // ✅ Don't allow opening modal if TA hasn't submitted
        if (!ta.HasSubmitted)
        {
            await JS.InvokeVoidAsync("alert", "لم يقدم مساعد التدريس تقييمه بعد");
            return;
        }

        selectedTA = ta;
        ModalVisable = true;
        isLoadingModalData = true;

        try
        {
            int evaluationId = ta.EvaluationId;
            Console.WriteLine($"📋 Opening modal for {ta.employeeName} - EvaluationId: {evaluationId}");

            // Try to fetch existing VPGS evaluation
            var response = await Http.GetAsync($"api/Vpgs/evaluation/{evaluationId}");

            if (response.IsSuccessStatusCode)
            {
                var vpgsData = await response.Content.ReadFromJsonAsync<VpgsEvaluationResponseDto>();

                if (vpgsData != null)
                {
                    currentVpgsEvaluationId = vpgsData.VpgsevalId;
                    scientificScore = vpgsData.ScientificScore;

                    Console.WriteLine($"✅ Loaded VPGS evaluation - Score: {scientificScore}");
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // No existing evaluation - initialize for new entry
                currentVpgsEvaluationId = null;
                scientificScore = 0;
                Console.WriteLine("ℹ️ No existing VPGS evaluation - ready for new entry");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"⚠️ Error loading VPGS: {errorContent}");
            }

            // Load masters progress data
            await LoadMastersProgressData(evaluationId);

            // Load research papers
            await LoadResearchPapers(evaluationId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading modal data: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ: {ex.Message}");
        }
        finally
        {
            isLoadingModalData = false;
            StateHasChanged();
        }
    }

    private async Task LoadMastersProgressData(int evaluationId)
    {
        try
        {
            var response = await Http.GetAsync($"/api/GSDean/GetByEvaluationForGSDeanPeriodAndTAAsync/{evaluationperiodid}/{selectedTA.employeeId}");

            if (response.IsSuccessStatusCode)
            {
                var gsdeanData = await response.Content.ReadFromJsonAsync<GsdeanEvaluationDto>();

                if (gsdeanData != null)
                {
                    mastersDto = new MastersDto
                    {
                        Major = gsdeanData.ProgramName,
                        HoursGained = gsdeanData.CompletedHours,
                        Grade = gsdeanData.Gpa,
                        EstimatedGraduationDate = gsdeanData.ExpectedCompletionDate,
                        ResearchPointsCompleted = gsdeanData.TopicChosen,
                        SearchInResources = gsdeanData.LiteratureReview,
                        SearchPlanning = gsdeanData.ResearchPlan,
                        CollectDataAndAnalyze = gsdeanData.DataCollection,
                        ResearchReportWriting = gsdeanData.Writing,
                        ScientificResearchReport = gsdeanData.ThesisDefense
                    };

                    Console.WriteLine("✅ Masters data loaded from GSDean");
                }
            }
            else
            {
                // Initialize empty
                mastersDto = new MastersDto
                {
                    EstimatedGraduationDate = DateOnly.FromDateTime(DateTime.Now)
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading masters data: {ex}");
            mastersDto = new MastersDto
            {
                EstimatedGraduationDate = DateOnly.FromDateTime(DateTime.Now)
            };
        }
    }

    private async Task LoadResearchPapers(int evaluationId)
    {
        try
        {
            Console.WriteLine($"🔍 Loading research papers for evaluation ID: {evaluationId}");

            var response = await Http.GetAsync($"/api/Evaluation/GetTASubmission/{evaluationId}");

            Console.WriteLine($"📡 Response Status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                // The API returns TASubmissionResponseDto, not a direct list
                var submissionData = await response.Content.ReadFromJsonAsync<TASubmissionResponseDto>();

                if (submissionData?.ResearchActivities != null && submissionData.ResearchActivities.Any())
                {
                    // Map ResearchActivityResponseDto to ResearchPaperDto
                    researchPapers = submissionData.ResearchActivities.Select(activity => new ResearchPaperDto
                    {
                        Title = activity.Title,
                        ConferenceOrJournal = activity.Journal,
                        Location = activity.Location,
                        PageCount = activity.PageCount,
                        Date = activity.ActivityDate,
                        Status = activity.StatusId,
                        Url = activity.Url
                    }).ToList();

                    Console.WriteLine($"✅ Successfully loaded {researchPapers.Count} research papers");

                    otherActivities = new OtherActivitiesDto
                    {
                        HasTechnicalReportsOrArticles = submissionData.HasTechnicalReports,
                        HasGivenLecturesOrSeminars = submissionData.HasSeminarLectures,
                        HasAttendedScientificSeminars = submissionData.HasAttendingSeminars
                    };
                    foreach (var paper in researchPapers)
                    {
                        Console.WriteLine($"  - Paper: {paper.Title}, Status: {paper.Status}, Date: {paper.Date}");
                    }
                }
                else
                {
                    Console.WriteLine("ℹ️ No research activities found in submission");
                    researchPapers = new List<ResearchPaperDto>();
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Error Response: {errorContent}");
                researchPapers = new List<ResearchPaperDto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception loading papers: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            researchPapers = new List<ResearchPaperDto>();
        }
    }

    private void CloseModal()
    {
        ModalVisable = false;
        mastersDto = new MastersDto();
        selectedTA = null;
        researchPapers = new();
        scientificScore = 0;
        currentVpgsEvaluationId = null;
    }

    private async Task SaveEvaluation()
    {
        isSaving = true;

        try
        {
            if (scientificScore < 0 || scientificScore > 5)
            {
                await JS.InvokeVoidAsync("alert", "الدرجة العلمية يجب أن تكون بين 0 و 5");
                return;
            }

            if (currentVpgsEvaluationId == null)
            {
                // Create new VPGS evaluation
                var createDto = new CreateVpgsEvaluationDto
                {
                    EvaluationId = selectedTA!.EvaluationId,
                    ScientificScore = scientificScore
                };

                var response = await Http.PostAsJsonAsync("/api/Vpgs/create", createDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم حفظ التقييم بنجاح");
                    Console.WriteLine($"✅ VPGS evaluation created successfully");
                    CloseModal();
                    await OnInitializedAsync(); // Reload the list
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"فشل حفظ التقييم: {error}");
                    Console.WriteLine($"❌ Failed to create VPGS: {error}");
                }
            }
            else
            {
                // Update existing VPGS evaluation
                var updateDto = new UpdateVpgsEvaluationDto
                {
                    ScientificScore = scientificScore
                };

                var response = await Http.PutAsJsonAsync($"/api/Vpgs/evaluation/{selectedTA!.EvaluationId}", updateDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم تحديث التقييم بنجاح");
                    Console.WriteLine($"✅ VPGS evaluation updated successfully");
                    CloseModal();
                    await OnInitializedAsync(); // Reload the list
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"فشل تحديث التقييم: {error}");
                    Console.WriteLine($"❌ Failed to update VPGS: {error}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving evaluation: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ أثناء الحفظ: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
    private string GetStatusName(int status)
    {
        return status switch
        {
            1 => "منشور",
            2 => "قيد المراجعة",
            3 => "مقبول",
            4 => "مرفوض",
            _ => "غير محدد"
        };
    }

    private void ClosePaperModal()
    {
        showPaperModal = false;
        currentPaper = new();
    }

    private string GetStatusCode(int statusName)
    {
        return statusName switch
        {
            1 => "published",
            2 => "under review",
            3 => "accepted",
            4 => "rejected",
        };
    }
}