@page "/index"
@rendermode InteractiveWebAssembly
@using Shared.Dtos
@using Shared.Dtos.ProfessorEvaluationDto
@using Shared.Dtos.TASubmissions
@using System.Text.Json
@inject HttpClient http

<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>

<div class="d-flex flex-column justify-content-center align-items-center vh-80">
    <h3 class="text-center mb-4">تقييم مساعد التدريس</h3>

    @if (isLoading)
    {
        @* --- GLOBAL LOADING STATE --- *@
        <div class="text-center py-5 w-100">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <h5 class="mt-3 text-muted">جاري تحميل البيانات، يرجى الانتظار...</h5>
        </div>
    }
    else if (errorMessage != null)
    {
        @* --- ERROR STATE --- *@
        <div class="w-75 mb-4">
            <div class="alert alert-danger shadow-sm" role="alert">
                <h4 class="alert-heading">حدث خطأ</h4>
                <p>@errorMessage</p>
                <hr>
                <button class="btn btn-outline-danger" @onclick="LoadUserData">إعادة المحاولة</button>
            </div>
        </div>
    }
    else
    {

        @* View-Only Notice *@
        @if (viewonly)
        {
            <div class="w-75 mb-4">
                <div class="alert alert-info shadow-sm" role="alert">
                    <h5 class="alert-heading">
                        <i class="bi bi-lock-fill"></i> وضع العرض فقط
                    </h5>
                    <p class="mb-0">تم إرسال هذا التقييم ولا يمكن تعديله. يمكنك فقط عرض البيانات.</p>
                </div>
            </div>
        }

        @* 1. Personal Data Card *@
        <div class="w-75 mb-4 shadow-sm">
            <div class="card shadow-sm" style="width: 100%;" dir="rtl">
                <div class="card-body">
                    <EditForm Model="@userData">
                        <DataAnnotationsValidator />
                        <h3 style="color:cornflowerblue">البيانات الشخصية</h3>
                        <hr style="color:cornflowerblue" />
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="name" class="form-label">الاسم</label>
                                    <InputText id="name" class="form-control" @bind-Value="userData.Name" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="employeeNumber" class="form-label">الرقم الوظيفي</label>
                                    <InputNumber id="employeeNumber" class="form-control" @bind-Value="userData.EmployeeNumber" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="qualification" class="form-label">المؤهل</label>
                                    <InputText id="qualification" class="form-control" @bind-Value="userData.Qualification" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="department" class="form-label">القسم</label>
                                    <InputText id="department" class="form-control" @bind-Value="userData.Department" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="college" class="form-label">الكلية/الفرع </label>
                                    <InputText id="college" class="form-control" @bind-Value="userData.College" readonly />
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets.EducationalActivityComponent OnActivityLoaded="HandleEducationalData"
                                                                 />
        </div>

        @* FIXED: Pass evaluationId and IsReadOnly to the component *@
        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets.SentificِActivityComponent EvaluationId="@evaluationId"
                                                              InitialResearchPapers="@researchPapers"
                                                              InitialOtherActivities="@otherActivities"
                                                              TAEmployeeId="@userData.Id"
                                                              OnResearchPapersLoaded="@HandleResearchPapersLoaded"
                                                              OnOtherActivitiesLoaded="@HandleOtherActivitiesLoaded"
                                                              IsReadOnly="@viewonly" />
        </div>

        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets.AdministrativeِِActivityComponent InitialData="administrativeData"
                                                                     OnActivityLoaded="HandleAdministrativeData"
                                                                     IsReadOnly="@viewonly" />
        </div>

        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets.StudentActivityComponent InitialData="studentActivityData"
                                                            OnActivityLoaded="HandleStudentActivityData"
                                                            IsReadOnly="@viewonly" />
        </div>

        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets._ِAcademicAdvisingComponent IsReadOnly="@viewonly" />
        </div>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="w-75 mb-4">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>نجح!</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="w-75 mb-4">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>خطأ!</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
                </div>
            </div>
        }

        @* Only show buttons if NOT in view-only mode *@
        @if (!viewonly)
        {
            <div class="w-75 mb-4 d-flex gap-3">
                <button class="btn btn-outline-primary btn-lg flex-fill" @onclick="SaveDraft">
                    @if (isExistingSubmission)
                    {
                        <text>تحديث البيانات</text>
                    }
                    else
                    {
                        <text>حفظ جميع البيانات كمسودة</text>
                    }
                </button>
                <button class="btn btn-primary btn-lg flex-fill" @onclick="SubmitAllData">
                    ارسال التقييم
                </button>
            </div>
        }
    }
</div>

@code {
    private UserDataDto userData = new UserDataDto();
    private bool isLoading = true;
    private int evaluationId;
    private int? submissionId;
    private bool isExistingSubmission = false;
    private string? errorMessage;
    private string? successMessage;
    private bool viewonly = false;

    private List<ResearchPaperDto> researchPapers = new List<ResearchPaperDto>();
    private OtherActivitiesDto otherActivities = new OtherActivitiesDto();
    private AdminstrativeActivityDto administrativeData = new AdminstrativeActivityDto();
    private StudentActivityDto studentActivityData = new StudentActivityDto();
    private EducationalActivityDto? educationalData;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }

    private void HandleEducationalData(EducationalActivityDto data)
    {
        educationalData = data;
        Console.WriteLine("Educational data received");
    }

    private void HandleAdministrativeData(AdminstrativeActivityDto data)
    {
        administrativeData = data;
        Console.WriteLine($"Administrative data received: IsAcademicGuidanceCommittee = {data.IsAcademicGuidanceCommittee}");
    }

    private void HandleStudentActivityData(StudentActivityDto data)
    {
        studentActivityData = data;
        Console.WriteLine("Student activity data received");
    }

    private void HandleResearchPapersLoaded(List<ResearchPaperDto> papers)
    {
        researchPapers = papers;
        Console.WriteLine($"Research papers loaded: {papers.Count} papers");
    }

    private void HandleOtherActivitiesLoaded(OtherActivitiesDto activities)
    {
        otherActivities = activities;
        Console.WriteLine("Other activities loaded");
    }

    private async Task LoadUserData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            userData = new Shared.Dtos.UserDataDto
            {
                Id = 7,
                Name = "علياء احمد",
                EmployeeNumber = 12323,
                Qualification = "ماجستير في علوم الحاسب",
                Department = "قسم علوم الحاسب",
                College = "AASTMT"
            };

            Console.WriteLine("User data loaded successfully");

            await GetOrCreateEvaluation();
        }
        catch (Exception ex)
        {
            errorMessage = $"فشل تحميل البيانات: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GetOrCreateEvaluation()
    {
        try
        {
            var response = await http.PostAsync($"/api/Evaluation/getorcreate?taEmployeeId={userData.Id}&periodId=1", null);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GetEvaluationDto>();
                evaluationId = result.EvaluationId;
                Console.WriteLine($"✅ Evaluation retrieved/created with ID: {evaluationId}");

                var submissionResponse = await http.GetAsync($"/api/Evaluation/GetTASubmission/{evaluationId}");
                if (submissionResponse.IsSuccessStatusCode)
                {
                    await LoadExistingTAData();
                    isExistingSubmission = true;
                    Console.WriteLine("✅ Existing submission loaded");
                }
                else
                {
                    Console.WriteLine("ℹ️ No existing submission found - new evaluation");
                }

                if (result.StatusId >= 2)
                {
                    viewonly = true;
                    Console.WriteLine($"🔒 View-only mode enabled (StatusId: {result.StatusId})");
                }

                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Failed to get or create evaluation: {error}");
                errorMessage = $"فشل في تحميل التقييم: {error}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error getting or creating evaluation: {ex.Message}");
            errorMessage = $"حدث خطأ: {ex.Message}";
        }
    }

    private async Task LoadExistingTAData()
    {
        try
        {
            var response = await http.GetAsync($"/api/Evaluation/GetTASubmission/{evaluationId}");

            if (response.IsSuccessStatusCode)
            {
                var existingData = await response.Content.ReadFromJsonAsync<UpdateTASubmissionsDto>();

                if (existingData != null)
                {
                    researchPapers = existingData.ResearchActivities?.Select((r, index) => new ResearchPaperDto
                    {
                        Id = index + 1,
                        Title = r.Title,
                        ConferenceOrJournal = r.Journal,
                        Location = r.Location,
                        PageCount = r.PageCount,
                        Date = r.ActivityDate,
                        Status = r.StatusId,
                        Url = r.Url
                    }).ToList() ?? new List<ResearchPaperDto>();

                    otherActivities = new OtherActivitiesDto
                    {
                        HasTechnicalReportsOrArticles = existingData.HasTechnicalReports,
                        HasGivenLecturesOrSeminars = existingData.HasSeminarLectures,
                        HasAttendedScientificSeminars = existingData.HasAttendingSeminars
                    };

                    administrativeData = new AdminstrativeActivityDto
                    {
                        IsAcademicGuidanceCommittee = existingData.IsInAcademicAdvisingCommittee,
                        ISchedulingCommittee = existingData.IsInSchedulingCommittee,
                        IsQualityWorksCommittee = existingData.IsInQualityAssuranceCommittee,
                        IsLaboratoryEquipmentCommittee = existingData.IsInLabEquipmentCommittee,
                        IsExaminationsOrganizingCommittee = existingData.IsInExamOrganizationCommittee,
                        IsSocialOrSportsActivityCommittees = existingData.IsInSocialOrSportsCommittee
                    };

                    studentActivityData = new StudentActivityDto
                    {
                        IsCompletedStudentActivity = existingData.ParticipatedInSports,
                        IsCompletedSocialActivity = existingData.ParticipatedInSocial,
                        IsCompletedCulturalActivity = existingData.ParticipatedInCultural
                    };

                    Console.WriteLine("✅ All existing data mapped successfully");
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading existing TA data: {ex.Message}");
        }
    }

    private async Task SaveDraft()
    {
        Console.WriteLine("=== Starting SaveDraft ===");

        if (educationalData == null)
        {
            errorMessage = "بيانات النشاط التعليمي مفقودة";
            StateHasChanged();
            return;
        }

        if (administrativeData == null)
        {
            errorMessage = "بيانات النشاط الإداري مفقودة";
            StateHasChanged();
            return;
        }

        if (studentActivityData == null)
        {
            errorMessage = "بيانات النشاط الطلابي مفقودة";
            StateHasChanged();
            return;
        }

        if (educationalData.TeachingData == null)
        {
            errorMessage = "بيانات التدريس مفقودة";
            StateHasChanged();
            return;
        }

        Console.WriteLine("✅ All data present, proceeding with saving draft...");

        var researchActivities = researchPapers.Select(p => new CreateResearchActivityDto
        {
            Title = p.Title,
            Journal = p.ConferenceOrJournal,
            Location = p.Location,
            PageCount = p.PageCount,
            ActivityDate = p.Date,
            StatusId = p.Status,
            Url = p.Url
        }).ToList();

        var taSubmission = new CreateTASubmissionDto
        {
            ActualTeachingLoad = educationalData.TeachingData.ActualTeachingLoad,
            ExpectedTeachingLoad = educationalData.TeachingData.ExpectedTeachingLoad,
            HasTechnicalReports = otherActivities.HasTechnicalReportsOrArticles,
            HasSeminarLectures = otherActivities.HasGivenLecturesOrSeminars,
            HasAttendingSeminars = otherActivities.HasAttendedScientificSeminars,
            AdvisedStudentCount = 2,
            ResearchActivities = researchActivities,
            IsInAcademicAdvisingCommittee = administrativeData.IsAcademicGuidanceCommittee,
            IsInSchedulingCommittee = administrativeData.ISchedulingCommittee,
            IsInQualityAssuranceCommittee = administrativeData.IsQualityWorksCommittee,
            IsInLabEquipmentCommittee = administrativeData.IsLaboratoryEquipmentCommittee,
            IsInExamOrganizationCommittee = administrativeData.IsExaminationsOrganizingCommittee,
            IsInSocialOrSportsCommittee = administrativeData.IsSocialOrSportsActivityCommittees,
            ParticipatedInSports = studentActivityData.IsCompletedStudentActivity,
            ParticipatedInSocial = studentActivityData.IsCompletedSocialActivity,
            ParticipatedInCultural = studentActivityData.IsCompletedCulturalActivity
        };

        if (isExistingSubmission)
        {
            var updateData = new UpdateTASubmissionsDto
            {
                ActualTeachingLoad = taSubmission.ActualTeachingLoad,
                ExpectedTeachingLoad = taSubmission.ExpectedTeachingLoad,
                HasTechnicalReports = taSubmission.HasTechnicalReports,
                HasSeminarLectures = taSubmission.HasSeminarLectures,
                HasAttendingSeminars = taSubmission.HasAttendingSeminars,
                AdvisedStudentCount = taSubmission.AdvisedStudentCount,
                ResearchActivities = taSubmission.ResearchActivities,
                IsInAcademicAdvisingCommittee = taSubmission.IsInAcademicAdvisingCommittee,
                IsInSchedulingCommittee = taSubmission.IsInSchedulingCommittee,
                IsInQualityAssuranceCommittee = taSubmission.IsInQualityAssuranceCommittee,
                IsInLabEquipmentCommittee = taSubmission.IsInLabEquipmentCommittee,
                IsInExamOrganizationCommittee = taSubmission.IsInExamOrganizationCommittee,
                IsInSocialOrSportsCommittee = taSubmission.IsInSocialOrSportsCommittee,
                ParticipatedInSports = taSubmission.ParticipatedInSports,
                ParticipatedInSocial = taSubmission.ParticipatedInSocial,
                ParticipatedInCultural = taSubmission.ParticipatedInCultural
            };
            await UpdateSubmission(updateData);
        }
        else
        {
            await CreateSubmission(taSubmission);
        }
    }

    private async Task SubmitAllData()
    {
        Console.WriteLine("=== Starting SubmitAllData (Final Submission) ===");

        if (educationalData == null)
        {
            errorMessage = "بيانات النشاط التعليمي مفقودة";
            StateHasChanged();
            return;
        }

        if (administrativeData == null)
        {
            errorMessage = "بيانات النشاط الإداري مفقودة";
            StateHasChanged();
            return;
        }

        if (studentActivityData == null)
        {
            errorMessage = "بيانات النشاط الطلابي مفقودة";
            StateHasChanged();
            return;
        }

        if (educationalData.TeachingData == null)
        {
            errorMessage = "بيانات التدريس مفقودة";
            StateHasChanged();
            return;
        }

        Console.WriteLine("✅ All data present, proceeding with final submission...");

        var researchActivities = researchPapers.Select(p => new CreateResearchActivityDto
        {
            Title = p.Title,
            Journal = p.ConferenceOrJournal,
            Location = p.Location,
            PageCount = p.PageCount,
            ActivityDate = p.Date,
            StatusId = p.Status,
            Url = p.Url
        }).ToList();

        var updateData = new UpdateTASubmissionsDto
        {
            ActualTeachingLoad = educationalData.TeachingData.ActualTeachingLoad,
            ExpectedTeachingLoad = educationalData.TeachingData.ExpectedTeachingLoad,
            HasTechnicalReports = otherActivities.HasTechnicalReportsOrArticles,
            HasSeminarLectures = otherActivities.HasGivenLecturesOrSeminars,
            HasAttendingSeminars = otherActivities.HasAttendedScientificSeminars,
            AdvisedStudentCount = 2,
            ResearchActivities = researchActivities,
            IsInAcademicAdvisingCommittee = administrativeData.IsAcademicGuidanceCommittee,
            IsInSchedulingCommittee = administrativeData.ISchedulingCommittee,
            IsInQualityAssuranceCommittee = administrativeData.IsQualityWorksCommittee,
            IsInLabEquipmentCommittee = administrativeData.IsLaboratoryEquipmentCommittee,
            IsInExamOrganizationCommittee = administrativeData.IsExaminationsOrganizingCommittee,
            IsInSocialOrSportsCommittee = administrativeData.IsSocialOrSportsActivityCommittees,
            ParticipatedInSports = studentActivityData.IsCompletedStudentActivity,
            ParticipatedInSocial = studentActivityData.IsCompletedSocialActivity,
            ParticipatedInCultural = studentActivityData.IsCompletedCulturalActivity
        };

        try
        {
            var response = await http.PutAsJsonAsync($"/api/Evaluation/Submit/{evaluationId}", updateData);

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("✅ Evaluation submitted successfully!");
                successMessage = "تم إرسال التقييم بنجاح!";
                errorMessage = null;
                viewonly = true;
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Submit failed: {error}");
                errorMessage = $"فشل في إرسال التقييم: {error}";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception during submit: {ex.Message}");
            errorMessage = $"حدث خطأ أثناء الإرسال: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task CreateSubmission(CreateTASubmissionDto data)
    {
        try
        {
            var response = await http.PostAsJsonAsync($"/api/Evaluation/{evaluationId}/SubmitTAFiles", data);

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("✅ Submission created successfully!");

                try
                {
                    var responseContent = await response.Content.ReadAsStringAsync();
                    if (!string.IsNullOrWhiteSpace(responseContent))
                    {
                        var result = JsonDocument.Parse(responseContent);
                        var root = result.RootElement;

                        if (root.TryGetProperty("id", out var idElement))
                        {
                            submissionId = idElement.GetInt32();
                            isExistingSubmission = true;
                            Console.WriteLine($"📋 New submission ID: {submissionId}");
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"ℹ️ Could not extract submission ID: {ex.Message}");
                }

                successMessage = "تم حفظ البيانات بنجاح!";
                errorMessage = null;
                isExistingSubmission = true;
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Create submission failed: {error}");
                errorMessage = $"فشل في حفظ البيانات: {error}";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception during create: {ex.Message}");
            errorMessage = $"حدث خطأ أثناء الحفظ: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task UpdateSubmission(UpdateTASubmissionsDto data)
    {
        try
        {
            Console.WriteLine($"🔄 Updating submission for evaluation ID: {evaluationId}");
            var response = await http.PutAsJsonAsync($"/api/Evaluation/UpdateTASubmission/{evaluationId}", data);

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("✅ Submission updated successfully!");
                successMessage = "تم تحديث البيانات بنجاح!";
                errorMessage = null;
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Update submission failed: {error}");
                errorMessage = $"فشل في تحديث البيانات: {error}";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception during update: {ex.Message}");
            errorMessage = $"حدث خطأ أثناء التحديث: {ex.Message}";
            StateHasChanged();
        }
    }
}