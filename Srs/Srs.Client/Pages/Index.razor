@page "/index"
@rendermode InteractiveWebAssembly
@using Shared.Dtos
@using Shared.Dtos.ProfessorEvaluationDto
@using Shared.Dtos.TASubmissions
@using System.Text.Json
@inject HttpClient http

<div class="d-flex flex-column justify-content-center align-items-center vh-80">
    <h3 class="text-center mb-4">تقييم مساعد التدريس</h3>

    <div class="w-75 mb-4 shadow-sm">
        <div class="card shadow-sm" style="width: 100%;" dir="rtl">
            <div class="card-body">
                @if (isLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p class="mt-3">جاري تحميل البيانات</p>
                    </div>
                }
                else if (errorMessage != null)
                {
                    <div class="alert alert-danger" role="alert">
                        <strong>خطأ:</strong> @errorMessage
                    </div>
                    <button class="btn btn-primary" @onclick="LoadUserData">إعادة المحاولة</button>
                }
                else
                {
                    <EditForm Model="@userData">
                        <DataAnnotationsValidator />
                        <h3 style="color:cornflowerblue">البيانات الشخصية</h3>
                        <hr style="color:cornflowerblue" />
                        <div class="row g-3">
                            <!-- Name Field -->
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="name" class="form-label">الاسم</label>
                                    <InputText id="name" class="form-control" @bind-Value="userData.Name" readonly />
                                    <ValidationMessage For="@(() => userData.Name)" />
                                </div>
                            </div>

                            <!-- Employee Number Field -->
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="employeeNumber" class="form-label">الرقم الوظيفي</label>
                                    <InputNumber id="employeeNumber" class="form-control" @bind-Value="userData.EmployeeNumber" readonly />
                                    <ValidationMessage For="@(() => userData.EmployeeNumber)" />
                                </div>
                            </div>

                            <!-- Qualification Field -->
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="qualification" class="form-label">المؤهل</label>
                                    <InputText id="qualification" class="form-control" @bind-Value="userData.Qualification" readonly />
                                    <ValidationMessage For="@(() => userData.Qualification)" />
                                </div>
                            </div>

                            <!-- Department Field -->
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="department" class="form-label">القسم</label>
                                    <InputText id="department" class="form-control" @bind-Value="userData.Department" readonly />
                                    <ValidationMessage For="@(() => userData.Department)" />
                                </div>
                            </div>
                            <!-- College Field -->
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="department" class="form-label">الكلية/الفرع </label>
                                    <InputText id="department" class="form-control" @bind-Value="userData.College" readonly />
                                    <ValidationMessage For="@(() => userData.College)" />
                                </div>
                            </div>
                        </div>

                    </EditForm>
                }
            </div>
        </div>
    </div>

    <div class="w-75 mb-4 shadow-sm">
        <Srs.Client.Compontets.EducationalActivityComponent OnActivityLoaded="HandleEducationalData" />
    </div>

    <div class="w-75 mb-4 shadow-sm">
        <Srs.Client.Compontets.SentificِActivityComponent OnResearchPapersLoaded="HandleResearchPapers"
                                                          OnOtherActivitiesLoaded="HandleOtherActivities" />
    </div>

    <div class="w-75 mb-4 shadow-sm">
        <Srs.Client.Compontets.AdministrativeِِActivityComponent OnActivityLoaded="HandleAdministrativeData" />
    </div>

    <div class="w-75 mb-4 shadow-sm">
        <Srs.Client.Compontets.StudentActivityComponent OnActivityLoaded="HandleStudentActivityData" />
    </div>

    <div class="w-75 mb-4 shadow-sm">
        <Srs.Client.Compontets._ِAcademicAdvisingComponent />
    </div>

    <div class="w-75 mb-4">
        <button class="btn btn-primary btn-lg w-100" @onclick="SubmitAllData">
            حفظ جميع البيانات
        </button>
    </div>
</div>

@code {
    private UserDataDto userData = new UserDataDto();
    private bool isLoading = true;
    private int evaluationId;
    private string? errorMessage;
    private int pageTestCounter = 0;
    private List<ResearchPaperDto> researchPapers = new List<ResearchPaperDto>();
    private OtherActivitiesDto otherActivities = new OtherActivitiesDto();
    private AdminstrativeActivityDto? administrativeData;
    private StudentActivityDto? studentActivityData;
    private EducationalActivityDto? educationalData;
    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }

    private void HandleEducationalData(EducationalActivityDto data)
    {
        educationalData = data;
        Console.WriteLine("Educational data received");
    }

    private void HandleAdministrativeData(AdminstrativeActivityDto data)
    {
        administrativeData = data;
        Console.WriteLine($"Administrative data received: IsAcademicGuidanceCommittee = {data.IsAcademicGuidanceCommittee}");
    }

    private void HandleStudentActivityData(StudentActivityDto data)
    {
        studentActivityData = data;
        Console.WriteLine("Student activity data received");
    }
    private async Task LoadUserData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            userData = new Shared.Dtos.UserDataDto
            {
                Id = 121,
                Name = "علياء احمد",
                EmployeeNumber = 12323,
                Qualification = "ماجستير في علوم الحاسب",
                Department = "قسم علوم الحاسب",
                College = "AASTMT"
            };

            Console.WriteLine("User data loaded successfully");

            // Immediately create evaluation record
            await CreateEvaluation();
        }
        catch (Exception ex)
        {
            errorMessage = $"فشل تحميل البيانات: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    private async Task CreateEvaluation()
    {
        try
        {
            var response = await http.PostAsync($"/api/Evaluation/CreateEvaluation?TaEmployeeId={userData.Id}&PeriodId=1", null);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<EvaluationResponseDto>();
                evaluationId = result.id;
                Console.WriteLine($"Evaluation created with ID: {evaluationId}");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Failed to create evaluation: {error}");

                // Check if it contains the expected message
                if (error.Contains("Evaluation already exists", StringComparison.OrdinalIgnoreCase))
                {
                    Console.WriteLine("Evaluation already exists, checking existing evaluation...");
                    await GetExistingEvaluationId();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating evaluation: {ex.Message}");
        }
    }
    private async Task GetExistingEvaluationId()
    {
        try
        {
            var response = await http.GetAsync($"/api/Evaluation/CanEdit/{userData.Id}");

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();

                if (!string.IsNullOrWhiteSpace(json))
                {
                    using var doc = JsonDocument.Parse(json);
                    if (doc.RootElement.TryGetProperty("evaluationId", out var idElement))
                    {
                        evaluationId = idElement.GetInt32();
                        Console.WriteLine($"Existing evaluation found, ID = {evaluationId}");
                    }
                    else
                    {
                        Console.WriteLine("Cannot edit — evaluation not in editable status.");
                    }
                }
            }
            else
            {
                Console.WriteLine($"Failed to get evaluation: {await response.Content.ReadAsStringAsync()}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error getting existing evaluation: {ex.Message}");
        }
    }
    private async Task SubmitAllData()
    {
        Console.WriteLine("=== Starting SubmitAllData ===");
        Console.WriteLine($"educationalData is null: {educationalData == null}");
        Console.WriteLine($"administrativeData is null: {administrativeData == null}");
        Console.WriteLine($"studentActivityData is null: {studentActivityData == null}");

        if (educationalData == null)
        {
            Console.WriteLine("❌ ERROR: Educational data is missing!");
            errorMessage = "بيانات النشاط التعليمي مفقودة";
            StateHasChanged();
            return;
        }

        if (administrativeData == null)
        {
            Console.WriteLine("❌ ERROR: Administrative data is missing!");
            errorMessage = "بيانات النشاط الإداري مفقودة";
            StateHasChanged();
            return;
        }

        if (studentActivityData == null)
        {
            Console.WriteLine("❌ ERROR: Student activity data is missing!");
            errorMessage = "بيانات النشاط الطلابي مفقودة";
            StateHasChanged();
            return;
        }

        // Additional check for TeachingData
        if (educationalData.TeachingData == null)
        {
            Console.WriteLine("❌ ERROR: TeachingData is null inside educationalData!");
            errorMessage = "بيانات التدريس مفقودة";
            StateHasChanged();
            return;
        }

        Console.WriteLine("✅ All data present, proceeding with submission...");

        // Map ResearchPapers -> CreateResearchActivityDto
        var researchActivities = researchPapers.Select(p => new CreateResearchActivityDto
        {
            Title = p.Title,
            Journal = p.ConferenceOrJournal,
            Location = p.Location,
            PageCount = p.PageCount,
            ActivityDate = p.Date,
            StatusId = p.Status,
            Url = p.Url
        }).ToList();

        var taSubmission = new CreateTASubmissionDto
        {
            ActualTeachingLoad = educationalData.TeachingData.ActualTeachingLoad,
            ExpectedTeachingLoad = educationalData.TeachingData.ExpectedTeachingLoad,
            HasTechnicalReports = otherActivities.HasTechnicalReportsOrArticles,
            HasSeminarLectures = otherActivities.HasGivenLecturesOrSeminars,
            HasAttendingSeminars = otherActivities.HasAttendedScientificSeminars,
            AdvisedStudentCount = 2,
            ResearchActivities = researchActivities
        };

        Console.WriteLine("Mapped TA submission DTO:");
        Console.WriteLine(System.Text.Json.JsonSerializer.Serialize(taSubmission));

        // Call API
        await SubmitToApi(taSubmission);
    }
    private async Task SubmitToApi(CreateTASubmissionDto data)
    {
        var response = await http.PostAsJsonAsync($"/api/Evaluation/{evaluationId}/SubmitTAFiles", data);


        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("Submission successful!");
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"Submission failed: {error}");
        }
    }

    private void HandleResearchPapers(List<ResearchPaperDto> papers)
    {
        researchPapers = papers;
        Console.WriteLine("Research papers received from child");
    }

    private void HandleOtherActivities(OtherActivitiesDto activities)
    {
        otherActivities = activities;
        Console.WriteLine("Other activities received from child");
    }

}