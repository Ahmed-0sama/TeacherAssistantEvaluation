@page "/index"
@rendermode InteractiveWebAssembly
@using Shared.Dtos
@using Shared.Dtos.ProfessorEvaluationDto
@using Shared.Dtos.TASubmissions
@using System.Text.Json
@inject HttpClient http

<div class="d-flex flex-column justify-content-center align-items-center vh-80">
    <h3 class="text-center mb-4">تقييم مساعد التدريس</h3>

    @if (isLoading)
    {
        @* --- GLOBAL LOADING STATE --- *@
        <div class="text-center py-5 w-100">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <h5 class="mt-3 text-muted">جاري تحميل البيانات، يرجى الانتظار...</h5>
        </div>
    }
    else if (errorMessage != null)
    {
        @* --- ERROR STATE --- *@
        <div class="w-75 mb-4">
            <div class="alert alert-danger shadow-sm" role="alert">
                <h4 class="alert-heading">حدث خطأ</h4>
                <p>@errorMessage</p>
                <hr>
                <button class="btn btn-outline-danger" @onclick="LoadUserData">إعادة المحاولة</button>
            </div>
        </div>
    }
    else
    {
        @* --- MAIN CONTENT (Only shows when loading is false) --- *@

        @* 1. Personal Data Card *@
        <div class="w-75 mb-4 shadow-sm">
            <div class="card shadow-sm" style="width: 100%;" dir="rtl">
                <div class="card-body">
                    <EditForm Model="@userData">
                        <DataAnnotationsValidator />
                        <h3 style="color:cornflowerblue">البيانات الشخصية</h3>
                        <hr style="color:cornflowerblue" />
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="name" class="form-label">الاسم</label>
                                    <InputText id="name" class="form-control" @bind-Value="userData.Name" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="employeeNumber" class="form-label">الرقم الوظيفي</label>
                                    <InputNumber id="employeeNumber" class="form-control" @bind-Value="userData.EmployeeNumber" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="qualification" class="form-label">المؤهل</label>
                                    <InputText id="qualification" class="form-control" @bind-Value="userData.Qualification" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="department" class="form-label">القسم</label>
                                    <InputText id="department" class="form-control" @bind-Value="userData.Department" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="college" class="form-label">الكلية/الفرع </label>
                                    <InputText id="college" class="form-control" @bind-Value="userData.College" readonly />
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets.EducationalActivityComponent OnActivityLoaded="HandleEducationalData" />
        </div>

        @* FIXED: Pass evaluationId to the component *@
        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets.SentificِActivityComponent EvaluationId="@evaluationId"
                                                              InitialResearchPapers="@researchPapers"
                                                              InitialOtherActivities="@otherActivities"
                                                              OnResearchPapersLoaded="@HandleResearchPapersLoaded"
                                                              OnOtherActivitiesLoaded="@HandleOtherActivitiesLoaded" />
        </div>

        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets.AdministrativeِِActivityComponent InitialData="administrativeData"
                                                                     OnActivityLoaded="HandleAdministrativeData" />
        </div>

        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets.StudentActivityComponent InitialData="studentActivityData"
                                                            OnActivityLoaded="HandleStudentActivityData" />
        </div>

        <div class="w-75 mb-4 shadow-sm">
            <Srs.Client.Compontets._ِAcademicAdvisingComponent />
        </div>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="w-75 mb-4">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>نجح!</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="w-75 mb-4">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>خطأ!</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
                </div>
            </div>
        }

        <div class="w-75 mb-4">
            <button class="btn btn-primary btn-lg w-100" @onclick="SubmitAllData">
                @if (isExistingSubmission)
                {
                    <text>تحديث البيانات</text>
                }
                else
                {
                    <text>حفظ جميع البيانات</text>
                }
            </button>
        </div>
    }
</div>

@code {
    private UserDataDto userData = new UserDataDto();
    private bool isLoading = true;
    private int evaluationId; // This will be set after CreateEvaluation
    private int? submissionId;
    private bool isExistingSubmission = false;
    private string? errorMessage;
    private string? successMessage;

    private List<ResearchPaperDto> researchPapers = new List<ResearchPaperDto>();
    private OtherActivitiesDto otherActivities = new OtherActivitiesDto();
    private AdminstrativeActivityDto administrativeData = new AdminstrativeActivityDto();
    private StudentActivityDto studentActivityData = new StudentActivityDto();
    private EducationalActivityDto? educationalData;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }

    private void HandleEducationalData(EducationalActivityDto data)
    {
        educationalData = data;
        Console.WriteLine("Educational data received");
    }

    private void HandleAdministrativeData(AdminstrativeActivityDto data)
    {
        administrativeData = data;
        Console.WriteLine($"Administrative data received: IsAcademicGuidanceCommittee = {data.IsAcademicGuidanceCommittee}");
    }

    private void HandleStudentActivityData(StudentActivityDto data)
    {
        studentActivityData = data;
        Console.WriteLine("Student activity data received");
    }

    private void HandleResearchPapersLoaded(List<ResearchPaperDto> papers)
    {
        researchPapers = papers;
        Console.WriteLine($"Research papers loaded: {papers.Count} papers");
    }

    private void HandleOtherActivitiesLoaded(OtherActivitiesDto activities)
    {
        otherActivities = activities;
        Console.WriteLine("Other activities loaded");
    }

    private async Task LoadUserData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            userData = new Shared.Dtos.UserDataDto
            {
                Id = 19,
                Name = "علياء احمد",
                EmployeeNumber = 12323,
                Qualification = "ماجستير في علوم الحاسب",
                Department = "قسم علوم الحاسب",
                College = "AASTMT"
            };

            Console.WriteLine("User data loaded successfully");

            // Create or get evaluation
            await CreateEvaluation();
        }
        catch (Exception ex)
        {
            errorMessage = $"فشل تحميل البيانات: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged(); // Force UI update after evaluationId is set
        }
    }

    private async Task CreateEvaluation()
    {
        try
        {
            var response = await http.PostAsync($"/api/Evaluation/CreateEvaluation?TaEmployeeId={userData.Id}&PeriodId=1", null);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<EvaluationResponseDto>();
                evaluationId = result.id;
                Console.WriteLine($"✅ Evaluation created with ID: {evaluationId}");

                // Force state change to update child components
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Failed to create evaluation: {error}");

                if (error.Contains("Evaluation already exists", StringComparison.OrdinalIgnoreCase))
                {
                    Console.WriteLine("Evaluation already exists, fetching existing...");
                    await GetExistingEvaluationId();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating evaluation: {ex.Message}");
        }
    }

    private async Task GetExistingEvaluationId()
    {
        try
        {
            var response = await http.GetAsync($"/api/Evaluation/CanEdit/{userData.Id}");

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();

                if (!string.IsNullOrWhiteSpace(json))
                {
                    using var doc = JsonDocument.Parse(json);
                    if (doc.RootElement.TryGetProperty("evaluationId", out var idElement))
                    {
                        evaluationId = idElement.GetInt32();
                        Console.WriteLine($"✅ Existing evaluation found, ID = {evaluationId}");

                        // Force state change
                        StateHasChanged();

                        await LoadExistingTAData();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error getting existing evaluation: {ex.Message}");
        }
    }

    private async Task LoadExistingTAData()
    {
        try
        {
            var response = await http.GetAsync($"/api/Evaluation/GetTASubmission/{evaluationId}");

            if (response.IsSuccessStatusCode)
            {
                var existingData = await response.Content.ReadFromJsonAsync<UpdateTASubmissionsDto>();

                if (existingData != null)
                {
                    isExistingSubmission = true;

                    // Map research activities
                    researchPapers = existingData.ResearchActivities?.Select(r => new ResearchPaperDto
                    {
                        Title = r.Title,
                        ConferenceOrJournal = r.Journal,
                        Location = r.Location,
                        PageCount = r.PageCount,
                        Date = r.ActivityDate,
                        Status = r.StatusId,
                        Url = r.Url
                    }).ToList() ?? new List<ResearchPaperDto>();

                    // Map other activities
                    otherActivities = new OtherActivitiesDto
                    {
                        HasTechnicalReportsOrArticles = existingData.HasTechnicalReports,
                        HasGivenLecturesOrSeminars = existingData.HasSeminarLectures,
                        HasAttendedScientificSeminars = existingData.HasAttendingSeminars
                    };

                    // Map administrative data - CREATE NEW INSTANCE
                    administrativeData = new AdminstrativeActivityDto
                    {
                        IsAcademicGuidanceCommittee = existingData.IsInAcademicAdvisingCommittee,
                        ISchedulingCommittee = existingData.IsInSchedulingCommittee,
                        IsQualityWorksCommittee = existingData.IsInQualityAssuranceCommittee,
                        IsLaboratoryEquipmentCommittee = existingData.IsInLabEquipmentCommittee,
                        IsExaminationsOrganizingCommittee = existingData.IsInExamOrganizationCommittee,
                        IsSocialOrSportsActivityCommittees = existingData.IsInSocialOrSportsCommittee
                    };

                    // Map student activity data - CREATE NEW INSTANCE
                    studentActivityData = new StudentActivityDto
                    {
                        IsCompletedStudentActivity = existingData.ParticipatedInSports,
                        IsCompletedSocialActivity = existingData.ParticipatedInSocial,
                        IsCompletedCulturalActivity = existingData.ParticipatedInCultural
                    };

                    Console.WriteLine($"✅ Loaded existing data: {researchPapers.Count} research papers");
                    Console.WriteLine("✅ Administrative data loaded:");
                    Console.WriteLine($"   IsAcademicGuidanceCommittee = {administrativeData.IsAcademicGuidanceCommittee}");
                    Console.WriteLine($"   ISchedulingCommittee = {administrativeData.ISchedulingCommittee}");
                    Console.WriteLine($"   IsQualityWorksCommittee = {administrativeData.IsQualityWorksCommittee}");
                    Console.WriteLine($"   IsLaboratoryEquipmentCommittee = {administrativeData.IsLaboratoryEquipmentCommittee}");
                    Console.WriteLine($"   IsExaminationsOrganizingCommittee = {administrativeData.IsExaminationsOrganizingCommittee}");
                    Console.WriteLine($"   IsSocialOrSportsActivityCommittees = {administrativeData.IsSocialOrSportsActivityCommittees}");
                    Console.WriteLine($"✅ Student Activity: Sport={studentActivityData.IsCompletedStudentActivity}, Social={studentActivityData.IsCompletedSocialActivity}, Cultural={studentActivityData.IsCompletedCulturalActivity}");

                    // Force UI update to pass data to child components
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading existing TA data: {ex.Message}");
        }
    }

    private async Task SubmitAllData()
    {
        Console.WriteLine("=== Starting SubmitAllData ===");

        // Validate all required data
        if (educationalData == null)
        {
            errorMessage = "بيانات النشاط التعليمي مفقودة";
            StateHasChanged();
            return;
        }

        if (administrativeData == null)
        {
            errorMessage = "بيانات النشاط الإداري مفقودة";
            StateHasChanged();
            return;
        }

        if (studentActivityData == null)
        {
            errorMessage = "بيانات النشاط الطلابي مفقودة";
            StateHasChanged();
            return;
        }

        if (educationalData.TeachingData == null)
        {
            errorMessage = "بيانات التدريس مفقودة";
            StateHasChanged();
            return;
        }

        Console.WriteLine("✅ All data present, proceeding with submission...");

        // Map ResearchPapers -> CreateResearchActivityDto
        var researchActivities = researchPapers.Select(p => new CreateResearchActivityDto
        {
            Title = p.Title,
            Journal = p.ConferenceOrJournal,
            Location = p.Location,
            PageCount = p.PageCount,
            ActivityDate = p.Date,
            StatusId = p.Status,
            Url = p.Url
        }).ToList();

        var taSubmission = new CreateTASubmissionDto
        {
            ActualTeachingLoad = educationalData.TeachingData.ActualTeachingLoad,
            ExpectedTeachingLoad = educationalData.TeachingData.ExpectedTeachingLoad,
            HasTechnicalReports = otherActivities.HasTechnicalReportsOrArticles,
            HasSeminarLectures = otherActivities.HasGivenLecturesOrSeminars,
            HasAttendingSeminars = otherActivities.HasAttendedScientificSeminars,
            AdvisedStudentCount = 2,
            ResearchActivities = researchActivities,
            IsInAcademicAdvisingCommittee = administrativeData.IsAcademicGuidanceCommittee,
            IsInSchedulingCommittee = administrativeData.ISchedulingCommittee,
            IsInQualityAssuranceCommittee = administrativeData.IsQualityWorksCommittee,
            IsInLabEquipmentCommittee = administrativeData.IsLaboratoryEquipmentCommittee,
            IsInExamOrganizationCommittee = administrativeData.IsExaminationsOrganizingCommittee,
            IsInSocialOrSportsCommittee = administrativeData.IsSocialOrSportsActivityCommittees,
            ParticipatedInSports = studentActivityData.IsCompletedStudentActivity,
            ParticipatedInSocial = studentActivityData.IsCompletedSocialActivity,
            ParticipatedInCultural = studentActivityData.IsCompletedCulturalActivity
        };

        if (isExistingSubmission)
        {
            var updateData = new UpdateTASubmissionsDto
            {
                ActualTeachingLoad = taSubmission.ActualTeachingLoad,
                ExpectedTeachingLoad = taSubmission.ExpectedTeachingLoad,
                HasTechnicalReports = taSubmission.HasTechnicalReports,
                HasSeminarLectures = taSubmission.HasSeminarLectures,
                HasAttendingSeminars = taSubmission.HasAttendingSeminars,
                AdvisedStudentCount = taSubmission.AdvisedStudentCount,
                ResearchActivities = taSubmission.ResearchActivities,
                IsInAcademicAdvisingCommittee = taSubmission.IsInAcademicAdvisingCommittee,
                IsInSchedulingCommittee = taSubmission.IsInSchedulingCommittee,
                IsInQualityAssuranceCommittee = taSubmission.IsInQualityAssuranceCommittee,
                IsInLabEquipmentCommittee = taSubmission.IsInLabEquipmentCommittee,
                IsInExamOrganizationCommittee = taSubmission.IsInExamOrganizationCommittee,
                IsInSocialOrSportsCommittee = taSubmission.IsInSocialOrSportsCommittee,
                ParticipatedInSports = taSubmission.ParticipatedInSports,
                ParticipatedInSocial = taSubmission.ParticipatedInSocial,
                ParticipatedInCultural = taSubmission.ParticipatedInCultural
            };
            await UpdateSubmission(updateData);
        }
        else
        {
            await CreateSubmission(taSubmission);
        }
    }

    private async Task CreateSubmission(CreateTASubmissionDto data)
    {
        try
        {
            var response = await http.PostAsJsonAsync($"/api/Evaluation/{evaluationId}/SubmitTAFiles", data);

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("✅ Submission created successfully!");

                try
                {
                    var responseContent = await response.Content.ReadAsStringAsync();
                    if (!string.IsNullOrWhiteSpace(responseContent))
                    {
                        var result = JsonDocument.Parse(responseContent);
                        var root = result.RootElement;

                        if (root.TryGetProperty("id", out var idElement))
                        {
                            submissionId = idElement.GetInt32();
                            isExistingSubmission = true;
                            Console.WriteLine($"📋 New submission ID: {submissionId}");
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"ℹ️ Could not extract submission ID: {ex.Message}");
                }

                successMessage = "تم حفظ البيانات بنجاح!";
                errorMessage = null;
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Create submission failed: {error}");
                errorMessage = $"فشل في حفظ البيانات: {error}";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception during create: {ex.Message}");
            errorMessage = $"حدث خطأ أثناء الحفظ: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task UpdateSubmission(UpdateTASubmissionsDto data)
    {
        try
        {
            Console.WriteLine($"🔄 Updating submission ID: {evaluationId}");
            var response = await http.PutAsJsonAsync($"/api/Evaluation/UpdateTASubmission/{evaluationId}", data);

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("✅ Submission updated successfully!");
                successMessage = "تم تحديث البيانات بنجاح!";
                errorMessage = null;
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Update submission failed: {error}");
                errorMessage = $"فشل في تحديث البيانات: {error}";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception during update: {ex.Message}");
            errorMessage = $"حدث خطأ أثناء التحديث: {ex.Message}";
            StateHasChanged();
        }
    }
}