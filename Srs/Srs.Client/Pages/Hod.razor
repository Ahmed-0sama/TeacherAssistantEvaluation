@page "/hod"
@using Shared.Dtos
@using Shared.Dtos.HODEvaluation
@using Shared.Dtos.ProfessorEvaluationDto
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>

<h3 class="text-center mb-4">تقييم رئيس القسم لمساعدي التدريس</h3>

<div class="card shadow-sm" dir="rtl">
    <div class="card-body">
        <h3 class="text-center" style="color:cornflowerblue;">قائمة مساعدي التدريس</h3>
        <hr style="color:cornflowerblue;" />

        <div class="d-flex justify-content-center">
            <div class="w-75 mb-4 shadow-sm">
                @if (isLoading)
                {
                    <p class="text-center">جارٍ تحميل البيانات...</p>
                }
                else if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger text-center">@errorMessage</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-striped text-center align-middle" dir="rtl">
                            <thead class="table-secondary">
                                <tr>
                                    <th>اسم مساعد التدريس</th>
                                    <th>الفترة</th>
                                    <th>الحالة</th>
                                    <th>حالة التقييم</th>
                                    <th>إجراء</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ta in taList)
                                {
                                    <tr>
                                        <td>@ta.Name</td>
                                        <td>@ta.Department</td>
                                        <td>@ta.status</td>
                                        <td>
                                            @if (ta.HasHodEvaluation == true)
                                            {
                                                <span class="badge bg-success">تم التقييم</span>
                                            }
                                            else if (ta.status == "Draft")
                                            {
                                                <span class="badge bg-warning text-dark">بانتظار التقييم</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">غير متاح</span>
                                            }
                                        </td>
                                        <td>
                                            @if (ta.status == "Draft" || ta.HasHodEvaluation == true)
                                            {
                                                <button class="btn btn-sm btn-primary" @onclick="() => OpenModal(ta)">
                                                    @(ta.HasHodEvaluation == true ? "عرض التقييم" : "تقييم")
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-secondary" disabled>غير متاح</button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (showModal)
{
 <div class="modal d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" dir="rtl">
                <div class="modal-header" dir="rtl">
                    <button type="button" class="btn-close ms-0 me-auto" @onclick="CloseModal"></button>
                    <h5 class="modal-title">تفاصيل مساعد التدريس</h5>
                </div>
                <div class="modal-body">
                    @if (isLoadingModal)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جارٍ التحميل...</span>
                            </div>
                            <p class="mt-2">جارٍ تحميل البيانات...</p>
                        </div>
                    }
                    else
                    {
                        <div class="border rounded p-3 bg-light mb-3">
                            <h5 class="mb-3 text-primary">البيانات الأساسية</h5>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">اسم مساعد التدريس</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.Name" />
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">الرقم الوظيفي:</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.EmployeeNumber" />
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">القسم</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.Department" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">القسم</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.College" />
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">الكلية</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.College" />
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">العبئ الدراسي</label>
                                    <input type="text" class="form-control" disabled value="@selectedTA?.EmployeeNumber" />
                                </div>
                            </div>
                        </div>

                        <!-- Evaluation Criteria -->
                        <div class="border rounded p-3 bg-light mb-3">
                            <h5 class="mb-3 text-primary">تقييم النشاط العلمي</h5>
                            <div class="border rounded p-3 bg-light mb-3">
                                <h5 class="mb-3 text-primary">
                                    <i class="bi bi-person-check-fill me-2"></i>
                                    تقييمات أساتذة المقررات
                                </h5>

                                @if (profdto == null || !profdto.Any())
                                {
                                    <div class="alert alert-warning text-center" role="alert">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        لا توجد تقييمات من أساتذة المقررات حتى الآن
                                    </div>
                                }
                                else
                                {
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover align-middle">
                                            <thead class="table-secondary">
                                                <tr>
                                                    <th class="text-center">المقرر</th>
                                                    <th class="text-center">أستاذ المقرر</th>
                                                    <th class="text-center">الساعات المكتبية</th>
                                                    <th class="text-center">الحضور</th>
                                                    <th class="text-center">الأداء</th>
                                                    <th class="text-center">المجموع</th>
                                                    <th class="text-center">الحالة</th>
                                                    <th class="text-center">الملاحظات</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var eval in profdto)
                                                {
                                                    <tr>
                                                        <td>
                                                            <div class="fw-bold">@eval.CourseName</div>
                                                            <small class="text-muted">@eval.CourseCode</small>
                                                        </td>

                                                        <td>@eval.ProfessorName</td>

                                                        <td class="text-center">
                                                            <span class="badge bg-info">@eval.OfficeHoursScore / 10</span>
                                                        </td>

                                                        <td class="text-center">
                                                            <span class="badge bg-info">@eval.AttendanceScore / 5</span>
                                                        </td>

                                                        <td class="text-center">
                                                            <span class="badge bg-info">@eval.PerformanceScore / 15</span>
                                                        </td>

                                                        <td class="text-center">
                                                            <span class="badge bg-primary fs-6">@eval.TotalScore / 30</span>
                                                        </td>

                                                        <td class="text-center">
                                                            @if (eval.IsReturned)
                                                            {
                                                                <span class="badge bg-warning text-dark">
                                                                    <i class="bi bi-arrow-return-right me-1"></i> تم الإرجاع
                                                                </span>
                                                            }
                                                            else if (eval.IsSubmitted)
                                                            {
                                                                <span class="badge bg-success">
                                                                    <i class="bi bi-check-circle me-1"></i> مقدم
                                                                </span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">
                                                                    <i class="bi bi-clock me-1"></i> قيد الانتظار
                                                                </span>
                                                            }
                                                        </td>

                                                        <td class="text-center">
                                                            @eval.Comments
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>

                                            <tfoot class="table-light">
                                                <tr>
                                                    <th colspan="5" class="text-end">المتوسط الإجمالي:</th>
                                                    <th class="text-center">
                                                        <span class="badge bg-success fs-5">@CalculateAverageScore() / 30</span>
                                                    </th>
                                                    <th colspan="2"></th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div class="mt-3 p-3 bg-light rounded shadow-sm">
                                        <h6 class="fw-bold mb-3 text-primary">
                                            <i class="bi bi-book-half me-1"></i>اكتمال ساعات النصاب (10)
                                        </h6>

                                        <div class="row text-center">
                                            <div class="col">
                                                <div class="p-2 bg-white rounded border">
                                                    <i class="bi bi-clock-history fs-4 d-block text-secondary"></i>
                                                    <span class="fw-bold">التدريس المتوقع</span>
                                                    <div>@teachingdto.ExpectedTeachingLoad</div>
                                                </div>
                                            </div>

                                            <div class="col">
                                                <div class="p-2 bg-white rounded border">
                                                    <i class="bi bi-check-circle fs-4 d-block text-success"></i>
                                                    <span class="fw-bold">التدريس الفعلي</span>
                                                    <div>@teachingdto.ActualTeachingLoad</div>
                                                </div>
                                            </div>

                                            <div class="col">
                                                <div class="p-2 bg-white rounded border">
                                                    <i class="bi bi-star-fill fs-4 d-block text-warning"></i>
                                                    <span class="fw-bold">التقييم</span>
                                                    <div>@(teachingdto.gradegiven)/10</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card bg-primary bg-opacity-10 shadow-sm mx-auto mt-4" style="max-width: 600px; border-radius: 12px;">
                                        <div class="card-body text-center py-4">
                                            <h3 class="text-primary fw-semibold mb-2" style="direction: rtl; font-size: 18px;">المجموع الكلي للعبء التدريسي</h3>
                                            <p class="text-primary fw-bold fs-4 mb-0" style="direction: ltr;">@(teachingLoadScore) / 40</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        <Srs.Client.Compontets.TeachingActivitiesEvaluation TeachingLoadScore="@teachingLoadScore"
                                                                            OnRatingsChanged="OnTeachingActivitiesRatingsChanged"
                                                                            IsViewMode="@IsViewMode"
                                                                            ExistingRatings="@GetExistingRatings("DirectTeaching")" />

                        <Srs.Client.Compontets.ScientificActivityComponentForHod EvaluationId="@(selectedTA?.EvaluationId ?? 0)"
                                                                                 EvaluationPeriodId="EvaluationPeriodId"
                                                                                 TaEmployeeId="selectedTA.Id"
                                                                                 OnRatingsChanged="OnScientificActivityRatingsChanged"
                                                                                 IsViewMode="@IsViewMode"
                                                                                 ExistingRatings="@GetExistingRatings("Administrative")" />

                        <Srs.Client.Compontets.GradesComponent OnPersonalTraitsChanged="OnPersonalTraitsRatingsChanged"
                                                               OnStudentActivitiesChanged="OnStudentActivitiesRatingsChanged"
                                                               IsViewMode="@IsViewMode"
                                                               ExistingPersonalTraits="@GetExistingRatings("PersonalTraits")"
                                                               ExistingStudentActivities="@GetExistingRatings("StudentActivities")" />
                        
                        <!-- Comments Section -->
                        <div class="border rounded p-3 bg-light mb-3">
                            <h5 class="mb-3 text-primary">الملاحظات والتعليقات</h5>

                            <div class="mb-3">
                                <label class="form-label fw-bold">نقاط القوة</label>
                                <textarea class="form-control"
                                          rows="3"
                                          @bind="hodStrengths"
                                          disabled="@IsViewMode"
                                          placeholder="اذكر نقاط القوة لمساعد التدريس..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">نقاط الضعف</label>
                                <textarea class="form-control"
                                          rows="3"
                                          @bind="hodWeaknesses"
                                          disabled="@IsViewMode"
                                          placeholder="اذكر نقاط الضعف ومجالات التحسين..."></textarea>
                            </div>
                        </div>

                        <!-- Score Summary -->
                        @if (IsViewMode && hodEvaluationData != null)
                        {
                            <div class="alert alert-info">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fs-5 fw-bold">المجموع الكلي:</span>
                                    <span class="fs-3 fw-bold text-primary">@hodEvaluationData.TotalScore / @hodEvaluationData.MaxScore</span>
                                </div>
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    @if (IsViewMode)
                    {
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">إغلاق</button>
                    }
                    else if (!isLoadingModal)
                    {
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">إلغاء</button>
                        <button type="button" class="btn btn-primary"
                                @onclick="SaveEvaluation"
                                disabled="@isSaving">
                            @(isSaving ? "جارٍ الحفظ..." : "حفظ التقييم")
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<UserDataDto> taList = new();
    private bool isLoading = true;
    private string errorMessage = string.Empty;
    private bool showModal = false;
    private bool isLoadingModal = false;
    private bool isSaving = false;
    private UserDataDto? selectedTA;
    private TeachingDataDto teachingdto = new TeachingDataDto();
    private const int EvaluationPeriodId = 1; // Example period ID
    
    // Dictionaries to hold ratings for different criteria
    private Dictionary<int, int> teachingActivitiesRatings = new();
    private Dictionary<int, int> scientificActivityRatings = new();
    private Dictionary<int, int> personalTraitsRatings = new();
    private Dictionary<int, int> studentActivitiesRatings = new();
    
    // Evaluation data
    private List<HodCriterionDto> criteria = new();
    private List<RatingDto> ratings = new();
    private Dictionary<int, int> selectedRatings = new();
    private string hodStrengths = string.Empty;
    private string hodWeaknesses = string.Empty;
    private HodEvaluationResponseDto? hodEvaluationData;
    private MastersDto mastersDto = new MastersDto();
    private List<ProfessorEvaluationResponseDto> profdto = new List<ProfessorEvaluationResponseDto>();

    // View mode determined by whether evaluation data was successfully loaded
    private const bool IsViewMode=false;
    
    private bool showDetailsModal = false;
    private ProfessorEvaluationResponseDto? selectedEvaluation;
    double teachingLoadScore => (CalculateAverageScore()) + (teachingdto.gradegiven ?? 0);

    private void OnTeachingActivitiesRatingsChanged(Dictionary<int, int> ratings)
    {
        teachingActivitiesRatings = ratings;
    }

    private void OnScientificActivityRatingsChanged(Dictionary<int, int> ratings)
    {
        scientificActivityRatings = ratings;
    }

    private void OnPersonalTraitsRatingsChanged(Dictionary<int, int> ratings)
    {
        personalTraitsRatings = ratings;
    }

    private void OnStudentActivitiesRatingsChanged(Dictionary<int, int> ratings)
    {
        studentActivitiesRatings = ratings;
    }

    private Dictionary<int, int> GetExistingRatings(string criterionType)
    {
        if (hodEvaluationData?.Evaluations == null)
            return new Dictionary<int, int>();

        return hodEvaluationData.Evaluations
            .Where(e => e.CriterionType == criterionType)
            .ToDictionary(e => e.CriterionId, e => e.RatingId);
    }

    private int CalculateAverageScore()
    {
        if (profdto == null || !profdto.Any())
            return 0;

        var average = profdto.Average(e => e.TotalScore);
        return (int)Math.Round(average);
    }
    
    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            // Load evaluations from API
            var evaluations = await Http.GetFromJsonAsync<List<EvaluationApiResponseDto>>("api/evaluation/period/1")
                ?? new List<EvaluationApiResponseDto>();

            // Check which evaluations have HOD evaluations
            var hodEvaluationIds = new HashSet<int>();
            try
            {
                var hodEvaluations = await Http.GetFromJsonAsync<List<HodEvaluationResponseDto>>("api/HodEvaluation/GetHodEvaluationByPeriod/1")
                    ?? new List<HodEvaluationResponseDto>();

                hodEvaluationIds = hodEvaluations
                    .Where(h => h.Evaluations != null && h.Evaluations.Any())
                    .Select(h => h.EvaluationId)
                    .ToHashSet();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Warning: Could not load HOD evaluations: {ex.Message}");
            }

            // Map API response to UserDataDto
            taList = evaluations.Select(e => new UserDataDto
            {
                Name = $"TA #{e.taEmployeeId}",
                Department = e.periodName,
                EmployeeNumber = e.taEmployeeId,
                status = e.statusName,
                EvaluationId = e.evaluationId,
                HasHodEvaluation = hodEvaluationIds.Contains(e.evaluationId)
            }).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء تحميل البيانات: {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OpenModal(UserDataDto ta)
    {
        selectedTA = ta;
        selectedTA.Id = ta.EmployeeNumber;
        showModal = true;
        isLoadingModal = true;

        // Reset data
        selectedRatings.Clear();
        hodStrengths = string.Empty;
        hodWeaknesses = string.Empty;
        hodEvaluationData = null;
        profdto = new List<ProfessorEvaluationResponseDto>();
        teachingActivitiesRatings.Clear();
        scientificActivityRatings.Clear();
        personalTraitsRatings.Clear();
        studentActivitiesRatings.Clear();

        try
        {
            // Load professor evaluations
            try
            {
                var profEvaluations = await Http.GetFromJsonAsync<List<ProfessorEvaluationResponseDto>>(
                    $"api/ProfessorEvaluation/GetByPeriodAndTA/{EvaluationPeriodId}/{selectedTA.Id}");

                if (profEvaluations != null)
                {
                    profdto = profEvaluations;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading professor evaluations: {ex.Message}");
            }

            // Load teaching data
            if (ta.EvaluationId != 0)
            {
                // TODO: Replace with actual API call
                teachingdto = new TeachingDataDto
                {
                    ActualTeachingLoad = 12,
                    ExpectedTeachingLoad = 10,
                    ClassCount = 3,
                    gradegiven = 8
                };
            }

            // Try to load existing HOD evaluation
            try
            {
                var response = await Http.GetAsync($"api/HodEvaluation/HodEvaluationByEvaluationId/{ta.EvaluationId}");

                if (response.IsSuccessStatusCode)
                {
                    hodEvaluationData = await response.Content.ReadFromJsonAsync<HodEvaluationResponseDto>();

                    if (hodEvaluationData != null && hodEvaluationData.Evaluations?.Any() == true)
                    {
                        hodStrengths = hodEvaluationData.HodStrengths ?? string.Empty;
                        hodWeaknesses = hodEvaluationData.HodWeaknesses ?? string.Empty;

                        // Populate selected ratings
                        foreach (var eval in hodEvaluationData.Evaluations)
                        {
                            if (eval.RatingId > 0)
                            {
                                selectedRatings[eval.CriterionId] = eval.RatingId;
                            }
                        }

                        Console.WriteLine($"✅ Loaded existing HOD evaluation in VIEW MODE");
                    }
                }
                else if (response.StatusCode != System.Net.HttpStatusCode.NotFound)
                {
                    Console.WriteLine($"Warning: Unexpected status code {response.StatusCode} when loading HOD evaluation");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading HOD evaluation: {ex.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OpenModal: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ: {ex.Message}");
        }
        finally
        {
            isLoadingModal = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        selectedTA = null;
        selectedRatings.Clear();
        hodStrengths = string.Empty;
        hodWeaknesses = string.Empty;
        hodEvaluationData = null;
        teachingActivitiesRatings.Clear();
        scientificActivityRatings.Clear();
        personalTraitsRatings.Clear();
        studentActivitiesRatings.Clear();
    }

    private async Task SaveEvaluation()
    {
        if (selectedTA == null) return;

        isSaving = true;

        try
        {
            // Combine all ratings from different sections
            var allRatings = new Dictionary<int, int>();

            foreach (var rating in teachingActivitiesRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in scientificActivityRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in personalTraitsRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in studentActivitiesRatings)
                allRatings[rating.Key] = rating.Value;

            if (allRatings.Count == 0)
            {
                await JS.InvokeVoidAsync("alert", "الرجاء تقييم المعايير المطلوبة");
                return;
            }

            var criterionRatings = allRatings.Select(kvp => new CriterionRatingDto
            {
                CriterionId = kvp.Key,
                RatingId = kvp.Value
            }).ToList();

            if (IsViewMode && hodEvaluationData != null)
            {
                // Update existing evaluation
                var updateDto = new UpdateHodEvaluationDto
                {
                    CriterionRatings = criterionRatings,
                    HodStrengths = hodStrengths,
                    HodWeaknesses = hodWeaknesses
                };

                var response = await Http.PutAsJsonAsync(
                    $"api/HodEvaluation/UpdateHodEvaluation/{selectedTA.EvaluationId}",
                    updateDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم تحديث التقييم بنجاح");
                    CloseModal();
                    await OnInitializedAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"فشل تحديث التقييم: {error}");
                }
            }
            else
            {
                // Create new evaluation
                var createDto = new CreateHodEvaluationDto
                {
                    EvaluationId = selectedTA.EvaluationId,
                    CriterionRatings = criterionRatings,
                    HodStrengths = hodStrengths,
                    HodWeaknesses = hodWeaknesses
                };

                var response = await Http.PostAsJsonAsync("api/HodEvaluation/create", createDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم حفظ التقييم بنجاح");
                    CloseModal();
                    await OnInitializedAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"فشل حفظ التقييم: {error}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving evaluation: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ أثناء الحفظ: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
}