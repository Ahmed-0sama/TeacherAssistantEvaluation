@page "/hod"
@using Shared.Dtos
@using Shared.Dtos.EvaluationPeriod
@using Shared.Dtos.HODEvaluation
@using Shared.Dtos.ProfessorEvaluationDto
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>

<h3 class="text-center mb-4">تقييم رئيس القسم لمساعدي التدريس</h3>

<div class="card shadow-sm" dir="rtl">
    <div class="card-body">
        <h3 class="text-center" style="color:cornflowerblue;">قائمة مساعدي التدريس</h3>
        <hr style="color:cornflowerblue;" />

        <div class="d-flex justify-content-center">
            <div class="w-75 mb-4 shadow-sm">
                @if (isLoading)
                {
                    <p class="text-center">جارٍ تحميل البيانات...</p>
                }
                else if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger text-center">@errorMessage</div>
                }
                else
                {
                    
                    @* notification component need to be fixed later 
                        <div class="position-fixed top-0 start-0 m-3" style="z-index: 1050;">
                        <Srs.Client.Compontets.NotificationComponent EmployeeId="@userData.Id.ToString()" />
                    </div> *@
                    <div class="table-responsive">
                        <table class="table table-hover table-striped text-center align-middle" dir="rtl">
                            <thead class="table-secondary">
                                <tr>
                                    <th>اسم مساعد التدريس</th>
                                    <th>الفترة</th>
                                    <th>حالة التقييم</th>
                                    <th>إجراء</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ta in taList)
                                {
                                    <tr>
                                        <td>@ta.employeeName</td>
                                        <td>@ta.Department</td>
                                        <td>
                                            @if (ta.statusid == 0)
                                            {
                                                <span class="badge bg-secondary">انتظار تقديم التقييم</span>

                                            }
                                            else if (ta.statusid == 1)
                                            {
                                                <!-- TA created evaluation but hasn't submitted -->
                                                <span class="badge bg-secondary">انتظار المدخلات</span>
                                            }
                                            else if (ta.statusid == 2)
                                            {
                                                <!-- TA submitted, waiting for HOD -->
                                                <span class="badge bg-warning text-dark">بانتظار التقييم</span>
                                            }
                                            else if (ta.statusid == 3 || ta.statusid == 4)
                                            {
                                                <!-- Returned to TA or Professor -->
                                                <span class="badge bg-danger">تم الارجاع</span>
                                            }
                                            else if (ta.statusid == 5)
                                            {
                                                <!-- HOD completed evaluation -->
                                                <span class="badge bg-success">تم التقييم</span>
                                            }
                                            else if (ta.statusid == 6)
                                            {
                                                <!-- Dean approved -->
                                                <span class="badge bg-success">تم قبول التقييم من العميد</span>
                                            }
                                            else if (ta.statusid == 7)
                                            {
                                                <!-- Returned by Dean -->
                                                <span class="badge bg-danger">مرتجع من العميد</span>
                                            }
                                        </td>
                                        <td>
                                            @if (ta.statusid == 0 || ta.statusid == 1)
                                            {
                                                <!-- ✅ Disabled button if TA hasn't submitted -->
                                                <button class="btn btn-sm btn-secondary" disabled>
                                                    <i class="bi bi-hourglass-split me-1"></i>
                                                    انتظار

                                                </button>
                                               <Srs.Client.Compontets.ReminderComponent EmployeeId="professorEmployeeId"
                                                                                         RecieverId="ta.employeeId"
                                                                                         RenderAsButton="true"/>
                                            }
                                            else if (ta.statusid == 5 || ta.statusid == 6 || ta.statusid == 3 || ta.statusid == 4)
                                            {
                                                <!-- View button for completed or returned evaluations -->
                                                <button class="btn btn-sm btn-info" @onclick="() => OpenModal(ta)">
                                                    <i class="bi bi-eye me-1"></i>
                                                    عرض التقييم
                                                </button>
                                            }
                                            else if (ta.statusid == 7)
                                            {
                                                <!-- Edit button for Dean-returned evaluations -->
                                                <button class="btn btn-sm btn-warning" @onclick="() => OpenModal(ta)">
                                                    <i class="bi bi-pencil-square me-1"></i>
                                                    اعادة التقييم
                                                </button>
                                            }
                                            else if (ta.statusid == 2)
                                            {
                                                <!-- Evaluate button for submitted evaluations -->
                                                <button class="btn btn-sm btn-primary" @onclick="() => OpenModal(ta)">
                                                    <i class="bi bi-pencil-square me-1"></i>
                                                    تقييم
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (showModal && selectedTA != null)
{
    <Srs.Client.Compontets.HODComponent 
        SelectedTA="@selectedTA"
        EvaluationPeriodId="@EvaluationPeriodId"
        IsViewMode="@isViewMode"
        OnClose="@CloseModal"
        OnSaveSuccess="@HandleSaveSuccess" />
}
@code {
    private List<UserDataDto> taList = new();
    private bool isLoading = true;
    private string errorMessage = string.Empty;
    private bool showModal = false;
    private UserDataDto? selectedTA;
    private bool isViewMode = false;
    private int EvaluationPeriodId;
    private int professorEmployeeId = 1251;
    
    protected override async Task OnInitializedAsync()
    {
        await GetEvaluationPeriod();
        await LoadTAList();
    }
    private async Task GetEvaluationPeriod()
    {
        try
        {
            var response = await Http.GetAsync($"api/EvaluationPeriod/GetActiveEvaluationPeriod");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GetEvaluationPeriodDto>();
                EvaluationPeriodId = result.PeriodId;
                Console.WriteLine($"evaluationPeriod retrieved{EvaluationPeriodId}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"لا توجد فترة تقييم حاليا {ex.Message}";
            Console.WriteLine($"No Active EvaluationPeriod  {ex.Message}");
        }
    }

    private async Task LoadTAList()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            Console.WriteLine("📡 Loading HOD page data...");

            if (EvaluationPeriodId == 0)
            {
                errorMessage = "لا توجد فترة تقييم نشطة حالياً";
                return;
            }

            var startDate = "2025-01-01"; // TODO: Get from evaluation period

            var url = $"/api/HodEvaluation/GetTAsForHOD?periodId={EvaluationPeriodId}&hodDepartmentId={professorEmployeeId}&startDate={startDate}";

            Console.WriteLine($" Calling: {url}");

            var response = await Http.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                throw new Exception($"Failed to load TAs: {error}");
            }

            taList = await response.Content.ReadFromJsonAsync<List<UserDataDto>>()
                ?? new List<UserDataDto>();

            Console.WriteLine($" Loaded {taList.Count} TAs for HOD");

            if (!taList.Any())
            {
                errorMessage = "لا يوجد مساعدي تدريس قدموا تقييماتهم بعد";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء تحميل البيانات: {ex.Message}";
            Console.WriteLine($" Error: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    private void OpenModal(UserDataDto ta)
    {
        selectedTA = ta;
        isViewMode = ta.statusid==5||ta.statusid==6||ta.statusid==3||ta.statusid==4||ta.statusid==1;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        selectedTA = null;
    }

    private async Task HandleSaveSuccess()
    {
        showModal = false;
        selectedTA = null;
        await LoadTAList(); // Refresh the list
    }
}