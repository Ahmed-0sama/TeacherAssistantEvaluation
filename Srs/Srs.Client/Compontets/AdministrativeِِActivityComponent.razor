@using Shared.Dtos
@inject HttpClient Http

<HeadContent>
    <link href="./Custom-Rtl.css" rel="stylesheet" />
</HeadContent>

<div class="card shadow-sm w-100" dir="rtl">
    <div class="card-body">
        <h3 style="color:cornflowerblue">ثالثا: النشاط الاداري</h3>
        <hr style="color:cornflowerblue" />
        <div class="row g-3 mt-3" dir="rtl">
            <div class="col-md-6 col-12">
                <div class="form-check form-check-rtl">
                    <input type="checkbox"
                           class="form-check-input"
                           id="IsAcademicGuidanceCommittee"
                           checked="@AdminstrativeActivityDto.IsAcademicGuidanceCommittee"
                           disabled="@IsReadOnly"
                           @onchange="@((e) => UpdateCheckbox(nameof(AdminstrativeActivityDto.IsAcademicGuidanceCommittee), e))" />
                    <label class="form-check-label" for="IsAcademicGuidanceCommittee">
                        لجنة الارشاد الاكاديمي
                    </label>
                </div>
            </div>
            <div class="col-md-6 col-12">
                <div class="form-check form-check-rtl">
                    <input type="checkbox"
                           class="form-check-input"
                           id="ISchedulingCommittee"
                           checked="@AdminstrativeActivityDto.ISchedulingCommittee"
                           disabled="@IsReadOnly"
                           @onchange="@((e) => UpdateCheckbox(nameof(AdminstrativeActivityDto.ISchedulingCommittee), e))" />
                    <label class="form-check-label" for="ISchedulingCommittee">
                        لجنة الجدولة
                    </label>
                </div>
            </div>
        </div>
        <div class="row g-3" dir="rtl">
            <div class="col-md-6 col-12">
                <div class="form-check form-check-rtl">
                    <input type="checkbox"
                           class="form-check-input"
                           id="IsQualityWorksCommittee"
                           checked="@AdminstrativeActivityDto.IsQualityWorksCommittee"
                           disabled="@IsReadOnly"
                           @onchange="@((e) => UpdateCheckbox(nameof(AdminstrativeActivityDto.IsQualityWorksCommittee), e))" />
                    <label class="form-check-label" for="IsQualityWorksCommittee">
                        لجنة اعمال الجودة
                    </label>
                </div>
            </div>
            <div class="col-md-6 col-12">
                <div class="form-check form-check-rtl">
                    <input type="checkbox"
                           class="form-check-input"
                           id="IsLaboratoryEquipmentCommittee"
                           checked="@AdminstrativeActivityDto.IsLaboratoryEquipmentCommittee"
                           disabled="@IsReadOnly"
                           @onchange="@((e) => UpdateCheckbox(nameof(AdminstrativeActivityDto.IsLaboratoryEquipmentCommittee), e))" />
                    <label class="form-check-label" for="IsLaboratoryEquipmentCommittee">
                        لجنة التجهيزات المعملية
                    </label>
                </div>
            </div>
        </div>
        <div class="row g-3" dir="rtl">
            <div class="col-md-6 col-12">
                <div class="form-check form-check-rtl">
                    <input type="checkbox"
                           class="form-check-input"
                           id="IsExaminationsOrganizingCommittee"
                           checked="@AdminstrativeActivityDto.IsExaminationsOrganizingCommittee"
                           disabled="@IsReadOnly"
                           @onchange="@((e) => UpdateCheckbox(nameof(AdminstrativeActivityDto.IsExaminationsOrganizingCommittee), e))" />
                    <label class="form-check-label" for="IsExaminationsOrganizingCommittee">
                        لجنة تنظيم الامتحانات
                    </label>
                </div>
            </div>
            <div class="col-md-6 col-12">
                <div class="form-check form-check-rtl">
                    <input type="checkbox"
                           class="form-check-input"
                           id="IsSocialOrSportsActivityCommittees"
                           checked="@AdminstrativeActivityDto.IsSocialOrSportsActivityCommittees"
                           disabled="@IsReadOnly"
                           @onchange="@((e) => UpdateCheckbox(nameof(AdminstrativeActivityDto.IsSocialOrSportsActivityCommittees), e))" />
                    <label class="form-check-label" for="IsSocialOrSportsActivityCommittees">
                        لجان النشاط الاجتماعي او الرياضي
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private AdminstrativeActivityDto AdminstrativeActivityDto = new AdminstrativeActivityDto();
    private bool isInitialized = false;

    [Parameter]
    public AdminstrativeActivityDto? InitialData { get; set; }
    [Parameter]
    public bool IsReadOnly { get; set; } 

    [Parameter]
    public EventCallback<AdminstrativeActivityDto> OnActivityLoaded { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        // Only load data once to prevent overwriting
        if (InitialData != null && !isInitialized)
        {
            Console.WriteLine("=== AdministrativeComponent OnParametersSetAsync (FIRST TIME) ===");
            Console.WriteLine($"📥 Received InitialData:");
            Console.WriteLine($"   IsAcademicGuidanceCommittee = {InitialData.IsAcademicGuidanceCommittee}");
            Console.WriteLine($"   ISchedulingCommittee = {InitialData.ISchedulingCommittee}");
            Console.WriteLine($"   IsQualityWorksCommittee = {InitialData.IsQualityWorksCommittee}");
            Console.WriteLine($"   IsLaboratoryEquipmentCommittee = {InitialData.IsLaboratoryEquipmentCommittee}");
            Console.WriteLine($"   IsExaminationsOrganizingCommittee = {InitialData.IsExaminationsOrganizingCommittee}");
            Console.WriteLine($"   IsSocialOrSportsActivityCommittees = {InitialData.IsSocialOrSportsActivityCommittees}");

            // Create NEW instance with copied values
            AdminstrativeActivityDto = new AdminstrativeActivityDto
            {
                IsAcademicGuidanceCommittee = InitialData.IsAcademicGuidanceCommittee,
                ISchedulingCommittee = InitialData.ISchedulingCommittee,
                IsQualityWorksCommittee = InitialData.IsQualityWorksCommittee,
                IsLaboratoryEquipmentCommittee = InitialData.IsLaboratoryEquipmentCommittee,
                IsExaminationsOrganizingCommittee = InitialData.IsExaminationsOrganizingCommittee,
                IsSocialOrSportsActivityCommittees = InitialData.IsSocialOrSportsActivityCommittees
            };

            isInitialized = true;
            Console.WriteLine("✅ Data copied to local instance and marked as initialized");

            // Force UI update
            await InvokeAsync(StateHasChanged);
        }
        else if (InitialData != null && isInitialized)
        {
            Console.WriteLine("⏭️ Skipping OnParametersSetAsync - already initialized");
        }
    }

    private async Task UpdateCheckbox(string propertyName, ChangeEventArgs e)
    {
        bool isChecked = (bool)(e.Value ?? false);

        Console.WriteLine($"🔄 Checkbox changed: {propertyName} = {isChecked}");

        // Update the property
        switch (propertyName)
        {
            case nameof(AdminstrativeActivityDto.IsAcademicGuidanceCommittee):
                AdminstrativeActivityDto.IsAcademicGuidanceCommittee = isChecked;
                break;
            case nameof(AdminstrativeActivityDto.ISchedulingCommittee):
                AdminstrativeActivityDto.ISchedulingCommittee = isChecked;
                break;
            case nameof(AdminstrativeActivityDto.IsQualityWorksCommittee):
                AdminstrativeActivityDto.IsQualityWorksCommittee = isChecked;
                break;
            case nameof(AdminstrativeActivityDto.IsLaboratoryEquipmentCommittee):
                AdminstrativeActivityDto.IsLaboratoryEquipmentCommittee = isChecked;
                break;
            case nameof(AdminstrativeActivityDto.IsExaminationsOrganizingCommittee):
                AdminstrativeActivityDto.IsExaminationsOrganizingCommittee = isChecked;
                break;
            case nameof(AdminstrativeActivityDto.IsSocialOrSportsActivityCommittees):
                AdminstrativeActivityDto.IsSocialOrSportsActivityCommittees = isChecked;
                break;
        }

        // Send updated data to parent
        await OnActivityLoaded.InvokeAsync(AdminstrativeActivityDto);
        StateHasChanged();
    }
}