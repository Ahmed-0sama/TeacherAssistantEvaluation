@using Shared.Dtos.DeanDto
@using Shared.Dtos.HODEvaluation
@using Shared.Dtos.Notifications
@using Shared.Dtos.ProfessorEvaluationDto
@inject HttpClient Http
@inject IJSRuntime JS

<div class="modal-container modal-container-xl">
<div class="modal-overlay" @onclick="HandleClose">
    <div class="modal-container modal-container-xl" @onclick:stopPropagation="true">
        <div class="modal-header" dir="rtl">
            <h5 class="modal-title">تفاصيل مساعد التدريس</h5>
            <button type="button" class="btn-close btn-close-white ms-0 me-auto" @onclick="HandleClose"></button>
        </div>
        <div class="modal-body" id="pdfArea">
            @if (isLoadingModal)
            {
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جارٍ التحميل...</span>
                    </div>
                    <p class="mt-2">جارٍ تحميل البيانات...</p>
                </div>
            }
            else
            {
                    @if (hodEvaluationData?.Evaluations?.Any(e => e.SourceRole == "Dean") == true)
                    {
                        <div class="alert alert-warning" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <div>
                                    <strong>تنبيه:</strong> تم تعديل بعض المعايير من قبل عميد الكلية.
                                    المعايير المعدلة محددة باللون الأصفر ولا يمكن تعديلها.
                                </div>
                            </div>
                        </div>
                    }
                <div class="border rounded p-3 bg-light mb-3">

                    <h5 class="mb-3 text-primary">البيانات الأساسية</h5>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">اسم مساعد التدريس</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.employeeName" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">الرقم الوظيفي:</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.EmployeeNumber" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">القسم</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.Department" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">القسم</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.college" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">الكلية</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.college" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">العبئ الدراسي</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.EmployeeNumber" />
                        </div>
                    </div>
                </div>
                    @if (SelectedTA.statusid == 1||SelectedTA.statusid==0)
                    {
                        <ReminderComponent Name="مساعد التدريس"
                                           EvaluationId="SelectedTA.EvaluationId"
                                           EmployeeId="selectedProfessorId"
                                           RecieverId="SelectedTA.employeeId"                   />
                    }
                    @if (SelectedTA.statusid == 7)
                    {
                        <div class="alert alert-danger" role="alert">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>سبب رفض الاعتماد
                                </label>
                                <div class="form-control bg-light" readonly style="min-height: 60px;">
                                    @DeanComments
                                </div>
                                <input type="hidden" value="@(DeanComments)" />
                            </div>
                        </div>
                    }
                <!-- Professor Evaluations -->
                <div class="border rounded p-3 bg-light mb-3">
                    <h5 class="mb-3 text-primary">تقييم النشاط العلمي</h5>
                    <div class="border rounded p-3 bg-light mb-3">
                        <h5 class="mb-3 text-primary">
                            <i class="bi bi-person-check-fill me-2"></i>
                            تقييمات أساتذة المقررات
                        </h5>

                        @if (profdto == null || !profdto.Any())
                        {
                            <div class="alert alert-warning text-center" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                لا توجد تقييمات من أساتذة المقررات حتى الآن
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover align-middle">
                                    <thead class="table-secondary">
                                        <tr>
                                            <th class="text-center">المقرر</th>
                                            <th class="text-center">أستاذ المقرر</th>
                                            <th class="text-center">الفصل الدراسي</th>
                                            <th class="text-center">الساعات المكتبية</th>
                                            <th class="text-center">الحضور</th>
                                            <th class="text-center">الأداء</th>
                                            <th class="text-center">المجموع</th>
                                            <th class="text-center">الحالة</th>
                                            <th class="text-center">الملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var eval in profdto)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="fw-bold">@eval.CourseName</div>
                                                    <small class="text-muted">@eval.CourseCode</small>
                                                </td>
                                                <td>@eval.ProfessorName</td>
                                                <td class="text-center">
                                                    <span class="badge bg-info">@eval.SemesterName</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-info">@eval.OfficeHoursScore / 10</span>
                                                </td>

                                                <td class="text-center">
                                                    <span class="badge bg-info">@eval.AttendanceScore / 5</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-info">@eval.PerformanceScore / 15</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary fs-6">@eval.TotalScore / 30</span>
                                                </td>
                                                <td class="text-center">
                                                    @if (eval.IsReturned)
                                                    {
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="bi bi-arrow-return-right me-1"></i> تم الإرجاع
                                                        </span>
                                                    }
                                                    else if (eval.IsSubmitted)
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle me-1"></i> مقدم
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">
                                                            <i class="bi bi-clock me-1"></i> قيد الانتظار
                                                        </span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    @eval.Comments
                                                </td>
                                            </tr>
                                            }
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <th colspan="5" class="text-end">المتوسط الإجمالي:</th>
                                            <th class="text-center">
                                                <span class="badge bg-success fs-5">@CalculateAverageScore() / 30</span>
                                            </th>
                                            <th colspan="2"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                                <div class="mt-3 p-3 bg-light rounded shadow-sm">
                                    <h6 class="fw-bold mb-3 text-primary">
                                        <i class="bi bi-book-half me-1"></i>اكتمال ساعات النصاب
                                    </h6>

                                    @if (semesterTeachingLoads.Any())
                                    {
                                        <div class="row g-3">
                                            @foreach (var semester in semesterTeachingLoads)
                                            {
                                                <div class="col-md-6">
                                                    <div class="card border-@(semester.score == 10 ? "success" : "danger")">
                                                        <div class="card-header bg-@(semester.score == 10 ? "success" : "danger") bg-opacity-10">
                                                            <h6 class="mb-0 fw-bold">@semester.semesterName</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row text-center">
                                                                <div class="col-4">
                                                                    <div class="p-2">
                                                                        <i class="bi bi-clock-history fs-4 d-block text-secondary"></i>
                                                                        <span class="fw-bold d-block">المتوقع</span>
                                                                        <span class="fs-5">@semester.ExpectedTeachingLoad</span>
                                                                    </div>
                                                                </div>
                                                                <div class="col-4">
                                                                    <div class="p-2">
                                                                        <i class="bi bi-check-circle fs-4 d-block text-@(semester.score == 10 ? "success" : "danger")"></i>
                                                                        <span class="fw-bold d-block">الفعلي</span>
                                                                        <span class="fs-5">@semester.ActualTeachingLoad</span>
                                                                    </div>
                                                                </div>
                                                                <div class="col-4">
                                                                    <div class="p-2">
                                                                        <i class="bi bi-star-fill fs-4 d-block text-warning"></i>
                                                                        <span class="fw-bold d-block">الدرجة</span>
                                                                        <span class="badge bg-@(semester.score == 10 ? "success" : "danger") fs-6">
                                                                            @semester.score / 10
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <!-- Average Score Display -->
                                        <div class="card bg-primary bg-opacity-10 shadow-sm mt-3">
                                            <div class="card-body text-center py-3">
                                                <h6 class="text-primary fw-semibold mb-2">متوسط درجة اكتمال النصاب</h6>
                                                <p class="text-primary fw-bold fs-4 mb-0">
                                                    @AverageTeachingLoadGrade().ToString("F2") / 10
                                                </p>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning mb-0">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            لا توجد بيانات عبء تدريسي متاحة
                                        </div>
                                    }
                                </div>

                                <div class="card bg-primary bg-opacity-10 shadow-sm mx-auto mt-4" style="max-width: 600px; border-radius: 12px;">
                                    <div class="card-body text-center py-4">
                                        <h3 class="text-primary fw-semibold mb-2" style="direction: rtl; font-size: 18px;">المجموع الكلي للعبء التدريسي</h3>
                                        <p class="text-primary fw-bold fs-4 mb-0" style="direction: ltr;">
                                            @(TotalTeachingLoad.ToString("F2")) / 40
                                        </p>
                                        <small class="text-muted d-block mt-2">
                                            تقييم الأساتذة: @CalculateAverageScore() +
                                            متوسط النصاب: @AverageTeachingLoadGrade().ToString("F2")
                                        </small>
                                    </div>
                                </div>
                        }
                    </div>
                        @if (professorsNeedingReminder.Any())
                        {
                            <div class="alert alert-warning mt-3" role="alert">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        <strong>تنبيه:</strong> لم يقم بعض الأساتذة بتقديم تقييماتهم بعد
                                    </div>
                                    <button class="btn btn-sm btn-warning" @onclick="ShowProfessorsReminderModal">
                                        <i class="bi bi-bell me-1"></i>
                                        إرسال تذكير (@professorsNeedingReminder.Count)
                                    </button>
                                </div>
                            </div>
                        }
                </div>

                <!-- Child Components -->
                    <Srs.Client.Compontets.TeachingActivitiesEvaluation TeachingLoadScore="@TotalTeachingLoad"
                                                                        OnRatingsChanged="OnTeachingActivitiesRatingsChanged"
                                                                        IsViewMode="@IsViewMode"
                                                                        IsDeanUser="@IsDeanUser"
                                                                        ExistingRatings="@GetExistingRatings("DirectTeaching")"
                                                                        CriterionSources="@GetCriterionSources("DirectTeaching")" />

                    <Srs.Client.Compontets.ScientificActivityComponentForHod EvaluationId="@(SelectedTA?.EvaluationId ?? 0)"
                                                                             EvaluationPeriodId="EvaluationPeriodId"
                                                                             TaEmployeeId="SelectedTA.employeeId"
                                                                             OnRatingsChanged="OnScientificActivityRatingsChanged"
                                                                             OnScientificTotalChanged="OnScientificTotalReceived"
                                                                             IsViewMode="@IsViewMode"
                                                                             ExistingRatings="@GetAdministrativeRatings()"
                                                                             OnVpgsDataAvailabilityChanged="OnVpgsDataAvailabilityChanged"
                                                                             OnGsdeanDataAvailabilityChanged="OnGsdeabDataAvailabilityChanged"
                                                                             CriterionSources="@GetCriterionSources("Administrative")" />

                    <Srs.Client.Compontets.GradesComponent OnPersonalTraitsChanged="OnPersonalTraitsRatingsChanged"
                                                           OnStudentActivitiesChanged="OnStudentActivitiesRatingsChanged"
                                                           IsViewMode="@IsViewMode"
                                                           IsDeanUser="@IsDeanUser"
                                                           ExistingPersonalTraits="@GetExistingRatings("PersonalTraits")"
                                                           ExistingStudentActivities="@GetExistingRatings("StudentActivities")"
                                                           PersonalTraitsSources="@GetCriterionSources("PersonalTraits")"
                                                           StudentActivitiesSources="@GetCriterionSources("StudentActivities")" />

                <div class="card bg-success bg-opacity-10 shadow-lg mx-auto mt-4 mb-4" style="max-width: 900px;">
                    <div class="card-body text-center py-5">
                        <h4 class="text-success fw-bold mb-3">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            المجموع الكلي النهائي
                        </h4>
                        <div class="row justify-content-center">
                            <div class="col-auto">
                                <div class="bg-white rounded-3 p-4 shadow-sm">
                                    <p class="text-success fw-bold fs-1 mb-0" style="direction: ltr;">
                                        @CalculateFinalTotal() / 100
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- تفصيل الدرجات -->
                        <div class="mt-4">
                            <div class="row text-center g-3">
                                <div class="col-md-2">
                                    <small class="text-muted d-block">العبء التدريسي</small>
                                    <span class="badge bg-light text-dark">@(teachingLoadScore) / 50</span>
                                    <div class="mt-1" style="font-size: 0.7rem;">
                                        <small class="text-muted d-block">تقييم الأساتذة: @CalculateAverageScore()</small>
                                            <small class="text-muted d-block">اكتمال النصاب: @teachingLoadGrade(teachingdto.ActualTeachingLoad,teachingdto.ExpectedTeachingLoad)</small>
                                        <small class="text-muted d-block">الأنشطة التعليمية: @GetTeachingActivitiesTotal()</small>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">النشاط العلمي</small>
                                    <span class="badge bg-light text-dark">@GetScientificTotal() / 10</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">النشاط الإداري</small>
                                    <span class="badge bg-light text-dark">@GetAdministrativeTotal() / 10</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">الأنشطة الطلابية</small>
                                    <span class="badge bg-light text-dark">@GetStudentActivitiesTotal() / 10</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">استقصاء + إرشاد</small>
                                    <span class="badge bg-light text-dark">8 / 10</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">السمات الشخصية</small>
                                    <span class="badge bg-light text-dark">@GetPersonalTraitsTotal() / 10</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Comments Section -->
                <div class="border rounded p-3 bg-light mb-3">
                    <h5 class="mb-3 text-primary">الملاحظات والتعليقات</h5>

                    <div class="mb-3">
                        <label class="form-label fw-bold">نقاط القوة</label>
                        <textarea class="form-control"
                                  rows="3"
                                  @bind="hodStrengths"
                                  disabled="@IsViewMode"
                                  placeholder="اذكر نقاط القوة لمساعد التدريس..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">نقاط الضعف</label>
                        <textarea class="form-control"
                                  rows="3"
                                  @bind="hodWeaknesses"
                                  disabled="@IsViewMode"
                                  placeholder="اذكر نقاط الضعف ومجالات التحسين..."></textarea>
                    </div>
                </div> 
            }
        </div>
            <div class="modal-footer">
                @if (IsViewMode)
                {
                    <button type="button" class="btn btn-secondary" @onclick="HandleClose">إغلاق</button>
                    <button class="btn btn-primary" @onclick="DownloadPdf">
                        Export As PDF
                    </button>
                    <button type="button"
                            class="btn btn-outline-primary px-4"
                            @onclick="PrintModal"
                            disabled="@isLoadingModal">
                        <i class="bi bi-printer me-2"></i>طباعة التقرير الكامل
                    </button>
                }
                else if (!isLoadingModal)
                {
                    <button type="button" class="btn btn-secondary" @onclick="HandleClose">إلغاء</button>

                    @if (!hasVpgsData||!hasGsdeanData)
                    {
                        <div class="alert alert-danger mb-0 me-2 d-inline-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>لا يمكن حفظ التقييم:</strong> يجب على نائب الرئيس  او وكيل الكبة للدراسات العليا إكمال التقييم أولاً 
                        </div>
                    }

                    <button type="button" class="btn btn-primary"
                            @onclick="HandleSave"
                            disabled="@(isSaving || !hasVpgsData||!hasGsdeanData)">
                        @if (!hasVpgsData||!hasGsdeanData)
                        {
                            <i class="bi bi-lock-fill me-2"></i>
                        }
                        @(isSaving ? "جارٍ الحفظ..." : "حفظ التقييم")
                    </button>

                    <button type="button" class="btn btn-warning"
                            @onclick="OpenReturnModal"
                            disabled="@(isSaving || !hasVpgsData||!hasGsdeanData)">
                        <i class="bi bi-arrow-return-right me-2"></i>إرجاع التقييم
                    </button>
                }
            </div>
     </div>
    </div>
</div>
<!-- Professor Selection Modal -->
@if (showProfessorModal)
{
    <div class="modal-overlay" style="z-index: 10000;" @onclick="CloseReturnModal">
        <div class="modal-container" style="max-width: 600px;" @onclick:stopPropagation="true">
            <div class="modal-header" dir="rtl">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-return-right me-2"></i>
                    اختر جهة الإرجاع
                </h5>
                <button type="button" class="btn-close btn-close-white ms-0 me-auto" @onclick="CloseReturnModal"></button>
            </div>

            <div class="modal-body" dir="rtl">
                <div class="mb-4">
                    <label class="form-label fw-bold">سبب الإرجاع</label>
                    <textarea class="form-control"
                              rows="3"
                              @bind="HodReturnComment"
                              placeholder="اذكر سبب إرجاع التقييم..."></textarea>
                </div>

                <div class="d-grid gap-2">
                    <!-- Return to TA Button -->
                    <button type="button"
                            class="btn btn-outline-primary btn-lg text-start"
                            style="text-align: right !important;"
                            @onclick="() => ConfirmReturnToTA()"
                            disabled="@(string.IsNullOrWhiteSpace(HodReturnComment) || isSaving)">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-person me-2"></i>
                                <span>إرجاع إلى مساعد التدريس</span>
                                <div class="small text-muted">@SelectedTA?.employeeName</div>
                            </div>
                        </div>
                    </button>

                    <!-- Divider -->
                    <div class="text-center my-2">
                        <span class="text-muted">أو</span>
                    </div>

                    <!-- Return to Professor Section -->
                    <div class="border rounded p-3 bg-light">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-mortarboard me-2"></i>
                            إرجاع إلى أستاذ المقرر
                        </h6>

                        @if (profdto == null || !profdto.Any())
                        {
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                لا توجد تقييمات من أساتذة المقررات
                            </div>
                        }
                        else
                        {
                            <div class="list-group">
                                @foreach (var prof in profdto)
                                {
                                    <button type="button"
                                            class="list-group-item list-group-item-action @(selectedProfessorId == prof.ProfessorEmployeeId ? "active" : "")"
                                            style="text-align: right;"
                                            @onclick="() => SelectProfessor(prof.ProfessorEmployeeId)"
                                            disabled="@isSaving">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div style="text-align: right; flex: 1;">
                                                <div class="fw-bold">@prof.ProfessorName</div>
                                                <small>@prof.CourseName (@prof.CourseCode)</small>
                                            </div>
                                            <div>
                                                @if (prof.IsReturned)
                                                {
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="bi bi-arrow-return-right me-1"></i>
                                                        تم الإرجاع مسبقاً
                                                    </span>
                                                }
                                                else if (selectedProfessorId == prof.ProfessorEmployeeId)
                                                {
                                                    <i class="bi bi-check-circle-fill text-white"></i>
                                                }
                                            </div>
                                        </div>
                                    </button>
                                }
                            </div>

                            @if (selectedProfessorId > 0)
                            {
                                <button type="button"
                                        class="btn btn-primary w-100 mt-3"
                                        @onclick="ConfirmReturnToProfessor"
                                        disabled="@(string.IsNullOrWhiteSpace(HodReturnComment) || isSaving)">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-send me-2"></i>
                                    @(isSaving ? "جارٍ الإرجاع..." : "تأكيد الإرجاع إلى الأستاذ المحدد")
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        @onclick="CloseReturnModal"
                        disabled="@isSaving">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
}
@if (showProfessorsReminderModal)
{
    <div class="modal-overlay" style="z-index: 10000;" @onclick="CloseProfessorsReminderModal">
        <div class="modal-container" style="max-width: 600px;" @onclick:stopPropagation="true">
            <div class="modal-header" dir="rtl">
                <h5 class="modal-title">
                    <i class="bi bi-bell me-2"></i>
                    الأساتذة الذين لم يقدموا تقييماتهم
                </h5>
                <button type="button" class="btn-close btn-close-white ms-0 me-auto" @onclick="CloseProfessorsReminderModal"></button>
            </div>

            <div class="modal-body" dir="rtl">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    يمكنك إرسال تذكير لهؤلاء الأساتذة لتقديم تقييماتهم
                </div>

                @if (professorsNeedingReminder.Any())
                {
                    <div class="list-group mb-3">
                        @foreach (var prof in professorsNeedingReminder)
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">@prof.ProfessorName</h6>
                                        <small class="text-muted">@prof.CourseName</small>
                                        <br />
                                        <small class="text-muted">
                                            <strong>رمز المقرر:</strong> @prof.CourseCode
                                        </small>
                                    </div>
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-clock me-1"></i>
                                        لم يُقدم
                                    </span>
                                </div>
                            </div>
                        }
                    </div>

                    <button type="button"
                            class="btn btn-warning w-100"
                            @onclick="SendRemindersToAllProfessors"
                            disabled="@isSendingReminders">
                        @if (isSendingReminders)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>جارٍ الإرسال...</span>
                        }
                        else
                        {
                            <i class="bi bi-send me-2"></i>
                            <span>إرسال تذكير للجميع (@professorsNeedingReminder.Count)</span>
                        }
                    </button>
                }
                else
                {
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        جميع الأساتذة قدموا تقييماتهم
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        @onclick="CloseProfessorsReminderModal"
                        disabled="@isSendingReminders">
                    إغلاق
                </button>
            </div>
        </div>
    </div>
}
@code {
    [Parameter] public UserDataDto? SelectedTA { get; set; }
    [Parameter] public int EvaluationPeriodId { get; set; }
    [Parameter] public bool IsViewMode { get; set; } = false;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaveSuccess { get; set; }
    [Parameter] public bool IsDeanUser { get; set; } = false;
    [Parameter] public int DeanEmployeeId { get; set; } = 0;
    private bool hasGsdeanData = true;
    private decimal scientificTotal = 0;
    private int statusid = 0;
    private bool hasVpgsData = true;
    private bool isLoadingModal = true;
    private bool isGeneratingPdf = false;
    private string HodReturnComment = "";
    private bool isSaving = false;
    private TeachingDataDto teachingdto = new TeachingDataDto();
    private List<ProfessorEvaluationResponseDto> profdto = new List<ProfessorEvaluationResponseDto>();
    private HodEvaluationResponseDto? hodEvaluationData;
    double TotalTeachingLoad => (CalculateAverageScore()) + (teachingLoadGrade(teachingdto.ActualTeachingLoad,teachingdto.ExpectedTeachingLoad));
    // Ratings dictionaries
    private Dictionary<int, int> teachingActivitiesRatings = new();
    private Dictionary<int, int> scientificActivityRatings = new();
    private Dictionary<int, int> personalTraitsRatings = new();
    private Dictionary<int, int> studentActivitiesRatings = new();

    private bool modal = false;
    private bool showProfessorModal = false;
    private int selectedProfessorId = 0;
    private string hodStrengths = string.Empty;
    private string hodWeaknesses = string.Empty;
    private string DeanComments = string.Empty;
    private IJSObjectReference? pdfModule;
    private UserDataDto? fullEmployeeInfo;
    private List<ProfessorReminderInfo> professorsNeedingReminder = new();
    private bool showProfessorsReminderModal = false;
    private bool isSendingReminders = false;
    // Computed properties - العبء التدريسي = Professor evaluations (30) + Teaching load completion (10) + Teaching Activities (10)
    decimal teachingLoadScore => (CalculateAverageScore()) + teachingLoadGrade(teachingdto.ActualTeachingLoad,teachingdto.ExpectedTeachingLoad) + GetTeachingActivitiesTotal();
    private List<TeachingDataDto> semesterTeachingLoads = new List<TeachingDataDto>();
    private void OnGsdeabDataAvailabilityChanged(bool gshasData)
    {
        hasGsdeanData = gshasData;
        Console.WriteLine($" GS Dean data availability changed: {gshasData}");
    }
    private void OnVpgsDataAvailabilityChanged(bool hasData)
    {
        hasVpgsData = hasData;
        Console.WriteLine($" VPGS data availability changed: {hasData}");
        StateHasChanged();
    }
    private decimal AverageTeachingLoadGrade()
    {
        if (!semesterTeachingLoads.Any())
            return 0;

        return semesterTeachingLoads.Average(s => s.score);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (SelectedTA != null)
        {
            await LoadData();
        }
    }
    private async Task LoadProfessorsNeedingReminder()
    {
        try
        {
            professorsNeedingReminder.Clear();

            // Extract all unique professors from teaching data (semesterTeachingLoads)
            var allProfessors = semesterTeachingLoads
                .SelectMany(semester => semester.courses ?? new List<CourseDto>())
                .Where(course => !string.IsNullOrEmpty(course.courseProfessorId))
                .Select(course => new
                {
                    ProfessorId = int.Parse(course.courseProfessorId.Trim()),
                    ProfessorName = course.courseProfessorName?.Trim(),
                    CourseCode = course.courseCode?.Trim(),
                    CourseName = course.courseName?.Trim()
                })
                .DistinctBy(p => p.ProfessorId)
                .ToList();

            Console.WriteLine($"✅ Found {allProfessors.Count} total professors from teaching data");

            // Get professors who already submitted (from profdto)
            // ⚠️ KEY FIX: Handle case when profdto is null or empty
            var submittedProfessorIds = (profdto ?? new List<ProfessorEvaluationResponseDto>())
                .Where(p => p.IsSubmitted)
                .Select(p => p.ProfessorEmployeeId)
                .Distinct()
                .ToList();

            Console.WriteLine($"✅ Found {submittedProfessorIds.Count} professors who submitted");

            // Find professors who haven't submitted
            professorsNeedingReminder = allProfessors
                .Where(prof => !submittedProfessorIds.Contains(prof.ProfessorId))
                .Select(prof => new ProfessorReminderInfo
                {
                    ProfessorId = prof.ProfessorId,
                    ProfessorName = prof.ProfessorName,
                    CourseCode = prof.CourseCode,
                    CourseName = prof.CourseName
                })
                .ToList();

            Console.WriteLine($"✅ Found {professorsNeedingReminder.Count} professors needing reminder");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading professors needing reminder: {ex.Message}");
        }
    }
    private void ShowProfessorsReminderModal()
    {
        showProfessorsReminderModal = true;
    }

    private void CloseProfessorsReminderModal()
    {
        showProfessorsReminderModal = false;
    }

    private async Task SendRemindersToAllProfessors()
    {
        if (!professorsNeedingReminder.Any())
            return;

        isSendingReminders = true;
        try
        {
            // Send notification to each professor
            foreach (var prof in professorsNeedingReminder)
            {
                var notificationDto = new SendNotificationDto
                {
                    recipientId = prof.ProfessorId,
                    message = $"تذكير: يرجى تقديم تقييمك لمساعد التدريس {SelectedTA.employeeName}. الموعد النهائي قريب."
                };

                var response = await Http.PostAsJsonAsync("api/Notification/send", notificationDto);

                if (!response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"❌ Failed to send reminder to professor {prof.ProfessorId}");
                }
            }

            await JS.InvokeVoidAsync("alert", $"تم إرسال التذكير إلى {professorsNeedingReminder.Count} أستاذ بنجاح");
            CloseProfessorsReminderModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error sending reminders: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ: {ex.Message}");
        }
        finally
        {
            isSendingReminders = false;
        }
    }
    private async Task LoadData()
    {
        isLoadingModal = true;
        Console.WriteLine($"🔵 Starting LoadData - SelectedTA: {SelectedTA?.employeeName}");

        // Reset data
        profdto = new List<ProfessorEvaluationResponseDto>();
        hodEvaluationData = null;
        semesterTeachingLoads.Clear();
        teachingActivitiesRatings.Clear();
        scientificActivityRatings.Clear();
        personalTraitsRatings.Clear();
        studentActivitiesRatings.Clear();
        hodStrengths = string.Empty;
        hodWeaknesses = string.Empty;
        hasVpgsData = true;
        try
        {
            if (SelectedTA == null || SelectedTA.EvaluationId == 0 || EvaluationPeriodId == 0)
            {
                await JS.InvokeVoidAsync("alert", "خطأ: بيانات التقييم غير متوفرة");
                isLoadingModal = false;
                return;
            }

            // Load employee info
            try
            {
                var response = await Http.GetAsync($"api/evaluation/info/{SelectedTA.employeeId}");
                if (response.IsSuccessStatusCode)
                {
                    fullEmployeeInfo = await response.Content.ReadFromJsonAsync<UserDataDto>();
                    if (fullEmployeeInfo != null)
                    {
                        SelectedTA.employeeName = fullEmployeeInfo.employeeName;
                        SelectedTA.Department = fullEmployeeInfo.Department ?? SelectedTA.Department;
                        SelectedTA.college = fullEmployeeInfo.college ?? SelectedTA.college;
                        SelectedTA.jobTitle = fullEmployeeInfo.jobTitle;
                        Console.WriteLine($"✅ Employee info updated");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error loading employee info: {ex.Message}");
            }

            // Load teaching data
            try
            {
                Console.WriteLine($"📡 Fetching teaching data");
                var response = await Http.GetAsync(
                    $"api/evaluation/teachingdata/{SelectedTA.employeeId}?startDate=2025-01-01&endDate=2025-12-31");

                if (response.IsSuccessStatusCode)
                {
                    semesterTeachingLoads = await response.Content.ReadFromJsonAsync<List<TeachingDataDto>>()
                        ?? new List<TeachingDataDto>();
                    Console.WriteLine($"Loaded {semesterTeachingLoads.Count} semesters");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($" Error loading teaching data: {ex.Message}");
            }

            // Load professor evaluations
            try
            {
                var profEvaluations = await Http.GetFromJsonAsync<List<ProfessorEvaluationResponseDto>>(
                    $"api/ProfessorEvaluation/GetByPeriodAndTA/{EvaluationPeriodId}/{SelectedTA.employeeId}");

                if (profEvaluations != null && profEvaluations.Any())
                {
                    profdto = profEvaluations;
                    Console.WriteLine($"✅ Loaded {profdto.Count} professor evaluations");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($" Error loading professor evaluations: {ex.Message}");
            }

            // Load HOD evaluation
            try
            {
                var response = await Http.GetAsync($"api/HodEvaluation/HodEvaluationByEvaluationId/{SelectedTA.EvaluationId}");
                if (response.IsSuccessStatusCode)
                {
                    hodEvaluationData = await response.Content.ReadFromJsonAsync<HodEvaluationResponseDto>();
                    if (hodEvaluationData != null && hodEvaluationData.Evaluations?.Any() == true)
                    {
                        hodStrengths = hodEvaluationData.HodStrengths ?? string.Empty;
                        hodWeaknesses = hodEvaluationData.HodWeaknesses ?? string.Empty;
                        DeanComments = hodEvaluationData.DeanReturnComments ?? string.Empty;
                        statusid = hodEvaluationData.StatusId;
                
                        
                        foreach (var eval in hodEvaluationData.Evaluations)
                        {
                            if (eval.CriterionType == "DirectTeaching")
                                teachingActivitiesRatings[eval.CriterionId] = eval.RatingId;
                            else if (eval.CriterionType == "Scientific")
                                scientificActivityRatings[eval.CriterionId] = eval.RatingId;
                            else if (eval.CriterionType == "Administrative" || eval.CriterionType == "AdministrativeTotal")
                                scientificActivityRatings[eval.CriterionId] = eval.RatingId;
                            else if (eval.CriterionType == "StudentActivities")
                                studentActivitiesRatings[eval.CriterionId] = eval.RatingId;
                            else if (eval.CriterionType == "PersonalTraits")
                                personalTraitsRatings[eval.CriterionId] = eval.RatingId;
                        }
                        Console.WriteLine($"✅ Loaded HOD evaluation");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error loading HOD evaluation: {ex.Message}");
            }

            if (SelectedTA != null && semesterTeachingLoads.Any())
            {
                await LoadProfessorsNeedingReminder();
            }

            Console.WriteLine("✅ LoadData completed successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Critical error in LoadData: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ: {ex.Message}");
        }
        finally
        {
            isLoadingModal = false;
            StateHasChanged();
        }
    }
    private Dictionary<int, string> GetCriterionSources(string criterionType)
    {
        if (hodEvaluationData?.Evaluations == null)
            return new Dictionary<int, string>();

        return hodEvaluationData.Evaluations
            .Where(e => e.CriterionType == criterionType)
            .ToDictionary(e => e.CriterionId, e => e.SourceRole ?? "HOD");
    }
    private Dictionary<int, int> GetAdministrativeRatings()
    {
        if (hodEvaluationData?.Evaluations == null)
            return new Dictionary<int, int>();

        // Include BOTH "Administrative" (6-11) AND "AdministrativeTotal" (20)
        return hodEvaluationData.Evaluations
            .Where(e => e.CriterionType == "Administrative" || e.CriterionType == "AdministrativeTotal")
            .ToDictionary(e => e.CriterionId, e => e.RatingId);
    }
    private void OnTeachingActivitiesRatingsChanged((Dictionary<int, int> Ratings, decimal Total) data)
    {
        // Merge new ratings with existing ones
        foreach (var rating in data.Ratings)
        {
            teachingActivitiesRatings[rating.Key] = rating.Value;
        }
        StateHasChanged();
    }

    private void OnScientificActivityRatingsChanged(Dictionary<int, int> ratings)
    {
        // Merge new ratings with existing ones
        foreach (var rating in ratings)
        {
            scientificActivityRatings[rating.Key] = rating.Value;
        }
        StateHasChanged();
    }

    private void OnPersonalTraitsRatingsChanged(Dictionary<int, int> ratings)
    {
        // Merge new ratings with existing ones
        foreach (var rating in ratings)
        {
            personalTraitsRatings[rating.Key] = rating.Value;
        }
        StateHasChanged();
    }

    private void OnStudentActivitiesRatingsChanged(Dictionary<int, int> ratings)
    {
        // Merge new ratings with existing ones
        foreach (var rating in ratings)
        {
            studentActivitiesRatings[rating.Key] = rating.Value;
        }
        StateHasChanged();
    }

    private Dictionary<int, int> GetExistingRatings(string criterionType)
    {
        if (hodEvaluationData?.Evaluations == null)
            return new Dictionary<int, int>();

        return hodEvaluationData.Evaluations
            .Where(e => e.CriterionType == criterionType)
            .ToDictionary(e => e.CriterionId, e => e.RatingId);
    }

    private int CalculateAverageScore()
    {
        if (profdto == null || !profdto.Any())
            return 0;

        var average = profdto.Average(e => e.TotalScore);
        return (int)Math.Round(average);
    }

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }
    private void OpenReturnModal()
    {
        showProfessorModal = true;
        HodReturnComment = string.Empty;
        selectedProfessorId = 0;
    }

    private void CloseReturnModal()
    {
        showProfessorModal = false;
        HodReturnComment = string.Empty;
        selectedProfessorId = 0;
    }

    private void SelectProfessor(int professorId)
    {
        selectedProfessorId = professorId;
    }

    private async Task ConfirmReturnToTA()
    {
        if (string.IsNullOrWhiteSpace(HodReturnComment))
        {
            await JS.InvokeVoidAsync("alert", "الرجاء إدخال سبب الإرجاع");
            return;
        }

        await RejectToTA();
        CloseReturnModal();
    }
    private async Task RejectToTA()
    {
        if (SelectedTA == null) return;
        isSaving = true;
        try
        {
            ReturnEvaluationHODDto returnDto = new ReturnEvaluationHODDto
            {
                EvaluationId = SelectedTA.EvaluationId,
                Comments = HodReturnComment
            };
            var response = await Http.PostAsJsonAsync(
                "/api/HodEvaluation/ReturnToTA",
                returnDto);
            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "تم إرجاع التقييم إلى مساعد التدريس بنجاح");
                await LoadData(); // ✅ Reload data after save
                await OnSaveSuccess.InvokeAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Reject failed: {error}");
                await JS.InvokeVoidAsync("alert", $"فشل إرجاع التقييم: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error rejecting evaluation: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ أثناء الإرجاع: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
    private async Task RejectToProfessor()
    {
        if (SelectedTA == null) return;

        isSaving = true;
        try
        {
            ReturnToProfessor returnprof = new ReturnToProfessor
            {
                evaluationId=SelectedTA.EvaluationId,
                EvaluationPeriodId = EvaluationPeriodId,
                ProfessorId = selectedProfessorId, 
                TAId = SelectedTA.employeeId,
                HodComments = HodReturnComment ,
                TaName = SelectedTA.employeeName
            };

            var response = await Http.PostAsJsonAsync(
                "api/HodEvaluation/ReturnToProfessor",
                returnprof);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "تم إرجاع التقييم إلى أستاذ المقرر بنجاح");
                await LoadData();
                await OnSaveSuccess.InvokeAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Reject failed: {error}");
                await JS.InvokeVoidAsync("alert", $"فشل إرجاع التقييم: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error rejecting evaluation: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ أثناء الإرجاع: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
    private async Task ConfirmReturnToProfessor()
    {
        if (selectedProfessorId == 0)
        {
            await JS.InvokeVoidAsync("alert", "الرجاء اختيار أستاذ المقرر");
            return;
        }

        if (string.IsNullOrWhiteSpace(HodReturnComment))
        {
            await JS.InvokeVoidAsync("alert", "الرجاء إدخال سبب الإرجاع");
            return;
        }

        await RejectToProfessor();
        CloseReturnModal();
    }
    private async Task HandleSave()
    {
        if (SelectedTA == null) return;

        isSaving = true;

        try
        {
            var allRatings = new Dictionary<int, int>();

            foreach (var rating in teachingActivitiesRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in scientificActivityRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in personalTraitsRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in studentActivitiesRatings)
                allRatings[rating.Key] = rating.Value;

            if (allRatings.Count == 0)
            {
                await JS.InvokeVoidAsync("alert", "الرجاء تقييم المعايير المطلوبة");
                return;
            }

            var criterionRatings = allRatings.Select(kvp => new CriterionRatingDto
            {
                CriterionId = kvp.Key,
                RatingId = kvp.Value
            }).ToList();

            bool evaluationExists = hodEvaluationData?.EvaluationId > 0;

            Console.WriteLine($"🔍 Evaluation exists: {evaluationExists}, IsDeanUser: {IsDeanUser}");

            if (IsDeanUser)
            {
                var updateDeanDto = new UpdateDeanEvaluationDto
                {
                    EvaluationId = SelectedTA.EvaluationId,
                    
                    CriterionRatings = criterionRatings,
                    TotalScore = CalculateFinalTotal(),
                    DeanComments = hodWeaknesses, 
                    CreatedByUserId = DeanEmployeeId,
                   
                };

                Console.WriteLine($"📤 Dean updating evaluation {SelectedTA.EvaluationId} with {criterionRatings.Count} ratings");

                var response = await Http.PutAsJsonAsync(
                    "/api/Dean/updateEvaluationCriteria",
                    updateDeanDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم تحديث التقييم من قبل العميد بنجاح");
                    await LoadData();
                    await OnSaveSuccess.InvokeAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"❌ Dean update failed: {error}");
                    await JS.InvokeVoidAsync("alert", $"فشل تحديث التقييم: {error}");
                }
            }
            else if (evaluationExists)
            {
                var updateDto = new UpdateHodEvaluationDto
                {
                    CriterionRatings = criterionRatings,
                    HodStrengths = hodStrengths,
                    HodWeaknesses = hodWeaknesses,
                    FinalScore = CalculateFinalTotal()
                };

                Console.WriteLine($"📤 HOD updating evaluation {SelectedTA.EvaluationId} with {criterionRatings.Count} ratings");

                var response = await Http.PutAsJsonAsync(
                    $"api/HodEvaluation/UpdateHodEvaluation/{SelectedTA.EvaluationId}",
                    updateDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم تحديث التقييم بنجاح");
                    await LoadData();
                    await OnSaveSuccess.InvokeAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"❌ Update failed: {error}");
                    await JS.InvokeVoidAsync("alert", $"فشل تحديث التقييم: {error}");
                }
            }
            else
            {
                var createDto = new CreateHodEvaluationDto
                {
                    EvaluationId = SelectedTA.EvaluationId,
                    CriterionRatings = criterionRatings,
                    HodStrengths = hodStrengths,
                    HodWeaknesses = hodWeaknesses,
                    FinalScore = CalculateFinalTotal(),
                    TeachingLoadScore = (int)AverageTeachingLoadGrade()
                };

                Console.WriteLine($"📤 Creating new evaluation for {SelectedTA.EvaluationId} with {criterionRatings.Count} ratings");

                var response = await Http.PostAsJsonAsync("api/HodEvaluation/create", createDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم حفظ التقييم بنجاح");
                    await LoadData();
                    await OnSaveSuccess.InvokeAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"❌ Create failed: {error}");
                    await JS.InvokeVoidAsync("alert", $"فشل حفظ التقييم: {error}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error saving evaluation: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ أثناء الحفظ: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
    private int teachingLoadGrade(int actualteaching,int expectedteaching)
    {
        if(actualteaching>=expectedteaching)
        {
            return 10;
        }
        else
        {
            return 0;
        }
    }
    private async Task PrintModal()
    {
        Console.WriteLine("🔵 Printing entire modal");
        await JS.InvokeVoidAsync("window.print");
    }
    private decimal CalculateFinalTotal()
    {
        // Total = 50 (teaching load) + 10 (scientific) + 10 (administrative) + 10 (student activities) + 10 (survey+guidance) + 10 (personal traits) = 100
        return teachingLoadScore +  // 50 points
               GetScientificTotal() +                // 10 points
               GetAdministrativeTotal() +            // 10 points
               GetStudentActivitiesTotal() +         // 10 points
               4 +                                   // استقصاء الطلاب (4/5)
               4 +                                   // الإرشاد الأكاديمي (4/5)
               GetPersonalTraitsTotal();             // 10 points
    }
    private void OnScientificTotalReceived(decimal total)
    {
        scientificTotal = total;
        StateHasChanged();
    }

    private decimal GetScientificTotal()
    {
        return scientificTotal;
    }

    private int GetAdministrativeTotal()
    {
        // النشاط الإداري = المشاركة في اللجان (criterion 20)
        if (scientificActivityRatings.ContainsKey(20))
        {
        int ratingId = scientificActivityRatings[20];
            // Convert RatingId (16-26) to score (0-10)
   return ratingId >= 16 && ratingId <= 26 ? ratingId - 16 : 0;
    }
        return 0;
    }

    private decimal GetStudentActivitiesTotal()
    {
        // الأنشطة الطلابية = sum of criteria 12, 13, 14
        // RatingId 6-10 maps to points: 0, 1, 2, 3, 3.33
        decimal total = 0;
    foreach (var kvp in studentActivitiesRatings)
        {
            int ratingId = kvp.Value;
      // Convert RatingId (6-10) to ScoreValue (0-4)
            int scoreValue = ratingId >= 6 && ratingId <= 10 ? ratingId - 6 : 0;
            
     // Map ScoreValue to points
            total += scoreValue switch
            {
                  0 => 0m,
            1 => 1m,
             2 => 2m,
               3 => 3m,
            4 => 3.33m,
             _ => 0m
           };
        }
        return total;
    }

    private decimal GetPersonalTraitsTotal()
    {
        // السمات الشخصية = sum of criteria 15, 16, 17, 18, 19
        // RatingId 11-15 maps to points: 0, 0.5, 1, 1.5, 2
      decimal total = 0;
        foreach (var kvp in personalTraitsRatings)
        {
            int ratingId = kvp.Value;
          // Convert RatingId (11-15) to ScoreValue (0-4)
         int scoreValue = ratingId >= 11 && ratingId <= 15 ? ratingId - 11 : 0;
            
        // Map ScoreValue to points (each is worth 0.5)
    total += scoreValue * 0.5m;
      }
  return total;
    }

private decimal GetTeachingActivitiesTotal()
    {
   // الأنشطة التعليمية = sum of criteria 1-5
      // RatingId 1-5 maps to points: 0, 0.5, 1, 1.5, 2
        decimal total = 0;
        foreach (var kvp in teachingActivitiesRatings)
        {
            int ratingId = kvp.Value;
     // Convert RatingId (1-5) to ScoreValue (0-4)
 int scoreValue = ratingId >= 1 && ratingId <= 5 ? ratingId - 1 : 0;
            
            // Map ScoreValue to points (each is worth 0.5)
      total += scoreValue * 0.5m;
     }
        return total;
  }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            pdfModule = await JS.InvokeAsync<IJSObjectReference>("import", "/JavaScript.js");
        }
    }

    private async Task DownloadPdf()
    {
        try
        {
            isGeneratingPdf = true;
            StateHasChanged();
            await pdfModule.InvokeVoidAsync("saveElementAsPdf", "pdfArea", "evaluation-report.pdf");
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }
}