@using Shared.Dtos.HODEvaluation
@using Shared.Dtos.ProfessorEvaluationDto
@inject HttpClient Http
@inject IJSRuntime JS

<div class="modal-container modal-container-xl">
<div class="modal-overlay" @onclick="HandleClose">
    <div class="modal-container modal-container-xl" @onclick:stopPropagation="true">
        <div class="modal-header" dir="rtl">
            <h5 class="modal-title">تفاصيل مساعد التدريس</h5>
            <button type="button" class="btn-close btn-close-white ms-0 me-auto" @onclick="HandleClose"></button>
        </div>
        <div class="modal-body" id="pdfArea">
            @if (isLoadingModal)
            {
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جارٍ التحميل...</span>
                    </div>
                    <p class="mt-2">جارٍ تحميل البيانات...</p>
                </div>
            }
            else
            {
                <div class="border rounded p-3 bg-light mb-3">

                    <h5 class="mb-3 text-primary">البيانات الأساسية</h5>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">اسم مساعد التدريس</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.Name" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">الرقم الوظيفي:</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.EmployeeNumber" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">القسم</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.Department" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">القسم</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.College" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">الكلية</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.College" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">العبئ الدراسي</label>
                            <input type="text" class="form-control" disabled value="@SelectedTA?.EmployeeNumber" />
                        </div>
                    </div>
                </div>
                    @if (statusid == 7)
                    {
                        <div class="alert alert-danger" role="alert">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>سبب رفض الاعتماد
                                </label>
                                <div class="form-control bg-light" readonly style="min-height: 60px;">
                                    @DeanComments
                                </div>
                                <input type="hidden" value="@(DeanComments)" />
                            </div>
                        </div>
                    }
                <!-- Professor Evaluations -->
                <div class="border rounded p-3 bg-light mb-3">
                    <h5 class="mb-3 text-primary">تقييم النشاط العلمي</h5>
                    <div class="border rounded p-3 bg-light mb-3">
                        <h5 class="mb-3 text-primary">
                            <i class="bi bi-person-check-fill me-2"></i>
                            تقييمات أساتذة المقررات
                        </h5>

                        @if (profdto == null || !profdto.Any())
                        {
                            <div class="alert alert-warning text-center" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                لا توجد تقييمات من أساتذة المقررات حتى الآن
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover align-middle">
                                    <thead class="table-secondary">
                                        <tr>
                                            <th class="text-center">المقرر</th>
                                            <th class="text-center">أستاذ المقرر</th>
                                            <th class="text-center">الفصل الدراسي</th>
                                            <th class="text-center">الساعات المكتبية</th>
                                            <th class="text-center">الحضور</th>
                                            <th class="text-center">الأداء</th>
                                            <th class="text-center">المجموع</th>
                                            <th class="text-center">الحالة</th>
                                            <th class="text-center">الملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var eval in profdto)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="fw-bold">@eval.CourseName</div>
                                                    <small class="text-muted">@eval.CourseCode</small>
                                                </td>
                                                <td>@eval.ProfessorName</td>
                                                <td class="text-center">
                                                    <span class="badge bg-info">@eval.SemesterName</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-info">@eval.OfficeHoursScore / 10</span>
                                                </td>

                                                <td class="text-center">
                                                    <span class="badge bg-info">@eval.AttendanceScore / 5</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-info">@eval.PerformanceScore / 15</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary fs-6">@eval.TotalScore / 30</span>
                                                </td>
                                                <td class="text-center">
                                                    @if (eval.IsReturned)
                                                    {
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="bi bi-arrow-return-right me-1"></i> تم الإرجاع
                                                        </span>
                                                    }
                                                    else if (eval.IsSubmitted)
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle me-1"></i> مقدم
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">
                                                            <i class="bi bi-clock me-1"></i> قيد الانتظار
                                                        </span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    @eval.Comments
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <th colspan="5" class="text-end">المتوسط الإجمالي:</th>
                                            <th class="text-center">
                                                <span class="badge bg-success fs-5">@CalculateAverageScore() / 30</span>
                                            </th>
                                            <th colspan="2"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <div class="mt-3 p-3 bg-light rounded shadow-sm">
                                <h6 class="fw-bold mb-3 text-primary">
                                    <i class="bi bi-book-half me-1"></i>اكتمال ساعات النصاب (10)
                                </h6>

                                <div class="row text-center">
                                    <div class="col">
                                        <div class="p-2 bg-white rounded border">
                                            <i class="bi bi-clock-history fs-4 d-block text-secondary"></i>
                                            <span class="fw-bold">التدريس المتوقع</span>
                                            <div>@teachingdto.ExpectedTeachingLoad</div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="p-2 bg-white rounded border">
                                            <i class="bi bi-check-circle fs-4 d-block text-success"></i>
                                            <span class="fw-bold">التدريس الفعلي</span>
                                            <div>@teachingdto.ActualTeachingLoad</div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="p-2 bg-white rounded border">
                                            <i class="bi bi-star-fill fs-4 d-block text-warning"></i>
                                            <span class="fw-bold">التقييم</span>
                                            <div>@(teachingdto.gradegiven)/10</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card bg-primary bg-opacity-10 shadow-sm mx-auto mt-4" style="max-width: 600px; border-radius: 12px;">
                                <div class="card-body text-center py-4">
                                    <h3 class="text-primary fw-semibold mb-2" style="direction: rtl; font-size: 18px;">المجموع الكلي للعبء التدريسي</h3>
                                    <p class="text-primary fw-bold fs-4 mb-0" style="direction: ltr;">@(y) / 40</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Child Components -->
                <Srs.Client.Compontets.TeachingActivitiesEvaluation TeachingLoadScore="@y"
                                                                    OnRatingsChanged="OnTeachingActivitiesRatingsChanged"
                                                                    IsViewMode="@IsViewMode"
                                                                    ExistingRatings="@GetExistingRatings("DirectTeaching")" />

                <Srs.Client.Compontets.ScientificActivityComponentForHod EvaluationId="@(SelectedTA?.EvaluationId ?? 0)"
                                                                         EvaluationPeriodId="EvaluationPeriodId"
                                                                         TaEmployeeId="SelectedTA.Id"
                                                                         OnRatingsChanged="OnScientificActivityRatingsChanged"
                                                                         OnScientificTotalChanged="OnScientificTotalReceived"
                                                                         IsViewMode="@IsViewMode"
                                                                         ExistingRatings="@GetAdministrativeRatings()" />

                <Srs.Client.Compontets.GradesComponent OnPersonalTraitsChanged="OnPersonalTraitsRatingsChanged"
                                                       OnStudentActivitiesChanged="OnStudentActivitiesRatingsChanged"
                                                       IsViewMode="@IsViewMode"
                                                       ExistingPersonalTraits="@GetExistingRatings("PersonalTraits")"
                                                       ExistingStudentActivities="@GetExistingRatings("StudentActivities")" />

                <div class="card bg-success bg-opacity-10 shadow-lg mx-auto mt-4 mb-4" style="max-width: 900px;">
                    <div class="card-body text-center py-5">
                        <h4 class="text-success fw-bold mb-3">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            المجموع الكلي النهائي
                        </h4>
                        <div class="row justify-content-center">
                            <div class="col-auto">
                                <div class="bg-white rounded-3 p-4 shadow-sm">
                                    <p class="text-success fw-bold fs-1 mb-0" style="direction: ltr;">
                                        @CalculateFinalTotal() / 100
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- تفصيل الدرجات -->
                        <div class="mt-4">
                            <div class="row text-center g-3">
                                <div class="col-md-2">
                                    <small class="text-muted d-block">العبء التدريسي</small>
                                    <span class="badge bg-light text-dark">@(teachingLoadScore) / 50</span>
                                    <div class="mt-1" style="font-size: 0.7rem;">
                                        <small class="text-muted d-block">تقييم الأساتذة: @CalculateAverageScore()</small>
                                        <small class="text-muted d-block">اكتمال النصاب: @(teachingdto.gradegiven ?? 0)</small>
                                        <small class="text-muted d-block">الأنشطة التعليمية: @GetTeachingActivitiesTotal()</small>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">النشاط العلمي</small>
                                    <span class="badge bg-light text-dark">@GetScientificTotal() / 10</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">النشاط الإداري</small>
                                    <span class="badge bg-light text-dark">@GetAdministrativeTotal() / 10</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">الأنشطة الطلابية</small>
                                    <span class="badge bg-light text-dark">@GetStudentActivitiesTotal() / 10</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">استقصاء + إرشاد</small>
                                    <span class="badge bg-light text-dark">8 / 10</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-block">السمات الشخصية</small>
                                    <span class="badge bg-light text-dark">@GetPersonalTraitsTotal() / 10</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Comments Section -->
                <div class="border rounded p-3 bg-light mb-3">
                    <h5 class="mb-3 text-primary">الملاحظات والتعليقات</h5>

                    <div class="mb-3">
                        <label class="form-label fw-bold">نقاط القوة</label>
                        <textarea class="form-control"
                                  rows="3"
                                  @bind="hodStrengths"
                                  disabled="@IsViewMode"
                                  placeholder="اذكر نقاط القوة لمساعد التدريس..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">نقاط الضعف</label>
                        <textarea class="form-control"
                                  rows="3"
                                  @bind="hodWeaknesses"
                                  disabled="@IsViewMode"
                                  placeholder="اذكر نقاط الضعف ومجالات التحسين..."></textarea>
                    </div>
                </div> 
            }
        </div>
        <div class="modal-footer">
            @if (IsViewMode)
            {
                <button type="button" class="btn btn-secondary" @onclick="HandleClose">إغلاق</button>
                    <button class="btn btn-primary" @onclick="DownloadPdf">
                        Export As PDF
                    </button>

                    //here i want to add the print button 
                <button type="button"
                        class="btn btn-outline-primary px-4"
                        @onclick="PrintModal"
                        disabled="@isLoadingModal">
                    <i class="bi bi-printer me-2"></i>طباعة التقرير الكامل
                </button>

            }
            else if (!isLoadingModal)
            {
                <button type="button" class="btn btn-secondary" @onclick="HandleClose">إلغاء</button>
                <button type="button" class="btn btn-primary"
                        @onclick="HandleSave"
                        disabled="@isSaving">
                    @(isSaving ? "جارٍ الحفظ..." : "حفظ التقييم")
                </button>
                    <button type="button" class="btn btn-warning"
                            @onclick="OpenReturnModal"
                            disabled="@isSaving">
                        <i class="bi bi-arrow-return-right me-2"></i>إرجاع التقييم
                    </button>
            }
          </div>
     </div>
    </div>
</div>
<!-- Professor Selection Modal -->
@if (showProfessorModal)
{
    <div class="modal-overlay" style="z-index: 10000;" @onclick="CloseReturnModal">
        <div class="modal-container" style="max-width: 600px;" @onclick:stopPropagation="true">
            <div class="modal-header" dir="rtl">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-return-right me-2"></i>
                    اختر جهة الإرجاع
                </h5>
                <button type="button" class="btn-close btn-close-white ms-0 me-auto" @onclick="CloseReturnModal"></button>
            </div>

            <div class="modal-body" dir="rtl">
                <div class="mb-4">
                    <label class="form-label fw-bold">سبب الإرجاع</label>
                    <textarea class="form-control"
                              rows="3"
                              @bind="HodReturnComment"
                              placeholder="اذكر سبب إرجاع التقييم..."></textarea>
                </div>

                <div class="d-grid gap-2">
                    <!-- Return to TA Button -->
                    <button type="button"
                            class="btn btn-outline-primary btn-lg text-start"
                            style="text-align: right !important;"
                            @onclick="() => ConfirmReturnToTA()"
                            disabled="@(string.IsNullOrWhiteSpace(HodReturnComment) || isSaving)">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-person me-2"></i>
                                <span>إرجاع إلى مساعد التدريس</span>
                                <div class="small text-muted">@SelectedTA?.Name</div>
                            </div>
                        </div>
                    </button>

                    <!-- Divider -->
                    <div class="text-center my-2">
                        <span class="text-muted">أو</span>
                    </div>

                    <!-- Return to Professor Section -->
                    <div class="border rounded p-3 bg-light">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-mortarboard me-2"></i>
                            إرجاع إلى أستاذ المقرر
                        </h6>

                        @if (profdto == null || !profdto.Any())
                        {
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                لا توجد تقييمات من أساتذة المقررات
                            </div>
                        }
                        else
                        {
                            <div class="list-group">
                                @foreach (var prof in profdto)
                                {
                                    <button type="button"
                                            class="list-group-item list-group-item-action @(selectedProfessorId == prof.ProfessorEmployeeId ? "active" : "")"
                                            style="text-align: right;"
                                            @onclick="() => SelectProfessor(prof.ProfessorEmployeeId)"
                                            disabled="@isSaving">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div style="text-align: right; flex: 1;">
                                                <div class="fw-bold">@prof.ProfessorName</div>
                                                <small>@prof.CourseName (@prof.CourseCode)</small>
                                            </div>
                                            <div>
                                                @if (prof.IsReturned)
                                                {
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="bi bi-arrow-return-right me-1"></i>
                                                        تم الإرجاع مسبقاً
                                                    </span>
                                                }
                                                else if (selectedProfessorId == prof.ProfessorEmployeeId)
                                                {
                                                    <i class="bi bi-check-circle-fill text-white"></i>
                                                }
                                            </div>
                                        </div>
                                    </button>
                                }
                            </div>

                            @if (selectedProfessorId > 0)
                            {
                                <button type="button"
                                        class="btn btn-primary w-100 mt-3"
                                        @onclick="ConfirmReturnToProfessor"
                                        disabled="@(string.IsNullOrWhiteSpace(HodReturnComment) || isSaving)">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-send me-2"></i>
                                    @(isSaving ? "جارٍ الإرجاع..." : "تأكيد الإرجاع إلى الأستاذ المحدد")
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        @onclick="CloseReturnModal"
                        disabled="@isSaving">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
}
@code {
    // Parameters passed from parent component
    [Parameter] public UserDataDto? SelectedTA { get; set; }
    [Parameter] public int EvaluationPeriodId { get; set; }
    [Parameter] public bool IsViewMode { get; set; } = false;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaveSuccess { get; set; }
    private decimal scientificTotal = 0;
    private int statusid = 0;
    // Internal state
    private bool isLoadingModal = true;
    private bool isGeneratingPdf = false;
    private string HodReturnComment = "";
    private bool isSaving = false;
    private TeachingDataDto teachingdto = new TeachingDataDto();
    private List<ProfessorEvaluationResponseDto> profdto = new List<ProfessorEvaluationResponseDto>();
    private HodEvaluationResponseDto? hodEvaluationData;
    double y => (CalculateAverageScore()) + (teachingdto.gradegiven ?? 0);
    // Ratings dictionaries
    private Dictionary<int, int> teachingActivitiesRatings = new();
    private Dictionary<int, int> scientificActivityRatings = new();
    private Dictionary<int, int> personalTraitsRatings = new();
    private Dictionary<int, int> studentActivitiesRatings = new();

    private bool modal = false;
    private bool showProfessorModal = false;
    private int selectedProfessorId = 0;
    // Comments
    private string hodStrengths = string.Empty;
    private string hodWeaknesses = string.Empty;
    private string DeanComments = string.Empty;
    private IJSObjectReference? pdfModule;

    // Computed properties - العبء التدريسي = Professor evaluations (30) + Teaching load completion (10) + Teaching Activities (10)
    decimal teachingLoadScore => (CalculateAverageScore()) + (teachingdto.gradegiven ?? 0) + GetTeachingActivitiesTotal();

    protected override async Task OnParametersSetAsync()
    {
        if (SelectedTA != null)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        isLoadingModal = true;
        Console.WriteLine($"🔵 Starting LoadData - SelectedTA: {SelectedTA?.Name}, EvaluationId: {SelectedTA?.EvaluationId}, PeriodId: {EvaluationPeriodId}");

        // Reset data
        profdto = new List<ProfessorEvaluationResponseDto>();
        hodEvaluationData = null;
        teachingActivitiesRatings.Clear();
        scientificActivityRatings.Clear();
        personalTraitsRatings.Clear();
        studentActivitiesRatings.Clear();
        hodStrengths = string.Empty;
        hodWeaknesses = string.Empty;

        try
        {
            // Validate that we have the required data
            if (SelectedTA == null)
            {
                Console.WriteLine("❌ SelectedTA is null");
                await JS.InvokeVoidAsync("alert", "خطأ: بيانات المستخدم غير متوفرة");
                isLoadingModal = false;
                return;
            }

            if (SelectedTA.EvaluationId == 0)
            {
                Console.WriteLine("❌ EvaluationId is 0");
                await JS.InvokeVoidAsync("alert", "خطأ: معرف التقييم غير متوفر");
                isLoadingModal = false;
                return;
            }

            if (EvaluationPeriodId == 0)
            {
                Console.WriteLine("❌ EvaluationPeriodId is 0");
                await JS.InvokeVoidAsync("alert", "خطأ: معرف فترة التقييم غير متوفر");
                isLoadingModal = false;
                return;
            }

            // Load professor evaluations
            try
            {
                Console.WriteLine($"📡 Fetching professor evaluations: /api/ProfessorEvaluation/GetByPeriodAndTA/{EvaluationPeriodId}/{SelectedTA.Id}");
                var profEvaluations = await Http.GetFromJsonAsync<List<ProfessorEvaluationResponseDto>>(
                    $"api/ProfessorEvaluation/GetByPeriodAndTA/{EvaluationPeriodId}/{SelectedTA.Id}");

                if (profEvaluations != null && profEvaluations.Any())
                {
                    profdto = profEvaluations;
                    Console.WriteLine($"✅ Loaded {profdto.Count} professor evaluations");
                }
                else
                {
                    Console.WriteLine("⚠️ No professor evaluations found");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error loading professor evaluations: {ex.Message}");
            }

            // Load teaching data
            if (SelectedTA.EvaluationId != 0)
            {
                teachingdto = new TeachingDataDto
                {
                    ActualTeachingLoad = 12,
                    ExpectedTeachingLoad = 10,
                    ClassCount = 3,
                    gradegiven = 8
                };
                Console.WriteLine("✅ Teaching data initialized");
            }

            // Try to load existing HOD evaluation
            try
            {
                Console.WriteLine($"📡 Fetching HOD evaluation: /api/HodEvaluation/HodEvaluationByEvaluationId/{SelectedTA.EvaluationId}");
                var response = await Http.GetAsync($"api/HodEvaluation/HodEvaluationByEvaluationId/{SelectedTA.EvaluationId}");

                Console.WriteLine($"📥 HOD evaluation response status: {response.StatusCode}");

                if (response.IsSuccessStatusCode)
                {
                    hodEvaluationData = await response.Content.ReadFromJsonAsync<HodEvaluationResponseDto>();

                    if (hodEvaluationData != null)
                    {
                        Console.WriteLine($"✅ HOD evaluation loaded - StatusId: {hodEvaluationData.StatusId}, Evaluations count: {hodEvaluationData.Evaluations?.Count ?? 0}");
                        
                        if (hodEvaluationData.Evaluations?.Any() == true)
                        {
                            hodStrengths = hodEvaluationData.HodStrengths ?? string.Empty;
                            hodWeaknesses = hodEvaluationData.HodWeaknesses ?? string.Empty;
                            DeanComments = hodEvaluationData.DeanReturnComments ?? string.Empty;
                            statusid = hodEvaluationData.StatusId;

                            // ✅ Populate ALL rating dictionaries with existing data
                            foreach (var eval in hodEvaluationData.Evaluations)
                            {
                                if (eval.CriterionType == "DirectTeaching")
                                {
                                    teachingActivitiesRatings[eval.CriterionId] = eval.RatingId;
                                }
                                else if (eval.CriterionType == "Scientific")
                                {
                                    scientificActivityRatings[eval.CriterionId] = eval.RatingId;
                                }
                                else if (eval.CriterionType == "Administrative" || eval.CriterionType == "AdministrativeTotal")
                                {
                                    scientificActivityRatings[eval.CriterionId] = eval.RatingId;
                                }
                                else if (eval.CriterionType == "StudentActivities")
                                {
                                    studentActivitiesRatings[eval.CriterionId] = eval.RatingId;
                                }
                                else if (eval.CriterionType == "PersonalTraits")
                                {
                                    personalTraitsRatings[eval.CriterionId] = eval.RatingId;
                                }
                            }

                            Console.WriteLine($"✅ Loaded ratings - Teaching: {teachingActivitiesRatings.Count}, Scientific: {scientificActivityRatings.Count}, Student: {studentActivitiesRatings.Count}, Personal: {personalTraitsRatings.Count}");
                        }
                        else
                        {
                            Console.WriteLine("⚠️ HOD evaluation exists but has no evaluations");
                        }
                    }
                    else
                    {
                        Console.WriteLine("⚠️ HOD evaluation response was null");
                    }
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"⚠️ HOD evaluation not found - Status: {response.StatusCode}, Content: {errorContent}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error loading HOD evaluation: {ex.Message}");
                Console.WriteLine($"Stack trace: {ex.StackTrace}");
            }

            Console.WriteLine("✅ LoadData completed successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Critical error in LoadData: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ: {ex.Message}");
        }
        finally
        {
            isLoadingModal = false;
            StateHasChanged();
            Console.WriteLine("🔵 LoadData finished, isLoadingModal = false");
        }
    }
    private Dictionary<int, int> GetAdministrativeRatings()
    {
        if (hodEvaluationData?.Evaluations == null)
            return new Dictionary<int, int>();

        // Include BOTH "Administrative" (6-11) AND "AdministrativeTotal" (20)
        return hodEvaluationData.Evaluations
            .Where(e => e.CriterionType == "Administrative" || e.CriterionType == "AdministrativeTotal")
            .ToDictionary(e => e.CriterionId, e => e.RatingId);
    }
    private void OnTeachingActivitiesRatingsChanged((Dictionary<int, int> Ratings, decimal Total) data)
    {
        // Merge new ratings with existing ones
        foreach (var rating in data.Ratings)
        {
            teachingActivitiesRatings[rating.Key] = rating.Value;
        }
        StateHasChanged();
    }

    private void OnScientificActivityRatingsChanged(Dictionary<int, int> ratings)
    {
        // Merge new ratings with existing ones
        foreach (var rating in ratings)
        {
            scientificActivityRatings[rating.Key] = rating.Value;
        }
        StateHasChanged();
    }

    private void OnPersonalTraitsRatingsChanged(Dictionary<int, int> ratings)
    {
        // Merge new ratings with existing ones
        foreach (var rating in ratings)
        {
            personalTraitsRatings[rating.Key] = rating.Value;
        }
        StateHasChanged();
    }

    private void OnStudentActivitiesRatingsChanged(Dictionary<int, int> ratings)
    {
        // Merge new ratings with existing ones
        foreach (var rating in ratings)
        {
            studentActivitiesRatings[rating.Key] = rating.Value;
        }
        StateHasChanged();
    }

    private Dictionary<int, int> GetExistingRatings(string criterionType)
    {
        if (hodEvaluationData?.Evaluations == null)
            return new Dictionary<int, int>();

        return hodEvaluationData.Evaluations
            .Where(e => e.CriterionType == criterionType)
            .ToDictionary(e => e.CriterionId, e => e.RatingId);
    }

    private int CalculateAverageScore()
    {
        if (profdto == null || !profdto.Any())
            return 0;

        var average = profdto.Average(e => e.TotalScore);
        return (int)Math.Round(average);
    }

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }
    private void OpenReturnModal()
    {
        showProfessorModal = true;
        HodReturnComment = string.Empty;
        selectedProfessorId = 0;
    }

    private void CloseReturnModal()
    {
        showProfessorModal = false;
        HodReturnComment = string.Empty;
        selectedProfessorId = 0;
    }

    private void SelectProfessor(int professorId)
    {
        selectedProfessorId = professorId;
    }

    private async Task ConfirmReturnToTA()
    {
        if (string.IsNullOrWhiteSpace(HodReturnComment))
        {
            await JS.InvokeVoidAsync("alert", "الرجاء إدخال سبب الإرجاع");
            return;
        }

        await RejectToTA();
        CloseReturnModal();
    }
    private async Task RejectToTA()
    {
        if (SelectedTA == null) return;
        isSaving = true;
        try
        {
            ReturnEvaluationHODDto returnDto = new ReturnEvaluationHODDto
            {
                EvaluationId = SelectedTA.EvaluationId,
                Comments = HodReturnComment
            };
            var response = await Http.PostAsJsonAsync(
                "/api/HodEvaluation/ReturnToTA",
                returnDto);
            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "تم إرجاع التقييم إلى مساعد التدريس بنجاح");
                await LoadData(); // ✅ Reload data after save
                await OnSaveSuccess.InvokeAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Reject failed: {error}");
                await JS.InvokeVoidAsync("alert", $"فشل إرجاع التقييم: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error rejecting evaluation: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ أثناء الإرجاع: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
    private async Task RejectToProfessor()
    {
        if (SelectedTA == null) return;

        isSaving = true;
        try
        {
            ReturnToProfessor returnprof = new ReturnToProfessor
            {
                evaluationId=SelectedTA.EvaluationId,
                EvaluationPeriodId = EvaluationPeriodId,
                ProfessorId = selectedProfessorId, // ✅ Use the selected professor
                TAId = SelectedTA.Id,
                HodComments = HodReturnComment ,// ✅ Add this property to your DTO if not exists
                TaName = SelectedTA.Name
            };

            var response = await Http.PostAsJsonAsync(
                "api/HodEvaluation/ReturnToProfessor",
                returnprof);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "تم إرجاع التقييم إلى أستاذ المقرر بنجاح");
                await LoadData();
                await OnSaveSuccess.InvokeAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"❌ Reject failed: {error}");
                await JS.InvokeVoidAsync("alert", $"فشل إرجاع التقييم: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error rejecting evaluation: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ أثناء الإرجاع: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
    private async Task ConfirmReturnToProfessor()
    {
        if (selectedProfessorId == 0)
        {
            await JS.InvokeVoidAsync("alert", "الرجاء اختيار أستاذ المقرر");
            return;
        }

        if (string.IsNullOrWhiteSpace(HodReturnComment))
        {
            await JS.InvokeVoidAsync("alert", "الرجاء إدخال سبب الإرجاع");
            return;
        }

        await RejectToProfessor();
        CloseReturnModal();
    }
    private async Task HandleSave()
    {
        if (SelectedTA == null) return;

        isSaving = true;

        try
        {
            // Combine all ratings from different sections
            var allRatings = new Dictionary<int, int>();

            foreach (var rating in teachingActivitiesRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in scientificActivityRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in personalTraitsRatings)
                allRatings[rating.Key] = rating.Value;

            foreach (var rating in studentActivitiesRatings)
                allRatings[rating.Key] = rating.Value;

            if (allRatings.Count == 0)
            {
                await JS.InvokeVoidAsync("alert", "الرجاء تقييم المعايير المطلوبة");
                return;
            }

            var criterionRatings = allRatings.Select(kvp => new CriterionRatingDto
            {
                CriterionId = kvp.Key,
                RatingId = kvp.Value
            }).ToList();

            // ✅ FIXED: Check if evaluation exists by checking hodEvaluationData.HodEvaluationId
            // An evaluation truly exists if it has an ID in the database
            bool evaluationExists = hodEvaluationData?.EvaluationId > 0;

            Console.WriteLine($"🔍 Evaluation exists: {evaluationExists}, HodEvaluationId: {hodEvaluationData?.EvaluationId}, StatusId: {statusid}");

            if (evaluationExists)
            {
                // ✅ Update existing evaluation
                var updateDto = new UpdateHodEvaluationDto
                {
                    CriterionRatings = criterionRatings,
                    HodStrengths = hodStrengths,
                    HodWeaknesses = hodWeaknesses
                };

                Console.WriteLine($"📤 Updating evaluation {SelectedTA.EvaluationId} with {criterionRatings.Count} ratings");

                var response = await Http.PutAsJsonAsync(
                    $"api/HodEvaluation/UpdateHodEvaluation/{SelectedTA.EvaluationId}",
                    updateDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم تحديث التقييم بنجاح");
                    await LoadData(); // ✅ Reload data after save
                    await OnSaveSuccess.InvokeAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"❌ Update failed: {error}");
                    await JS.InvokeVoidAsync("alert", $"فشل تحديث التقييم: {error}");
                }
            }
            else
            {
                // ✅ Create new evaluation
                var createDto = new CreateHodEvaluationDto
                {
                    EvaluationId = SelectedTA.EvaluationId,
                    CriterionRatings = criterionRatings,
                    HodStrengths = hodStrengths,
                    HodWeaknesses = hodWeaknesses
                };

                Console.WriteLine($"📤 Creating new evaluation for {SelectedTA.EvaluationId} with {criterionRatings.Count} ratings");

                var response = await Http.PostAsJsonAsync("api/HodEvaluation/create", createDto);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "تم حفظ التقييم بنجاح");
                    await LoadData(); // ✅ Reload data after save
                    await OnSaveSuccess.InvokeAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"❌ Create failed: {error}");
                    await JS.InvokeVoidAsync("alert", $"فشل حفظ التقييم: {error}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error saving evaluation: {ex}");
            await JS.InvokeVoidAsync("alert", $"حدث خطأ أثناء الحفظ: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
    private async Task PrintModal()
    {
        Console.WriteLine("🔵 Printing entire modal");
        await JS.InvokeVoidAsync("window.print");
    }
    private decimal CalculateFinalTotal()
    {
        // Total = 50 (teaching load) + 10 (scientific) + 10 (administrative) + 10 (student activities) + 10 (survey+guidance) + 10 (personal traits) = 100
        return teachingLoadScore +  // 50 points
               GetScientificTotal() +                // 10 points
               GetAdministrativeTotal() +            // 10 points
               GetStudentActivitiesTotal() +         // 10 points
               4 +                                   // استقصاء الطلاب (4/5)
               4 +                                   // الإرشاد الأكاديمي (4/5)
               GetPersonalTraitsTotal();             // 10 points
    }
    private void OnScientificTotalReceived(decimal total)
    {
        scientificTotal = total;
        StateHasChanged();
    }

    private decimal GetScientificTotal()
    {
        return scientificTotal;
    }

    private int GetAdministrativeTotal()
    {
        // النشاط الإداري = المشاركة في اللجان (criterion 20)
        if (scientificActivityRatings.ContainsKey(20))
        {
        int ratingId = scientificActivityRatings[20];
            // Convert RatingId (16-26) to score (0-10)
   return ratingId >= 16 && ratingId <= 26 ? ratingId - 16 : 0;
    }
        return 0;
    }

    private decimal GetStudentActivitiesTotal()
    {
        // الأنشطة الطلابية = sum of criteria 12, 13, 14
        // RatingId 6-10 maps to points: 0, 1, 2, 3, 3.33
        decimal total = 0;
    foreach (var kvp in studentActivitiesRatings)
        {
            int ratingId = kvp.Value;
      // Convert RatingId (6-10) to ScoreValue (0-4)
            int scoreValue = ratingId >= 6 && ratingId <= 10 ? ratingId - 6 : 0;
            
     // Map ScoreValue to points
            total += scoreValue switch
            {
                  0 => 0m,
            1 => 1m,
             2 => 2m,
               3 => 3m,
            4 => 3.33m,
             _ => 0m
           };
        }
        return total;
    }

    private decimal GetPersonalTraitsTotal()
    {
        // السمات الشخصية = sum of criteria 15, 16, 17, 18, 19
        // RatingId 11-15 maps to points: 0, 0.5, 1, 1.5, 2
      decimal total = 0;
        foreach (var kvp in personalTraitsRatings)
        {
            int ratingId = kvp.Value;
          // Convert RatingId (11-15) to ScoreValue (0-4)
         int scoreValue = ratingId >= 11 && ratingId <= 15 ? ratingId - 11 : 0;
            
        // Map ScoreValue to points (each is worth 0.5)
    total += scoreValue * 0.5m;
      }
  return total;
    }

private decimal GetTeachingActivitiesTotal()
    {
   // الأنشطة التعليمية = sum of criteria 1-5
      // RatingId 1-5 maps to points: 0, 0.5, 1, 1.5, 2
        decimal total = 0;
        foreach (var kvp in teachingActivitiesRatings)
        {
            int ratingId = kvp.Value;
     // Convert RatingId (1-5) to ScoreValue (0-4)
 int scoreValue = ratingId >= 1 && ratingId <= 5 ? ratingId - 1 : 0;
            
            // Map ScoreValue to points (each is worth 0.5)
      total += scoreValue * 0.5m;
     }
        return total;
  }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            pdfModule = await JS.InvokeAsync<IJSObjectReference>("import", "/JavaScript.js");
        }
    }

    private async Task DownloadPdf()
    {
        try
        {
            isGeneratingPdf = true;
            StateHasChanged();

            // Now generate PDF
            await pdfModule.InvokeVoidAsync("saveElementAsPdf", "pdfArea", "evaluation-report.pdf");
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }
}
