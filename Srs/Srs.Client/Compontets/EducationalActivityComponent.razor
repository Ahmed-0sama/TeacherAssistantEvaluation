@using Shared.Dtos
@inject HttpClient Http

<div class="row" dir="rtl">
    @if (isLoading)
    {
        <div class="col-12">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3">جاري تحميل البيانات</p>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="col-12">
            <div class="alert alert-danger">@errorMessage</div>
            <button class="btn btn-primary" @onclick="LoadActivityData">إعادة المحاولة</button>
        </div>
    }
    else if (semesters != null && semesters.Any())
    {
        @foreach (var semester in semesters)
        {
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h3 style="color:cornflowerblue">النشاط التعليمي - @semester.semestername</h3>
                        <hr style="color:cornflowerblue" />

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label class="form-label">الساعات التدريسية الفعلية</label>
                                <input class="form-control" value="@semester.ActualTeachingLoad" readonly />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">الساعات التدريسية المتوقعة</label>
                                <input class="form-control" value="@semester.ExpectedTeachingLoad" readonly />
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">عدد المقررات: @semester.courses.Count</label>
                        </div>

                        <div class="table-responsive mt-3">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>رمز المقرر</th>
                                        <th>اسم المقرر</th>
                                        <th>الساعات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var course in semester.courses)
                                    {
                                        <tr>
                                            <td>@course.courseCode.Trim()</td>
                                            <td>@course.courseName.Trim()</td>
                                            <td>@course.teachingHours </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-12">
            <div class="alert alert-info">لا توجد بيانات متاحة</div>
        </div>
    }
</div>
@code{
    private bool isLoading = false;
    private string? errorMessage;
    private List<TeachingDataDto>? semesters;

    [Parameter] public int employeeid { get; set; }  
    [Parameter] public int evaluationPeriod { get; set; }
    
    [Parameter] public EventCallback<EducationalActivityDto> OnActivityLoaded { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadActivityData();
    }

    private async Task LoadActivityData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var response = await Http.GetAsync(
                $"https://corsproxy.io/?https://aastmtic.aast.edu/TAEvaluation_api/api/LMS/teaching-data/{employeeid}/2025-1-1/2025-12-31");

            if (response.IsSuccessStatusCode)
            {
                semesters = await response.Content.ReadFromJsonAsync<List<TeachingDataDto>>();

                if (semesters == null || !semesters.Any())
                {
                    errorMessage = "لا توجد بيانات متاحة";
                }
                else
                {
                    semesters = semesters.OrderBy(s => s.semestercode).ToList();
                    Console.WriteLine($"Loaded {semesters.Count} semesters successfully");
                    
                    // ✅ ADD THIS: Send data back to parent
                    await NotifyParent();
                }
            }
            else
            {
                errorMessage = $"خطأ في الخادم: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"فشل تحميل البيانات: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task NotifyParent()
    {
        if (semesters != null && semesters.Any())
        {
            // Get the first (or latest) semester data
            var latestSemester = semesters.OrderByDescending(s => s.semestercode).First();
            
            var educationalData = new EducationalActivityDto
            {
                TeachingData = latestSemester
            };
            
            await OnActivityLoaded.InvokeAsync(educationalData);
            Console.WriteLine("✅ Educational data sent to parent");
        }
    }
}